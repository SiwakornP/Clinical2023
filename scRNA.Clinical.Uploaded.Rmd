---
title: "scBOC CD45"
author: "Siwakorn"
date: '2023-04-04'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Library
```{r}
library(Seurat)
library(tidyverse)
library(harmony)
library(scales)
library(pathfindR)
library(fgsea)
library(msigdbr)
library(biomaRt)
library(ggrepel)
library(ggthemes)
library(gtools)
library(DESeq2)
library("org.Mm.eg.db")
library(limma)
library(extrafont)
#font_import()
```


```{r}
#library(monocle3)
#library(UCell)
#library(hdf5r)
#library(GSVA)
#library(clusterProfiler)
#library(org.Hs.eg.db)
#library(org.Mm.eg.db)
```


```{r}
library(gggsea)
library(gridExtra)
```


#Style
```{r}
col_orange = c("grey","yellow","orange","red")
col_orange2 = c("grey","#fecd1a","#f9c80e","orange","red","firebrick3")
col_orange3 = c("grey85","#fecd1a","#FFB700","#FAA307","#F48C06","#E85D04","#DC2F02","#D00000")
col_orange4 = c("grey","#fecd1a","#FFB700","#FAA307","#F48C06","#E85D04")

col_ig = c("grey","#120078","#9d0191","#fd3a69","#fecd1a")
col_viridis <- c("grey",c(viridis::viridis(6))[1:5],"#fecd1a" )
col_viridis2 <- c(c(viridis::viridis(6))[1:5],"#fecd1a" )
col_pastel_rainbow = c("#01295f","#437f97","#849324","#ffb30f","#fd151b","firebrick")
col_BlueRed1 = c("#01295f","#1c51be","#52b893","#9c944c","#f5d62e","orange","#f86624","firebrick")
col_BlueRed2 = c("#01295f","#1c51be","#52b893","#f5d62e","#f86624","firebrick")
Col.HiLow.9Shades = c("#28198a","#163285","#3d569f","#8b99c2","#ffffff","#fce487","#f9c80e","#f86624","#ea3546")
Col.HiLow.7Shades = c("#28198a","#163285","#3d569f","#ffffff","#f9c80e","#f86624","#ea3546")
Col.HiLow.Up = c("#ffffff","#fce487","#f9c80e","#f86624")#,"#ea3546")
Col.HiLow.Down = c("#28198a","#163285","#3d569f","#8b99c2","#ffffff")
Col.BW = c("black","grey30","grey50","grey70","grey90")

#BOCDF = list()
BOCDF$cols = list()
BOCDF$cols$Celltype= c("#264653", "#287271","#2A9D8F","#8ab17d","#e76f51","#fcb900","#985c6f","#49488d","#693d8f"   )
BOCDF$cols$Celltype3 = c("#f57f26", "#d51f24","#252d6b","#1e8b40","#2480c2","#fcb900","#985c6f","#49488d","#882790","violet","orange")
BOCDF$cols$Celltype4 = c("#f57f26", "#d51f24","#252d6b","#1e8b40","#fcb900","#985c6f","#49488d","#882790","#BF535B")
BOCDF$cols$CD8.Subtype1 = c("#fcc304","#fb5b33","#c40424","#6a994e","#ef476f","#219ebc","#5e548e","#fe6d73","#00296b")
BOCDF$cols$TIM.Subtype1 = c("#4A080A","#a01313","#e09f3e","red")


scale_orange = scale_color_gradientn(colours = c("grey","yellow","orange","red"), values = c(0,0.1,0.5,1))
scale_ig = scale_color_gradientn(colours = c("grey","#120078","#9d0191","#fd3a69","#fecd1a"), values = c(0,0.1,0.3,0.6,1))
scale_ig2 = scale_color_gradientn(colours = c("#120078","#9d0191","#fd3a69","#fecd1a"))
scale_viridis = scale_color_gradientn(colours = col_viridis )
scale_PRainbow = scale_color_gradientn(colours = col_pastel_rainbow)
scale_BY = scale_color_gradientn(colours = c("grey","#01295f","#1c51be","#1893c4","#52b893","#9c944c","#e5cd3b","#fecd1a","orange"), values = c(0,0.05,0.1,0.3,0.4,0.5,0.6,0.8,1) )
scale_BY2 = scale_color_manual(values=  c("grey","#01295f","#1c51be","#1893c4","#52b893","#9c944c","#e5cd3b","#fecd1a","orange","#f86624","firebrick") )

Dot_axis90A = theme(axis.text.x =  element_text(size = 15, angle = 90, hjust = 1, vjust = 0.3,color = "black",face ="italic"), axis.text.y = element_text(size = 15,color = "black")) 
Dot_axis90B = theme(axis.text.x =  element_text(size = 15, angle = 90, hjust = 1, vjust = 0.3,color = "black"), axis.text.y = element_text(size = 15,color = "black")) 

Dot_scale = scale_size(range = c(1.5,8),name = "Percent Expression") 

FP_head = theme(plot.title = element_text(size = 20, face= "bold", colour = "firebrick") )
FP_head2 = theme(plot.title = element_text(size = 30, face= "bold", colour = "firebrick") )
```

```{r}
scale_size(range = c(0.1,1.5),name = "Percent expressed cells")+
scale_size_manual(values = seq(1,6,0.5))+

scale_fill_gradientn(values = scales::rescale(   c(  min(df1$avg_log2FC),-0.1,0,0.1,  max(df1$avg_log2FC)  ) ),
	                   colours = Col.HiLow.9Shades)
scale_fill_gradientn(values =  c( 0,0.43,0.5,0.57,  a ),
                     colours = Col.HiLow.7Shades,            
                     limits = c(-a,a) ) 
scale_fill_gradientn(values = scales::rescale(   c( -a,-0.1,0,0.1,  a ) ),
                     colours = Col.HiLow.9Shades,                                
                     limits = c(-a,a) ) +

a = max(abs(df1$avg_log2FC))+0.2 


                  theme(plot.title = element_blank(),
                        axis.title = element_blank(),
                        axis.text.x = element_text(size =5, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
                        axis.text.y = element_text(size =5, family = "Arial", color = "black"),
                        axis.line = element_line(colour = 'black', size = 0.25),
                        axis.ticks = element_line(colour = 'black', size = 0.15),
                        axis.ticks.length = unit(0.05,"cm"),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        strip.text.x.top = element_text(size =5, family = "Arial",colour = "black"),
                        strip.text = element_text(size =5, family = "Arial",colour = "black",
                                      margin = margin(t = 0.1, r = 0, b = 0.1, l = 0, unit = "cm") ),
                        legend.key.size = unit(0.1, 'in'),
                        legend.title = element_text(size = 5),
                        legend.text = element_text(size=4),
		                    plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
                        legend.position = "right")

geom_tile(color = "white",aes(fill =avg_log2FC)) +  
  scale_fill_gradientn(colours = Col.HiLow.9Shades, 
                       values = scales::rescale(c(min(df1$avg_log2FC),-0.1,0,0.1,max(df1$avg_log2FC)) ))

geom_point(aes(color = avg_log2FC, size = p_val_cat))+
   scale_size_manual(values = c(0.5,1,2,3)) + 
   scale_color_gradientn(values = rescale(   c( -a,-0.1,0,0.1,  a ) ) ,
                         colours = Col.HiLow.9Shades,
                         limits = c(-a,a) ) 

```



```{r}
#Color library
palettes <- ggthemes_data[["tableau"]][["color-palettes"]][["regular"]]
for (palname in names(palettes)) {
  pal <- tableau_color_pal(palname)
  max_n <- attr(pal, "max_n")
  show_col(pal(max_n))
  title(main = palname)
}

#Example
ggthemes_data$tableau$`color-palettes`$regular$`Classic Cyclic`
palettes$`Classic Cyclic`$value

#Expand palette
colorRampPalette(palettes$`Classic Cyclic`$value)(15)
```


#Instant command
```{r}
Clustering1 <- function(tmp,dim=30,res=0.3,spread =1, dist = 1,group = "ID" ){
      DefaultAssay(tmp) = "RNA"
      tmp <- NormalizeData(tmp) %>% FindVariableFeatures() %>% ScaleData() %>% RunPCA(verbose = FALSE)
      tmp <- RunHarmony(tmp, group.by.vars = group)
      tmp <- RunUMAP(tmp, reduction = "harmony", dims = 1:dim, min.dist = dist, spread = spread )
      tmp <- FindNeighbors(tmp, reduction = "harmony", dims = 1:dim) %>% FindClusters(resolution = res)
      return(tmp)
}

PTGER4.Group = function(Obj1, Identity = "Identity.Celltype", Batch = "Batch.scRNA"){
      df = data.frame()
      Cluster = unique(Obj1[[]][,Identity]) %>% as.character()
      Idents(Obj1) = Identity
      for(i in Cluster){
            Obj2 = subset(Obj1, idents = i)
            AllBatch = unique(as.character(Obj2[[]][,Batch] ))
            for(j in AllBatch ){
                  Idents(Obj2) = Batch
                  Obj3 = subset(Obj2, idents = j)
                  tmp = FetchData(Obj3, vars = "PTGER4",slot="data") %>% arrange(desc(PTGER4))
                  tmpA = filter(tmp,PTGER4 == 0)
                  tmp = filter(tmp,PTGER4 != 0)
                  if(nrow(tmpA) > 0 ) {
                        tmpA$PTGER4.Group = "Undetected"
                        } 
                  if(nrow(tmp) > 0 ) {
                        tmp$PTGER4.Group = "Low"
                        tmp$PTGER4.Group[1:round(nrow(tmp)/3)] = "High" 
                        tmp$PTGER4.Group[(round(nrow(tmp)/3)+1):(round(nrow(tmp)/3*2))] = "Intermediate"
                        }
                  tmp = rbind(tmp,tmpA)
                  if(nrow(tmp) > 0 ) {
                        tmp$Cluster = i
                        tmp$Batch = j
                        }
                  print(paste0(i," ",j, " ... ", (nrow(tmp) == ncol(Obj3)  ) ) )
                  df = rbind(df,as_tibble(tmp,rownames="CB"))
            }
      }
      print(paste0("Validation : ", nrow(df) == nrow(Obj1[[]]) ) )
      tmp2 = df$PTGER4.Group
      names(tmp2) = df$CB
      return(tmp2)
}

PTGER2.Group = function(Obj1, Identity = "Identity.Celltype", Batch = "Batch.scRNA"){
      df = data.frame()
      Cluster = unique(Obj1[[]][,Identity]) %>% as.character()
      Idents(Obj1) = Identity
      for(i in Cluster){
            Obj2 = subset(Obj1, idents = i)
            AllBatch = unique(as.character(Obj2[[]][,Batch] ))
            for(j in AllBatch ){
                  Idents(Obj2) = Batch
                  Obj3 = subset(Obj2, idents = j)
                  tmp = FetchData(Obj3, vars = "PTGER2",slot="data") %>% arrange(desc(PTGER2))
                  tmpA = filter(tmp,PTGER2 == 0)
                  tmp = filter(tmp,PTGER2 != 0)
                  if(nrow(tmpA) > 0 ) {
                        tmpA$PTGER2.Group = "Negative"
                        } 
                  if(nrow(tmp) > 0 ) {
                        tmp$PTGER2.Group = "Positive"
                        }
                  tmp = rbind(tmp,tmpA)
                  if(nrow(tmp) > 0 ) {
                        tmp$Cluster = i
                        tmp$Batch = j
                        }
                  print(paste0(i," ",j, " ... ", (nrow(tmp) == ncol(Obj3)  ) ) )
                  df = rbind(df,as_tibble(tmp,rownames="CB"))
            }
      }
      print(paste0("Validation : ", nrow(df) == nrow(Obj1[[]]) ) )
      tmp2 = df$PTGER2.Group
      names(tmp2) = df$CB
      return(tmp2)
}


FullDE <- function(Obj,Group = "PTGER4.Group.Celltype2", Batch = "ID",A = "High", B = "Low"){
      DE = list()
      Idents(Obj) = Batch
      for(i in unique(Obj[[]][,Batch]) ){
            tmp = subset(Obj, idents = i)
            print(paste0(i," : ", ncol(tmp), " Cells"))
            tryCatch({
                  Idents(tmp) = Group
                  DE[[i]] = FindMarkers(tmp,ident.1 = A, ident.2 = B, logfc.threshold = 0,min.pct =0.01 )
            }, error = function(e){print(e)})
      }
      #Sum table
      df = data.frame()
      for(i in names(DE) ){
            tmp = DE[[i]] %>% as_tibble(rownames = "Genes") %>% dplyr::select(Genes, avg_log2FC)
            tmp$Datasets = i
            df = rbind(df,tmp)
      }
      df = spread(df, Genes, avg_log2FC) %>% as.data.frame()
      rownames(df) = df$Datasets
      df = dplyr::select(df,-Datasets)
      df2 = matrix(nrow = ncol(df),ncol=0) %>% data.frame()
      rownames(df2) = colnames(df)
      df2$Upregulation = "NA"
      df2$Downregulation = "NA"
      for(i in colnames(df)){
            tmp = df[,i] > 0 
            df2[i,"Upregulation"] = sum(tmp)
            tmp = df[,i] < 0 
            df2[i,"Downregulation"] = sum(tmp)
      }
      df2$Upregulation = as.numeric(df2$Upregulation)
      df2$Downregulation = as.numeric(df2$Downregulation)
      DE[["FoldChange.Table"]] = df
      DE[["FoldChange.Sum"]] = df2
      return(DE)
}

RevIden <- function(x){
      factor(x, levels = rev(levels(x)))
}

find <- function(object,gene){
      rownames(object)[grep(gene,rownames(object) )] %>% mixedsort()
}
find2 <- function(Genes,SearchGenes){
      Genes[grep(SearchGenes,Genes )] %>% mixedsort()
}

GeneGroup <- function(df,GeneList ){
  tmp = data.frame(matrix(ncol = (ncol(df)+1), nrow = 0))
  colnames(tmp) = c(colnames(df),"Set")
  for(i in names(GeneList)){
      tmp1 = filter(df, Genes %in% GeneList[[i]] ) %>% filter(!Genes %in% tmp[,"Genes"])
      tmp1$Set = i
      tmp = rbind(tmp,tmp1)
  }
  tmp$Set = factor(tmp$Set, levels = names(GeneList))
  tmp$Genes = factor(tmp$Genes, levels = unique(unlist(GeneList)) )
  return(tmp)
}

pCat = function(df, pval.use = "p_val_adj"){
  df$pval_cat = ">0.05"
  df$pval_cat[(df[,pval.use] < 0.05)] = "<0.05"
  df$pval_cat[(df[,pval.use] < 0.01)] = "<0.01"
  df$pval_cat[(df[,pval.use] < 0.001)] = "<0.001"
  df$pval_cat = factor(df$pval_cat, levels = c(">0.05","<0.05","<0.01","<0.001"))
  return(df)
}

dir = "~/RStudioProject/scRNA/Fig/230831_Manuscript_V1"
dir = "~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/Fig/230831_Manuscript_V1"
dir.create(dir)
PNG <- function(x,w = 6, h = 6.3, r =400){
      png(filename = paste0(dir,"/",x,".png" ),
          width = w, 
          height = h, 
          units = "in", 
          res = r)
}
TIF <- function(x,w = 6, h = 6.3, r =400){
      tiff(filename = paste0(dir,"/",x,".tiff" ),
          width = w, 
          height = h, 
          units = "in", 
          res = r)
}
PDF <- function(x,w = 6, h = 6.3,r=400){
      pdf(file = paste0(dir,"/",x,".pdf" ),
          width = w, 
          height = h)
}

```

#Cross reference Human-Mouse
##Mouse-Human Cross-ref
```{r}
mouse_human_genes = read.csv("http://www.informatics.jax.org/downloads/reports/HOM_MouseHumanSequence.rpt",sep="\t")
MGenes = filter(mouse_human_genes, Common.Organism.Name == "mouse, laboratory")$Symbol
HGenes = filter(mouse_human_genes, Common.Organism.Name == "human") %>% arrange(Symbol)
#write.csv(mouse_human_genes, file ="//home/siwakorn/GO_term/mouse_human_genes.230112.csv")
saveRDS(mouse_human_genes, file ="~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/Ref/mouse_human_genes.230828.rds")
```
###Jax
```{r}
output = data.frame(matrix(ncol=2,nrow=0))
colnames(output) = c("Mouse_gene","Human_gene")
tmp1 = filter(mouse_human_genes,Common.Organism.Name == "mouse, laboratory")
tmp1 = unique(tmp1$Symbol) %>% sort()
for(gene in tmp1){
  class_key = (mouse_human_genes %>% filter(Symbol == gene & Common.Organism.Name=="mouse, laboratory"))[['DB.Class.Key']]
    if(!identical(class_key, integer(0)) ){
      human_genes = (mouse_human_genes %>% filter(DB.Class.Key == class_key & Common.Organism.Name=="human"))[,"Symbol"]
      for(human_gene in human_genes){
        output[gene,] = c(gene,human_gene)
      }
    }
  }
refM2H = output

output = data.frame(matrix(ncol=2,nrow=0))
colnames(output) = c("Human_gene","Mouse_gene")
tmp1 = filter(mouse_human_genes,Common.Organism.Name == "human")
tmp1 = unique(tmp1$Symbol) %>% sort()
for(gene in tmp1){
  class_key = (mouse_human_genes %>% filter(Symbol == gene & Common.Organism.Name=="human"))[['DB.Class.Key']]
    if(!identical(class_key, integer(0)) ){
      
      mouse_genes = (mouse_human_genes %>% filter(DB.Class.Key == class_key & Common.Organism.Name=="mouse, laboratory"))[,"Symbol"]
      for(mouse_gene in mouse_genes){
        output[gene,] = c(gene,mouse_gene)
      }
    }
  }
refH2M = output
#ref = list(refM2H,refH2M)
#saveRDS(ref, file = "//home/siwakorn/GO_term/Ref_Mouse-Human.221213.rds")
ref = readRDS(file = "//home/siwakorn/GO_term/Ref_Mouse-Human.221213.rds")
ref <- readRDS("~/RStudioProject/scRNA/Ref_Mouse-Human.221213.rds")
names(ref) = c("M2H","H2M")

```

##biomart
```{r}
library(org.Hs.eg.db)
library(org.Mm.eg.db)
library(biomaRt)
hmart = useMart("ensembl", dataset = "hsapiens_gene_ensembl")
hmart <- getBM(filters = "hgnc_symbol", 
                attributes = c("ensembl_gene_id", "description","hgnc_symbol"),
                values = rownames(BOC), mart = hmart) 
ref$hmart = hmart
mmart = useMart("ensembl", dataset = "mmusculus_gene_ensembl")
mmart <- getBM(filters = "mgi_symbol", 
                attributes = c("ensembl_gene_id", "description","external_gene_name","mgi_symbol"),
                values = rownames(LLC), mart = mmart) 
ref$mmart = mmart
#ensembl = useMart(biomart = "ENSEMBL_MART_ENSEMBL", dataset="mmusculus_gene_ensembl", host = "https://www.ensembl.org") #Alternative mart
saveRDS(ref,"~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/Ref/Ref_Mouse-Human.230828.rds")
```

#Gene
##PathfindR
```{r}
GSETS_C2 <- get_gene_sets_list(source = "MSigDB",
                                 species = "Homo sapiens",
                                 collection = "C2")
GSETS_C5 <- get_gene_sets_list(source = "MSigDB",
                                 species = "Homo sapiens",
                                 collection = "C5")
GSETS_H <- get_gene_sets_list(source = "MSigDB",
                                 species = "Homo sapiens",
                                 collection = "H")

GSETS_C7 <- get_gene_sets_list(source = "MSigDB",
                                 species = "Homo sapiens",
                                 collection = "C7")

GSETS_C2$gene_set$M9904 #KEGG_TCR
GSETS_C5$gene_set$M17829 #GO Fatty acid metabolism
GSETS_C5$gene_set$M16307 #Phagocytosis
GSETS_C2$gene_sets$M7963
GSETS_C2$gene_sets$M39387 #Wnt downregulated in Tpex
GSETS_C5$gene_sets$M19047
```



##msigDb
###Human
```{r}
fgsea_sets_H  <- msigdbr(species = "human", category = "H" ) %>% split(x = .$gene_symbol, f = .$gs_name)
fgsea_sets_c2 <- msigdbr(species = "human", category = "C2" ) %>% split(x = .$gene_symbol, f = .$gs_name)
fgsea_sets_c5 <- msigdbr(species = "human", category = "C5" ) %>% split(x = .$gene_symbol, f = .$gs_name)
fgsea_sets = append(fgsea_sets_H, fgsea_sets_c2)

names(fgsea_sets_c2)[grep("hif1",names(fgsea_sets_c2), ignore.case = T)]
names(fgsea_sets_c5)[grep("stat5",names(fgsea_sets_c5), ignore.case = T)]
PathwayList = list()
selected.pathway = c("HALLMARK_IL2_STAT5_SIGNALING","HALLMARK_PI3K_AKT_MTOR_SIGNALING" ,"HALLMARK_MTORC1_SIGNALING",
                     "HALLMARK_OXIDATIVE_PHOSPHORYLATION","HALLMARK_MYC_TARGETS_V1","HALLMARK_MYC_TARGETS_V2" )
for(i in selected.pathway){
  PathwayList[[i]] = fgsea_sets_H[[i]]
}
selected.pathway = c("PID_IL2_STAT5_PATHWAY","REACTOME_STAT5_ACTIVATION"," PID_IL2_1PATHWAY",
   "REACTOME_PI3K_AKT_ACTIVATION","PID_PI3KCI_AKT_PATHWAY","PID_PI3K_PLC_TRK_PATHWAY" , "WP_PI3KAKT_SIGNALING_PATHWAY",
  "BIOCARTA_MTOR_PATHWAY","KEGG_MTOR_SIGNALING_PATHWAY","REACTOME_MTOR_SIGNALLING" ,"REACTOME_MTORC1_MEDIATED_SIGNALLING","PID_MTOR_4PATHWAY",
  "PID_HIF1A_PATHWAY","SEMENZA_HIF1_TARGETS","PID_HIF1_TFPATHWAY")
for(i in selected.pathway){
  PathwayList[[paste0("C2_",i)]] = fgsea_sets_c2[[i]]
}

```

###Mouse
```{r}
mfgsea_sets_H  <- msigdbr(species = "mouse", category = "H" ) %>% split(x = .$gene_symbol, f = .$gs_name)
mfgsea_sets_c2 <- msigdbr(species = "mouse", category = "C2" ) %>% split(x = .$gene_symbol, f = .$gs_name)
mfgsea_sets_c5 <- msigdbr(species = "mouse", category = "C5" ) %>% split(x = .$gene_symbol, f = .$gs_name)
mfgsea_sets = append(mfgsea_sets_H, mfgsea_sets_c2)
mfgsea_sets_c2 = NULL
names(mfgsea_sets_c2)[grep("IL2",names(fgsea_sets_c2), ignore.case = T)]
names(fgsea_sets_c5)[grep("stat5",names(fgsea_sets_c5), ignore.case = T)]
mPathwayList = list()
selected.pathway = c("HALLMARK_IL2_STAT5_SIGNALING","HALLMARK_PI3K_AKT_MTOR_SIGNALING" ,"HALLMARK_MTORC1_SIGNALING",
                     "HALLMARK_OXIDATIVE_PHOSPHORYLATION","HALLMARK_MYC_TARGETS_V1","HALLMARK_MYC_TARGETS_V2" )
for(i in selected.pathway){
  mPathwayList[[i]] = mfgsea_sets_H[[i]]
}

selected.pathway = c("PID_IL2_STAT5_PATHWAY","REACTOME_STAT5_ACTIVATION"," PID_IL2_1PATHWAY",
   "REACTOME_PI3K_AKT_ACTIVATION","PID_PI3KCI_AKT_PATHWAY","PID_PI3K_PLC_TRK_PATHWAY" , "WP_PI3KAKT_SIGNALING_PATHWAY",
  "BIOCARTA_MTOR_PATHWAY","KEGG_MTOR_SIGNALING_PATHWAY","REACTOME_MTOR_SIGNALLING" ,"REACTOME_MTORC1_MEDIATED_SIGNALLING","PID_MTOR_4PATHWAY",
  "PID_HIF1A_PATHWAY","SEMENZA_HIF1_TARGETS","PID_HIF1_TFPATHWAY")
for(i in selected.pathway){
  mPathwayList[[paste0("C2_",i)]] = mfgsea_sets_c2[[i]]
}

```

##GeneSet
```{r}
#ref = readRDS(file = "//home/siwakorn/GO_term/Ref_Mouse-Human.221213.rds")
ref <- readRDS("Ref_Mouse-Human.221213.rds")
names(ref) = c("M2H","H2M")


GeneSet = list()
GeneSet$Markers.Lineage = c("PTPRC","CD3D","CSF1R","CSF3R","MS4A1","CD19","IGLC1","MKI67","COL6A2","KRT18","PECAM1","HDC")
GeneSet$Markers.TNK = c("CD3E","CD4","CD8A","TRDC","NCR1","KLRD1","KLRC1","NCAM1","FOXP3","MKI67","IGKC","ISG15","CSF3R","percent.mt","nFeature_RNA","nCount_RNA")
GeneSet$Markers.Myeliod = c("CSF1R","CSF3R","ADGRE1",
                            "C1QA","C1QB","AXL","MERTK","MRC1","PTGS2","PTGER2","VCAN","IL1B","PTGS1","PTGER4","VEGFA",
                            "SPP1","ISG15","IFIT1","MKI67",
                            "HLA-DRA","HLA-DRB1","HLA-DMA","HLA-DPA1","HLA-DPB1",
                            "CLEC9A","XCR1","LAMP3","CCR7","CD274","TNFSF9","TNFSF18",
                            "CD1C","CD1E","CD1A","HLA-DQA1","HLA-DQA2","HLA-DQB2","CD207","FCER1A",
                            "LILRA4","IRF7","IRF8","CLEC4C",
                            "IGKC","IGLC3","MALAT1","MT-CO1")
GeneSet$Markers.CD8 = c("CD8A","CD44","CD69","TCF7","SELL","IL7R","BACH2","LEF1", "KLRB1","LTB",
                        "GZMK","NFATC2","GZMH",
                        "GZMB","GNLY","KLRD1","PRF1","RORA","KLF3","IKZF2","KLRC2",
                        "IFNG","HSPA1B","BAG3","XCL1", 
                        "ISG15","IFIT1",
                        "TNFRSF4","TNFRSF18",
                        "HAVCR2","LAG3","PDCD1","ITGAE","ENTPD1","ID3",
                        "PTGER4")

GeneSet$PGE2 = c("PTGS1","PTGS2","PTGES","PTGES2","PTGES3","PTGER1","PTGER2","PTGER3","PTGER4")
GeneSet$PGE2B = c("PTGS1","PTGS2","PTGER1","PTGER2","PTGER3","PTGER4")

```

###GeneSet$DE
```{r}
GeneSet$DE = list()
GeneSet$DE$LLC = c("IL1B","IL1A","HIF1A","PTGS1","PTGS2","VEGFA")

GeneSet$DE$Common <- c("FOS","FOSB","FOSL2","JUN","JUNB","JUND","ATF3","EGR1","ETS1","NR3C1","ATF7IP","ACTB","ACTG1","ACTR2","CCL3","CCL4","CCL3L1","CCL4L2","CCL5","CXCL13","CXCR4","XCL1","XCL2","HMGA1","HMGB1","HMGB2","HMGN1","HMGN3","NR4A1","NR4A2","NR4A3","NFKBIZ","NFKB1","PSMA1","PSMA2","PSMA3","PSMA4","PSMA5","PSMA6","PSMA7","PSMB1","PSMB2","PSMB3","PSMB4","PSMB5","PSMB6","PSMB7","PSMB8","PSMB9","PSMC1","PSMC2","PSMC3", "PSMD7","PSMD8","PSMD9","PSME1","PSME2","PSME3" )


GeneSet$DE$NFKB = c(rownames(BOC)[grep("^NFK",rownames(BOC))], 
                                    rownames(BOC)[grep("^NR4",rownames(BOC))],
                                    "REL","RELA","RELB","BCL2","BCL3")

GeneSet$DE$AP1.Manual = c(rownames(BOC)[grep("^FOS",rownames(BOC))],rownames(BOC)[grep("^JUN",rownames(BOC))],rownames(BOC)[grep("^ATF",rownames(BOC))])


GeneSet$DE$MTC5 = c(rownames(BOC)[grep("^ATP",rownames(BOC))] ) %>% sort()
GeneSet$DE$MTC1 = c(rownames(BOC)[grep("^NDU",rownames(BOC))] ) %>% sort()
GeneSet$DE$MTC23 = c(rownames(BOC)[grep("^SDH",rownames(BOC))] ,rownames(BOC)[grep("^UQC",rownames(BOC))] ) %>% sort()
GeneSet$DE$MTC4 = c(rownames(BOC)[grep("^COX",rownames(BOC))] ) %>% sort()
GeneSet$DE$MTC = c("NDUFA1","NDUFA2","NDUFA3","NDUFA4","NDUFA5","NDUFA6","NDUFA8","NDUFA10","NDUFB1","NDUFB2","NDUFB3","NDUFB4","NDUFB5","NDUFB6","NDUFB8","NDUFB9","NDUFC1","NDUFS1","NDUFS5","NDUFS6","COX4I1","COX5A","COX5B","COX6A1","COX6B1","COX6C","COX7A2","COX7A2L","COX7B","COX7C","COX8A","COX14","COX15","COX16", find(BOC,"^ATP5"),"SDHA","UQCC2","UQCC3","UQCR10","UQCR11","UQCRB","UQCRC1","UQCRC2","UQCRH","UQCRQ" )

GeneSet$DE$ETC = list(
  "Complex I" = find(BOC, "^NDUF"),
  "Complex II" = find(BOC, "^SDH"),
  "Complex III" = c(find(BOC, "^UQC"),find(BOC,"^CYC")),
  "Complex IV" = find(BOC,"^COX"),
  "Complex V" = find(BOC, "^ATP")
)
GeneSet$DE$ETC1 = list(
  "Complex I" = find(BOC, "^NDUF"),
  "Complex II" = find(BOC, "^SDH"),
  "Complex III" = c(find(BOC, "^UQC"),find(BOC,"^CYC")),
  "Complex IV" = find(BOC,"^COX")
)
GeneSet$DE$ETC2 = list(
  "Complex V" = find(BOC, "^ATP")
)

GeneSet$DE$ETC.Ref = list(
  "Complex I" = fgsea_sets$WP_MITOCHONDRIAL_COMPLEX_I_ASSEMBLY_MODEL_OXPHOS_SYSTEM,
  "Complex II" = fgsea_sets$WP_MITOCHONDRIAL_COMPLEX_II_ASSEMBLY,
  "Complex III" = fgsea_sets$WP_MITOCHONDRIAL_COMPLEX_III_ASSEMBLY,
  "Complex IV" = fgsea_sets$WP_MITOCHONDRIAL_COMPLEX_IV_ASSEMBLY,
  "Complex V" = fgsea_sets_c5$GOCC_PROTON_TRANSPORTING_ATP_SYNTHASE_COMPLEX
)
GeneSet$DE$ETC.Ref2 = list(
  "Complex I" = intersect(GeneSet$DE$ETC$`Complex I`, fgsea_sets$WP_MITOCHONDRIAL_COMPLEX_I_ASSEMBLY_MODEL_OXPHOS_SYSTEM),
  "Complex II" = intersect(GeneSet$DE$ETC$`Complex II` ,fgsea_sets$WP_MITOCHONDRIAL_COMPLEX_II_ASSEMBLY),
  "Complex III" = intersect(GeneSet$DE$ETC$`Complex III`, fgsea_sets$WP_MITOCHONDRIAL_COMPLEX_III_ASSEMBLY),
  "Complex IV" = intersect(GeneSet$DE$ETC$`Complex IV`, fgsea_sets$WP_MITOCHONDRIAL_COMPLEX_IV_ASSEMBLY),
  "Complex V" = intersect(GeneSet$DE$ETC$`Complex V`  ,fgsea_sets_c5$GOCC_PROTON_TRANSPORTING_ATP_SYNTHASE_COMPLEX)
)
GeneSet$DE$ETC.Ribosome = c(GeneSet$DE$ETC.Ref2,GeneSet$DE$Ribosome)


GeneSet$DE$ETC.selected = c("NDUFA5","NDUFA6","NDUFA7","NDUFA8","NDUFB5","NDUFB6", "NDUFB8", "NDUFB9" ,"NDUFB10","NDUFB11","NDUFS5","NDUFV2" , "NDUFV3" ,"COX4I1","COX5A", "COX5B" , "COX6B1", "ATP5F1C", "ATP5F1D", "ATP5F1EP2" ,"ATP5MC1","ATP5MC2" ,"ATP5PD","ATP5PF","ATP5MF","ATP5ME" ,"ATP5IF1", "ATP6V1F","ATP6V1G1" )
GeneSet$DE$ETC.selected2 = c("NDUFA6","NDUFA7","NDUFB5","SDHAF1","SDHAF2","COX5A","COX5B","COX6A1","ATP5FA1","ATP5F1C","ATP5MF" )


GeneSet$DE$MT = c(rownames(BOC)[grep("^MT-",rownames(BOC))] ) %>% sort()
GeneSet$DE$TOMM = c(rownames(BOC)[grep("^TOMM",rownames(BOC))], rownames(BOC)[grep("^TIMM",rownames(BOC))]  ) %>% sort()



GeneSet$DE$RPL = c(rownames(BOC)[grep("^RPL",rownames(BOC))] ) %>% mixedsort() %>% intersect(fgsea_sets$KEGG_RIBOSOME)
GeneSet$DE$RPS = c(rownames(BOC)[grep("^RPS",rownames(BOC))] ) %>% mixedsort() %>% intersect(fgsea_sets$KEGG_RIBOSOME)
GeneSet$DE$Ribosome = list("Large subunit" = GeneSet$DE$RPL, "Small subunit" = GeneSet$DE$RPS)
GeneSet$DE$RibosomeMito = c(find(BOC,"^MRP"))  %>% mixedsort() 



GeneSet$DE$Proteasome = c(rownames(BOC)[grep("^PSM",rownames(BOC))] ,rownames(BOC)[grep("^UB",rownames(BOC))] ) %>% sort()
GeneSet$DE$ISG = c(rownames(BOC)[grep("^IFI",rownames(BOC))] , rownames(BOC)[grep("^ISG",rownames(BOC))], rownames(BOC)[grep("^IRF",rownames(BOC))]  ) %>% sort()


GeneSet$DE$Myc.Morrish = read.csv("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/Ref/Myc.target.Morrish.txt", sep="")$Genes



GeneSet$DE$Chemokine = c(rownames(BOC)[grep("^CCL",rownames(BOC))],
                                    rownames(BOC)[grep("^CXC",rownames(BOC))],
                                    rownames(BOC)[grep("^XCL",rownames(BOC))]
                                    ) %>% sort()
GeneSet$DE$Glycolysis = c("HK1","HK2","HK3","ENO1","ENO2","ALDOC","PGM1","PGM2","PGM3","GALE","GALM","PYGL","SLC2A1","SLC2A2","SLC2A3")
GeneSet$DE$Glycolysis2 = c(GeneSet$DE$Glycolysis, fgsea_sets$WP_AEROBIC_GLYCOLYSIS, fgsea_sets$MOOTHA_GLYCOLYSIS, fgsea_sets$REACTOME_GLYCOLYSIS) %>% unique() %>% sort()
GeneSet$DE$Glycolysis = c("HK1","ENO1","LDHA","PGAM1","PFKP","PKM","TPI1")
GeneSet$DE$Lipid = c("ACAA1","CPT1A","CPT1B","ECHS1","DBI","FABP5","LGALS1")
GeneSet$DE$MalateShuttle = fgsea_sets$BIOCARTA_MALATEX_PATHWAY
GeneSet$DE$MalateShuttle = c("MDH1","MDH2","GOT1","GOT2","SLC25A12","SLC25A13","SLC25A11")

GeneSet$DE$T_CD8= list("Unsupervisely" =c("CD44","CD69","FOS","FOSB","JUN","JUNB","JUND","KFKB1","NFKB2","NFKBIA","NFKBIB","NFKBIZ","NR4A1","NR4A2","NR4A3","KLF6","ID2","BCL6","IFNG","TCF7","FOXO1","BCL11B","LEF1","BACH2","MT-ND1","MT-ND2","MT-ND3","STMN1","HIST1H1D","RPLP1","HIST1H2AL","CDCA7","MKI67","HMGN2","HMGB2","TUBB","ATP5MC2","ATP5MG","ATP5V0B","NDUFB2","COX6A1","UQCRB","DNAJC15","BAX","ACTB","ACTG1","PSMB9","PSMB10"))

GeneSet$DE$CD8.Up = c("CD44","CD69","FOS","FOSB","JUN","JUNB","JUND","KFKB1","NFKB2","NFKBIA","NFKBIB","NFKBIZ","NR4A1","NR4A2","NR4A3","KLF6","ID2","BCL6","IFNG","TCF7","FOXO1","BCL11B","LEF1","BACH2")

GeneSet$DE$CD8.Overview = list(
  "Activation" = c("CD44","CD69","FOS","FOSB","JUN","JUNB","JUND","NFATC1","IFNG"),
  "TCR" = c("CD3D","CD3G","CD27","CD28"),
  "NFKB" = c("NFKB1","NFKBIZ","NR4A1","NR4A2","NR4A3","RELB"), 
  "IL2-signaling" = c("IL2RA","IL2RB","IL2RG","STAT5A","STAT5B"),
  "ETC" = c(GeneSet$DE$MTC1[1:3],GeneSet$DE$MTC23[1:3],GeneSet$DE$MTC4[1:3],GeneSet$DE$MTC5[49:52]), 
  "Ribosome" = GeneSet$DE$Ribosome[1:6], 
  "Proteosome" = GeneSet$DE$Proteosome[11:15],
  "-" = c("IFNG","TGFB1","HLA-DRA","HLA-DRB1","DNMT1","JARID1B","CTNNB1") )

GeneSet$DE$CD8.Overview2 = list(
  "Activation" = c("CD44","CD69","FOS","FOSB","JUN","JUNB","JUND","NFATC1","IFNG"),
  "NFKB" = c("NFKB1","NFKBIZ","NR4A1","NR4A2","NR4A3","RELB"), 
  "TCR" = c("CD3D","CD3G","CD27","CD28"),
  "IL2-signaling" = c("IL2RA","IL2RB","IL2RG","STAT5A","STAT5B"),
  "OXPHOS" = GeneSet$DE$ETC.selected2,
  "Ribosome" = c("RPS2","RPS3","RPS11","RPL3","RPL11","RPL19") )

GeneSet$DE$CD4.Beyer = list(
  "TCR" = c("CD3D","CD3G","CD27","CD28"),
  "IL2-signaling" = c("IL2","IL2RA","IL2RB","IL2RG","STAT5A","STAT5B"),
  "PGC" = c("PPARG" ,"PPARGC1A","PPARGC1B") )

GeneSet$DE$TIM.Overview = list(
  "AP-1" = c("FOS","FOSB","FOSL1","FOSL2","JUN","JUNB","JUND"),
  "NFKB" = c("NFKB1","NKFB2","NFKBIZ","NR4A1","NR4A2","NR4A3","RELB","RELA"), 
  "ETC" = c(GeneSet$DE$MTC1[1:3],GeneSet$DE$MTC23[1:3],"UQCC2","UQCC3",GeneSet$DE$MTC4[13:16],GeneSet$DE$MTC5[49:52]), 
  "Ribosome" = GeneSet$DE$Ribosome[3:8], 
  "Proteosome" = GeneSet$DE$Proteosome[11:15])
GeneSet$DE$Bonavita = list(
  "Promoting" = c("PTGS2","IL6","CXCL1","CXCL2","CSF3","IL1A","IL1B","CCL2","VEGFA"),
  "Inhibiting" = c("IL12A","IL12B","CXCL9","CXCL10","CCL5","STAT1")
)
GeneSet$DE$TIM.Overview2 = list(
  "AP-1" = c("FOS","FOSB","FOSL1","FOSL2","JUN","JUNB","JUND"),
  "NFKB" = c("NFKB1","NKFB2","NFKBIZ","NR4A1","NR4A2","NR4A3","RELB","RELA"), 
  "ETC" = GeneSet$DE$ETC.selected2,
  "Ribosome" = c("RPS2","RPS3","RPS11","RPL3","RPL11","RPL19") )

GeneSet$DE$Bonavita = list(
  "Promoting" = c("PTGS2","IL6","CXCL1","CXCL2","CSF3","IL1A","IL1B","CCL2","VEGFA"),
  "Inhibiting" = c("IL12A","IL12B","CXCL9","CXCL10","CCL5","STAT1")
)

GeneSet$DE$Module1 = list(
  "Regulator" = c("MYC","PPARGC1B","CEBPA","CEBPB"),
  "ETC" = GeneSet$DE$ETC.selected,
  "Ribosome" = GeneSet$DE$Ribosome,
  "ISG" = GeneSet$DE$ISG,
  "Proteosome" = GeneSet$DE$Proteasome,
  "Glycolysis" = GeneSet$DE$Glycolysis,
  "MalateShuttle" = GeneSet$DE$MalateShuttle
)
geneSet$DE[["Module2"]] = list(
  "NFKB-Angio" = geneSet$Module1B,
  "Mt-encoded" = c("mt-Atp6","mt-Atp8","mt-Co1","mt-Co2","mt-Co3","mt-Cytb","mt-Nd1","mt-Nd2","mt-Nd3","mt-Nd4"),
  "Proteosome" = c("Psma2","Psma3","Psma4","Psma5","Psma7","Psmb1","Psmb2","Psmb3","Psmb5","Psmb6","Ubb"),
  "OXPHOS" = geneSet$ETC.selected,
  "Ribosome" = c(geneSet$Ribosome),
  "Isg" = c("Ifi203","Ifi204","Ifi205","Ifi206","Ifi207","Ifi208","Ifi209","Ifi211","Ifi213","Ifi27la2","Ifi35","Ifi44","Ifi47","Ifih1","Ifit1","Ifit2","Ifit3","Ifitm2","Ifitm3",
                         "Isg15","Isg20","Irf1","Irf2","Irf7","Irf8","Irf9",
                         "Irf2bp1","Irf2bp2","Irf2bpl","Irf3","Irf4","Irf5",
                         "Ifi27","Ifitm1","Ifitm5","Ifitm6"),
  "Glycolysis" = GeneSet$DE$Glycolysis,
  "MalateShuttle" = GeneSet$DE$MalateShuttle
)


GeneSet$DE$HallmarkIFNG = fgsea_sets$HALLMARK_INTERFERON_GAMMA_RESPONSE
GeneSet$DE$HallmarkIFN_I = fgsea_sets$HALLMARK_INTERFERON_ALPHA_RESPONSE
GeneSet$DE$TAVOR_CEBPA_TARGETS_UP = fgsea_sets_c2$TAVOR_CEBPA_TARGETS_UP
GeneSet$DE$GERY_CEBP_TARGETS = fgsea_sets$GERY_CEBP_TARGETS
```

####Revise
```{r}
GeneSet$DE2 = list()
GeneSet$DE2[["AP1"]] = c("FOS","FOSB","FOSL2","JUN","JUNB","JUND","ATF2")
GeneSet$DE2[["NFKB"]] =c("NFKB1","NFKB2","NFKBIZ","REL","RELB","NR4A1","NR4A2","NR4A3")
GeneSet$DE2[["OXPHOS"]] =c("NDUFA1","NDUFA11","NDUFA13","NDUFA4","NDUFA7","DNUFA8","NDUFB3","NDUFB4","NDUFB5","NDUFB10","NDUFB11","NDUFS5","NDUFS6","SDHAF1","SDHAF2","SDHAF","SDHA","SDHB","SDHC","SDHD","UQCR10","UQCR11","UQCRB","UQCRC1","UQCRQ","COX10","COX14","COX17","COX5A","COX5B","COX6A1","COX6B1","COX6C","COX7A2","COX7C","COX8A","ATP5F1A","ATP5F1B","ATP5F1C","ATP5F1D","ATP5F1E","ATP5MC2","ATP5MC3","ATP5MF","ATP5MG","ATP5MPL","ATP5PD","ATP5PF","ATP5PO")
GeneSet$DE2[[""]] =c()
GeneSet$DE2[[""]] =c()
GeneSet$DE2[[""]] =c()
GeneSet$DE2[[""]] =c()
GeneSet$DE2[[""]] =c()
```


##geneSet (mouse)
```{r}
geneSet = list()
geneSet$LLC = c("Il1a","Il1b","Hif1a","Vegfa","Ptgs1","Ptgs2")
for(i in names(GeneSet$DE)){
  print(i)
  if(class(GeneSet$DE[[i]]) == "list" ){
    geneSet[[i]] = list()
    for(j in names(GeneSet$DE[[i]])){
      geneSet[[i]][[j]] = ref$H2M[GeneSet$DE[[i]][[j]],"Mouse_gene"]
    }
  } else {
    geneSet[[i]] = ref$H2M[GeneSet$DE[[i]],"Mouse_gene"]
  }
}
geneSet$RPS = c( find(LLC, "Rps") ) %>% mixedsort() %>% intersect(mfgsea_sets$KEGG_RIBOSOME)
geneSet$RPL = c( find(LLC, "Rpl") )  %>% mixedsort() %>% intersect(mfgsea_sets$KEGG_RIBOSOME)
geneSet$Ribosome = list("Large subunit" = geneSet$RPL, "Small subunit" =  geneSet$RPS ) 

geneSet$ETC = list(
  "Complex I" = find(LLC, "Nduf"),
  "Complex II" = find(LLC, "Sdh"),
  "Complex III" = c(find(LLC, "Uqc"),find(LLC,"Cyc")),
  "Complex IV" = find(LLC,"Cox"),
  "Complex V" = find(LLC, "^Atp")
)
geneSet$ETC.Ref2 = list(
  "Complex I" = intersect(geneSet$ETC$`Complex I`, mfgsea_sets$WP_MITOCHONDRIAL_COMPLEX_I_ASSEMBLY_MODEL_OXPHOS_SYSTEM),
  "Complex II" = intersect(geneSet$ETC$`Complex II` ,mfgsea_sets$WP_MITOCHONDRIAL_COMPLEX_II_ASSEMBLY),
  "Complex III" = intersect(geneSet$ETC$`Complex III`, mfgsea_sets$WP_MITOCHONDRIAL_COMPLEX_III_ASSEMBLY),
  "Complex IV" = intersect(geneSet$ETC$`Complex IV`, mfgsea_sets$WP_MITOCHONDRIAL_COMPLEX_IV_ASSEMBLY),
  "Complex V" = intersect(geneSet$ETC$`Complex V`  ,mfgsea_sets_c5$GOCC_PROTON_TRANSPORTING_ATP_SYNTHASE_COMPLEX)
)

geneSet$ETC2 = c("Ndufa1","Ndufa2","Ndufa3","Ndufa4","Ndufa5","Ndufa6","Ndufa7","Ndufa11","Ndufa12","Ndufa13","Ndufb2","Ndufb4","Ndufc1","Ndufs5","Ndufs6","Ndufv3","Uqcc2","Uqcr10","Uqcr11","Uqcrb","Uqcrh","Uqcrq","Cox5b","Cox6b1","Cox6c","Cox7a2","Cox7b","Cox7c","Cox8a","Atp5e","Atp5j","Atp5j2","Atp5k","Atp5l","Atp5md","Atp5mpl","Ets1","Ets2","Etv1","Etv2","Hif1a","Sod2","Pparg","Ppargc1a","Gpx1","Fis1")

geneSet$ETC.selected2 = list(
  "Complex I" = c("Ndufa2","Ndufa4","Ndufa6","Ndufa9","Ndufa11","Ndufa13","Ndufb2","Ndufb3","Ndufb7","Ndufb9","Ndufb10","Ndufb11","Ndufc2","Ndufs3","Ndufs4","Ndufs6","Ndufs8"),
  "Complex III" = c("Uqcc2","Uqcr10","Uqcrb","Uqcrh","Cycs"),
  "Complex IV" = c("Cox4i1","Cox5a","Cox5b","Cox6b1","Cox6b2","Cox7a2","Cox7b","Cox8a","Cox14"),
  "Complex V" = c("Atp5c1","Atp5d","Atp5e","Atp5g1","Atp5g2","Atp5h","Atp5j","Atp5j2")
)
geneSet$ETC.selected3 = list(
  "Complex I" = c("Ndufa2","Ndufa4","Ndufa6","Ndufa11","Ndufb2","Ndufb3","Ndufb7","Ndufb9","Ndufb10","Ndufb11","Ndufc2","Ndufs4","Ndufs6","Ndufs8"),
  "Complex III" = c("Uqcc2","Uqcr10","Uqcrb","Uqcrh","Cycs"),
  "Complex IV" = c("Cox5a","Cox5b","Cox6b1","Cox7a2","Cox7b","Cox8a"),
  "Complex V" = c("Atp5c1","Atp5d","Atp5e","Atp5g1","Atp5g2","Atp5h","Atp5j","Atp5j2")
)


geneSet$Mitochondria = list(
  "mtDNA" = find(LLC,"^mt-"),
  "Translocase" = c(find(LLC,"^Timm"), find(LLC,"^Tomm")),
  "Other" = c("Mfn1","Mfn2","Nme3","Mff","Dnm11l","Stat2","Opa1","Clpb","Clpp","Hspd1"),
  "Pyruvate" = find(LLC,"Pdh")
  
)
geneSet[["ETC.selected"]] = c("Ndufa5","Ndufa6","Ndufa7","Ndufa8","Ndufb5","Ndufb6","Ndufb8","Ndufb9","Ndufb10","Ndufb11","Ndufc2","Ndufs5","Ndufv2","Ndufv3",
                         "Cox4i1","Cox5a","Cox5b","Cox6b1","Cox7a2","Cox7a2l","Cox7b","Cox7c","Cox8a",
                         "Atp5b","Atp5c1","Atp5d","Atp5e","Atp5g1","Atp5g2","Atp5h","Atp5j","Atp5j2","Atp5k","Atpif1","Atp6v1f","Atp6v1g1")
geneSet[["Glycolysis"]] = c("Hk1","Hk2","Hk3","Eno1","Eno2","Aldoc","Pgm1","Pgm2","Pgm3","Gale","Galm","Pygl","Slc2a1","Slc2a2","Slc2a3")
geneSet[["Glycolysis2"]] = c(geneSet[["Glycolysis"]],mfgsea_sets$WP_AEROBIC_GLYCOLYSIS,mfgsea_sets$REACTOME_GLYCOLYSIS,mfgsea_sets$MOOTHA_GLYCOLYSIS) %>% unique() %>% sort()
geneSet[["Glycolysis3"]] = c("Hk1","Hk2","Hk3","Eno1","Eno2","Aldoc","Pgm1","Pgm2","Pgm3","Pfkm","Pfkl","Pfkp","Pkm","Gale","Galm","Pygl","Slc2a1","Slc2a2","Slc2a3")
geneSet$CD8.Overview2 = geneSet$CD8.Overview
geneSet$CD8.Overview2$ETC = find(LLC,"^Atp5")
geneSet$CD8.Overview2$`-` = c(geneSet$CD8.Overview$`-`, find(LLC,"Il2r"))

geneSet$cAMP = mmart[grep("cAMP",mmart$description),]$mgi_symbol %>% sort()

c(mmart[grep("Glutathi]",mmart$description,ignore.case = T),]$mgi,"Cat","Sod1","Sod2","Sod3")


geneSet$MT.All =  mmart[grep("Mitochondria",mmart$description,ignore.case = T),]$mgi %>% sort()



geneSet$Ribosome_KEGG = mfgsea_sets$KEGG_RIBOSOME

geneSet$IFNG_response = mfgsea_sets$HALLMARK_INTERFERON_GAMMA_RESPONSE


geneSet$ETC.Hallmark = mfgsea_sets$HALLMARK_OXIDATIVE_PHOSPHORYLATION
```





#==========BOC=============
#Initialization
scBOC.CD45.Initiation.230712.r
```{r}
library(Seurat)
library(SeuratWrappers)
library(harmony)
library(tidyverse)
options(future.globals.maxSize = 100000 * 1024^2)

Clustering1 <- function(tmp,dim=30,res=0.3,spread =1, dist = 0.5,group = "ID" ){
      DefaultAssay(tmp) = "RNA"
      tmp <- NormalizeData(tmp) %>% FindVariableFeatures() %>% ScaleData() %>% RunPCA(verbose = FALSE)
      tmp <- RunHarmony(tmp, group.by.vars = group)
      tmp <- RunUMAP(tmp, reduction = "harmony", dims = 1:dim, min.dist = dist, spread = spread )
      tmp <- FindNeighbors(tmp, reduction = "harmony", dims = 1:dim) %>% FindClusters(resolution = res)
      return(tmp)
}


Batch.scRNA = c("scBRCA1","scBRCA3","scBRCA4","scBRCA5","scBRCA6", 
                paste0("scOVCA",1:5),
                paste0("scCRC",1:5))
Batch.original = c(paste0("BRCA",c(10,12,17,20,22)),
                   paste0("HGSOC",c(4,5,"5CMT",6,16)),
                   paste0("CRC",c(1,5,7,8,9)) )
ID = paste0(Batch.scRNA,"_CD45")
Condition = rep(c("CD45"),15)
Cancer = c(rep("BRCA",5),rep("OVCA",5), rep("CRC",5) )
Histo = c("Luminal","Luminal","TNBC","TNBC","TNBC",
          "HGSOC","HGSOC","HGSOC","HGSOC","HGSOC",
          "CRC","CRC","CRC","CRC","CRC")

CellRangerDir = paste0("//home/siwakorn/Human/Counts/",ID, "/filtered_feature_bc_matrix")

RNA = list()
for(i in 1:length(CellRangerDir)){
      tmp = Read10X(data.dir = CellRangerDir[i]  )
      RNA[[i]] <- CreateSeuratObject(counts = tmp, min.cells = 3, min.features = 0)
      RNA[[i]][["percent.mt"]] <- PercentageFeatureSet(RNA[[i]], pattern = "^MT-")
      RNA[[i]]$CB.original = colnames(RNA[[i]])
      RNA[[i]]$Cancer = as.character(Cancer[i])
      RNA[[i]]$Histo = as.character(Histo[i])
      RNA[[i]]$Batch.original <- as.character(Batch.original[i])
      RNA[[i]]$Batch.scRNA <- as.character(Batch.scRNA[i])
      RNA[[i]]$Condition <- as.character(Condition[i])
      RNA[[i]]$ID = paste0(as.character(RNA[[i]]$Batch.scRNA),"_",as.character(RNA[[i]]$Condition))
      RNA[[i]]$CB.new = paste0(RNA[[i]]$ID,":", colnames(RNA[[i]]) )
      RNA[[i]]$CB.new = gsub("-1","x",RNA[[i]]$CB.new)
      RNA[[i]] <- RenameCells(RNA[[i]], new.names = RNA[[i]]$CB.new )
}

print("part1")
BOC = merge(x = RNA[[1]],
            y = RNA[2:length(RNA)],
            merge.data = TRUE)
RNA = 0
DefaultAssay(BOC) = "RNA"

print("part2")
BOC = NormalizeData(BOC) %>% FindVariableFeatures() %>% ScaleData() %>% RunPCA(verbose = FALSE)
BOC = RunHarmony(BOC, group.by.vars = "ID")

saveRDS(BOC, file = "//home/siwakorn/Human/RDS/BOC.CD45.230712.rds") 

BOC = subset(BOC, percent.mt < 10)
BOC = NormalizeData(BOC) %>% FindVariableFeatures() %>% ScaleData() %>% RunPCA(verbose = FALSE)
BOC = RunHarmony(BOC, group.by.vars = "ID")
BOC <- RunUMAP(BOC, reduction = "harmony", dims = 1:30, min.dist = 1, spread =1 )
BOC <- FindNeighbors(BOC, reduction = "harmony", dims = 1:30) %>% FindClusters(resolution = 0.3)
saveRDS(BOC, file = "//home/siwakorn/Human/RDS/BOC_preSubmitted.QC10.230712.rds")
```


#Classification
```{r}
BOC <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC_preSubmitted.QC10.230712.rds")
BOC = RenameIdents(BOC, 
                   '0' = "TNK",
                   '3' = "TNK",
                   '4' = "TNK",
                   '6' = "TNK",
                   '9' = "TNK",
                   '14' = "TNK",
                   '17' = "TNK",
                   '18' = "TNK",
                   '2' = "Myeloid",
                   '8' = "Myeloid",
                   '15' = "Myeloid",
                   '16' = "Myeloid",
                   '5' = "B_cell",
                   '1' = "B_cell",
                   '7' = "Dividing",
                   '12' = "Dividing",
                   '13' = "Dividing",
                   '10' = "Minor",
                   '11' = "Minor"
                   )
BOC$Identity.Lineage = Idents(BOC)


#-----------------------------------------------------------------------------------------
##TNK
TNK = subset(BOC,idents = "TNK")
TNK = Clustering1(TNK)
TNK = RenameIdents(TNK,
                   '5' = "NK",
                   '6' = "NK",
                   '0' = "T_CD8",
                   '4' = "T_CD8",
                   '7' = "T_CD8",
                   '1' = "T_CD4",
                   '2' = "T_CD4",
                   '3' = "Treg",
                   '8' = "LQ",
                   '9' = "LQ")
TNK$Identity.Celltype = Idents(TNK)

NK = subset(TNK, idents = "NK")
NK = Clustering1(NK)
NK = RenameIdents(NK,
                   '0' = "T_CD8",
                   '1' = "NK",
                   '2' = "T_CD8",
                   '3' = "NK",
                   '4' = "NK",
                   '5' = "NK",
                   '6' = "NK",
                   '7' = "NK",
                   '8' = "NK",
                   '9' = "NK")
NK$Identity.Celltype = Idents(NK)

CD8 = subset(TNK, idents = "T_CD8")
CD8 = Clustering1(CD8)
CD8 = RenameIdents(CD8,
                   '0' = "T_CD8",
                   '1' = "T_CD8",
                   '3' = "T_CD8",
                   '6' = "T_CD8")
CD8$Identity.Celltype = Idents(CD8)
C2 = subset(CD8, idents = 2)
C2 = Clustering1(C2)
C2 = RenameIdents(C2,
                  '0' = "T_CD8",
                  '2' = "T_CD8",
                  '1' = "T_CD4",
                  '4' = "T_CD4",
                  '3' = "LQ",
                  '5' = "LQ")
C2$Identity.Celltype = Idents(C2)

C4 = subset(CD8, idents = 4)
C4 = Clustering1(C4,res =1)
C4 = RenameIdents(C4,
                   '0' = "T_CD4",
                   '1' = "T_CD8",
                   '2' = "T_CD8",
                   '3' = "T_CD4",
                   '4' = "T_CD4",
                   '5' = "T_CD8",
                   '6' = "T_CD8",
                   '7' = "T_CD8",
                   '8' = "T_CD8",
                   '9' = "T_CD4",
                   '10' = "T_CD4"
                  )
C4$Identity.Celltype = Idents(C4)

C5 = subset(CD8, idents = 5)
C5 = Clustering1(C5)
C5 = RenameIdents(C5, 
                  '0' = "T_CD4",
                  '1' = "T_CD8",
                  '2' = "T_CD4",
                  '3' = "LQ",
                  '4' = "T_CD4")
C5$Identity.Celltype = Idents(C5)

tmp1 = CD8[[]] %>% dplyr::select(Identity.Celltype) %>% filter(Identity.Celltype == "T_CD8")
tmp2 = C2[[]] %>% dplyr::select(Identity.Celltype) 
tmp3 = C4[[]] %>% dplyr::select(Identity.Celltype) 
tmp4 = C5[[]] %>% dplyr::select(Identity.Celltype) 

tmp = rbind(tmp1,tmp2,tmp3,tmp4)
tmp1 = tmp$Identity.Celltype
names(tmp1) = rownames(tmp)
CD8 = AddMetaData(CD8,tmp1, "Identity.Celltype")

CD4 = subset(TNK, idents = "T_CD4")
CD4 = Clustering1(CD4)
CD4 = RenameIdents(CD4,
                   '0' = "T_CD4",
                   '1' = "T_CD4",
                   '2' = "T_CD4",
                   '3' = "T_CD4",
                   '4' = "T_CD8",
                   '5' = "T_CD4",
                   '6' = "T_CD8"
                   )
CD4$Identity.Celltype = Idents(CD4)

Treg= subset(TNK, idents = "Treg")
Treg = Clustering1(Treg)
Treg = RenameIdents(Treg,
                    '3' = "T_CD8",
                    '0' = "T_CD4_FOXP3",
                    '1' = "T_CD4_FOXP3",
                    '2' = "T_CD4_FOXP3",
                    '4' = "T_CD4_FOXP3",
                    '5' = "T_CD4_FOXP3",
                    '6' = "T_CD4_FOXP3")
Treg$Identity.Celltype = Idents(Treg)


tmp1 = TNK[[]] %>% dplyr::select(Identity.Celltype) %>% filter(Identity.Celltype == "LQ")
tmp2 = NK[[]] %>% dplyr::select(Identity.Celltype) 
tmp3 = CD8[[]] %>% dplyr::select(Identity.Celltype) 
tmp4 = CD4[[]] %>% dplyr::select(Identity.Celltype) 
tmp5 = Treg[[]] %>% dplyr::select(Identity.Celltype) 

tmp = rbind(tmp1,tmp2,tmp3,tmp4,tmp5)
tmp1 = tmp$Identity.Celltype
names(tmp1) = rownames(tmp)
TNK = AddMetaData(TNK,tmp1, "Identity.Celltype")
Idents(TNK) = TNK$Identity.Celltype
DimPlot(TNK)
#-----------------------------------------------------------------------------------------
##Myeloid
M = subset(BOC, idents = "Myeloid")
M = Clustering1(M)
DimPlot(M,label = T)
Idents(M) = M$seurat_clusters
M = RenameIdents(M,
                 '0' = "TIM",
                 '2' = "TIM",
                 '3' = "TIM",
                 '6' = "TIM",
                 '8' = "TIM",
                 '11' = "TIM",
                 '5' = "TIM_Dividing",
                 '1' = "TAN-PMN",
                 '4' = "cDC2",
                 '10' = "cDC1",
                 '9' = "mregDC",
                 '7' = "pDC"
                 )
M$Identity.Celltype = Idents(M)
TIM = subset(M, idents = "TIM")
TIM = Clustering1(TIM)
TIM = RenameIdents(TIM,
                   '0' = "TIM_VCAN",
                   '1' = "TIM_C1QA",
                   '2' = "C2",
                   '3' = "TIM_VCAN",
                   '4' = "TIM_C1QA",
                   '5' = "Minor",
                   '6' = "Minor",
                   '7' = "Minor",
                   '8' = "Minor")
TIM$Identity.Celltype = Idents(TIM)

C2 = subset(TIM, idents = "C2")
C2 = Clustering1(C2)
C2 = RenameIdents(C2, 
                  '1' = "TIM_VCAN",
                  '2' = "TIM_C1QA",
                  '3' = "LQ",
                  '5' = "TIM_C1QA",
                  '6' = "TIM_C1QA",
                  '0' = "LQ",
                  '4' = "LQ",
                  '7' = "LQ")
C2$Identity.Celltype = Idents(C2)

C5 = subset(M,idents = "TIM_Dividing")
C5 = Clustering1(C5)

tmp1 = M[[]] %>% dplyr::select(Identity.Celltype) %>% filter(!Identity.Celltype == "TIM")
tmp2 = TIM[[]]  %>% dplyr::select(Identity.Celltype) %>% filter(!Identity.Celltype == "C2")
tmp3 = C2[[]]  %>% dplyr::select(Identity.Celltype)
tmp = rbind(tmp1,tmp2,tmp3)
tmp1 = tmp$Identity.Celltype
names(tmp1) = rownames(tmp)
M = AddMetaData(M, tmp1, "Identity.Celltype")
#-----------------------------------------------------------------------------------------
##Div
Div = subset(BOC, idents = "Dividing")
Div = Clustering1(Div)
Div$seurat_clusters = Idents(Div)
Div = RenameIdents(Div,
                   '0' = "T_CD8_Dividing",
                   '1' = "T_CD4_Dividing",
                   '2' = "T_CD4_FOXP3_Dividing",
                   '5' = "T_GD_Dividing",
                   '2' = "B_cell_Dividing",
                   '3' = "Plasma_cell_Dividing",
                   '7' = "Plasma_cell_Dividing",
                   '6' = "LQ")

Idents(Div) = Div$seurat_clusters
Div = RenameIdents(Div,
                   '0' = "T_CD8",
                   '1' = "T_CD4",
                   '4' = "T_CD4_FOXP3",
                   '5' = "NK",
                   '2' = "B_cell",
                   '3' = "B_cell",
                   '7' = "B_cell",
                   '6' = "LQ")
Div$Identity.Celltype = Idents(Div)
DimPlot(Div,label=T)


#-----------------------------------------------------------------------------------------
#Embed
BOC$Identity.Celltype = BOC$Identity.Lineage
tmp1 = BOC[[]] %>% dplyr::select(Identity.Celltype) %>% filter(Identity.Celltype %in% c("B_cell","Minor") )
tmp2 = TNK[[]] %>% dplyr::select(Identity.Celltype) 
tmp3 = M[[]] %>% dplyr::select(Identity.Celltype) 
tmp4 = Div[[]] %>% dplyr::select(Identity.Celltype) 
tmp = rbind(tmp1,tmp2,tmp3,tmp4)
tmp1 = tmp$Identity.Celltype
names(tmp1)= rownames(tmp)

BOC = AddMetaData(BOC, tmp1, "Identity.Celltype")
write.csv(sort(unique(BOC$Identity.Celltype)), "BOC.Identity.Celltype.230406.csv")
tmp =read.csv("BOC.Identity.Celltype.230406.modified.csv")$x
BOC$Identity.Celltype = factor(BOC$Identity.Celltype, levels= tmp)
BOC$Identity.Celltype1 = BOC$Identity.Celltype
Idents(BOC) = BOC$Identity.Celltype

#NK
NK = subset(BOC, idents = "NK")
NK = Clustering1(NK)
NK = RenameIdents(NK,
                  '0' = "NK",
                   '1' = "NK",
                   '2' = "NK",
                   '3' = "NK",
                   '4' = "NK",
                   '5' = "NK",
                   '6' = "NK",
                   '7' = "NK",
                   '9' = "NK_Dividing",
                   '10' = "NK",
                  '8' = "LQ")
NK$Identity.Celltype2 = Idents(NK)
NK$Identity.Subtype1 = Idents(NK)
NK$Identity.Subtype2 = Idents(NK)
DimPlot(NK,label=T)

#-----------------------------------------------------------------------------------------
#CD8
CD8 = subset(BOC, idents = "T_CD8")
CD8 = Clustering1(CD8)
Idents(CD8) = CD8$seurat_clusters
CD8 = RenameIdents(CD8, 
                   '0' = "T_CD8",
                   '1' = "T_CD8",
                   '2' = "T_CD8",
                   '3' = "T_CD8",
                   '4' = "T_CD8_Dividing",
                   '5' = "T_CD8",
                   '6' = "T_CD8",
                   '7' = "T_CD8",
                   '8' = "T_CD8",
                   '9' = "T_CD8",
                   '10' = "T_CD8" #KLRD1
                   )
CD8$Identity.Celltype2 = Idents(CD8)
Idents(CD8) = CD8$seurat_clusters
CD8 = RenameIdents(CD8, 
                    '3' = "T_CD8_TCF7",
                   '0' = "T_CD8_GZMK",
                   '2' = "T_CD8_GZMK",
                   '1' = "T_CD8_HAVCR2",
                   '5' = "T_CD8_GNLY",
                   '10' = "T_CD8_GNLY", #KLRD1
                   '6' = "T_CD8_ISG",
                   '8' = "T_CD8_RORA",
                   '9' = "T_CD8_TNFRSF4",
                   '7' = "T_CD8_FOXP3",
                   '4' = "T_CD8_Dividing"
                   )
CD8$Identity.Subtype1 = Idents(CD8)
Idents(CD8) = CD8$seurat_clusters
CD8 = RenameIdents(CD8, 
                    '3' = "T_CD8_TCF7",
                   '0' = "T_CD8_GZMK_s1",
                   '2' = "T_CD8_GZMK_s2",
                   '1' = "T_CD8_HAVCR2",
                   '5' = "T_CD8_GNLY_s1",
                   '10' = "T_CD8_GNLY_s2", #KLRD1
                   '6' = "T_CD8_ISG",
                   '8' = "T_CD8_RORA",
                   '9' = "T_CD8_TNFRSF4",
                   '7' = "T_CD8_FOXP3",
                   '4' = "T_CD8_Dividing"
                   )
CD8$Identity.Subtype2 = Idents(CD8)
DimPlot(CD8, label= T)
#-----------------------------------------------------------------------------------------
#CD4
CD4 = subset(BOC, idents = "T_CD4")
CD4 = Clustering1(CD4)

Idents(CD4) = CD4$seurat_clusters
CD4 = RenameIdents(CD4,
                   '0' = "T_CD4",
                   '1' = "T_CD4",
                   '2' = "T_CD4",
                   '3' = "T_CD4",
                   '4' = "T_CD4",
                   '5' = "T_CD4",
                   '8' = "T_CD4",
                   '7' = "T_CD4", #ISG
                   '6' = "T_CD4_Dividing",
                   '9' = "LQ")
CD4$Identity.Celltype2 = Idents(CD4)

Idents(CD4) = CD4$seurat_clusters
CD4 = RenameIdents(CD4,
                   '0' = "T_CD4_KLF2",
                   '1' = "T_CD4_TOX",
                   '2' = "T_CD4_KLF2",
                   '3' = "T_CD4_TOX",
                   '4' = "T_CD4_KLF2",
                   '5' = "T_CD4_TOX",
                   '8' = "T_CD4_TOX",
                   '7' = "T_CD4_ISG", #ISG
                   '6' = "T_CD4_Dividing",
                   '9' = "LQ")
CD4$Identity.Subtype1 = Idents(CD4)

Idents(CD4) = CD4$seurat_clusters
CD4 = RenameIdents(CD4,
                   '0' = "T_CD4_KLF2_s1",
                   '2' = "T_CD4_KLF2_s2",
                   '4' = "T_CD4_KLF2_s3",
                   '1' = "T_CD4_TOX_s1",
                   '3' = "T_CD4_TOX_s2",
                   '5' = "T_CD4_TOX_s3",
                   '8' = "T_CD4_TOX_s4",
                   '7' = "T_CD4_ISG", #ISG
                   '6' = "T_CD4_Dividing",
                   '9' = "LQ")
CD4$Identity.Subtype2 = Idents(CD4)
#-----------------------------------------------------------------------------------------
#Treg
Treg = subset(BOC,idents = "T_CD4_FOXP3")
Treg = Clustering1(Treg)
Idents(Treg)= Treg$seurat_clusters
Treg = RenameIdents(Treg, 
                   '0' = "T_CD4_FOXP3",
                   '1' = "T_CD4_FOXP3",
                   '2' = "T_CD4_FOXP3",
                   '3' = "T_CD4_FOXP3",
                   '4' = "T_CD4_FOXP3",
                   '5' = "T_CD4_FOXP3",
                   '7' = "T_CD4_FOXP3",
                   '6' = "T_CD4_FOXP3_Dividing")
Treg$Identity.Celltype2 = Idents(Treg)
Idents(Treg)= Treg$seurat_clusters
Treg = RenameIdents(Treg, 
                   '0' = "T_CD4_FOXP3_KLF2",
                   '1' = "T_CD4_FOXP3_TNFRSF9",
                   '2' = "T_CD4_FOXP3_TNFRSF9",
                   '3' = "T_CD4_FOXP3_TNFRSF9",
                   '4' = "T_CD4_FOXP3_TNFRSF9",
                   '5' = "T_CD4_FOXP3_TNFRSF9",
                   '7' = "T_CD4_FOXP3_TNFRSF9",
                   '6' = "T_CD4_FOXP3_Dividing")
Treg$Identity.Subtype1 = Idents(Treg)
Idents(Treg)= Treg$seurat_clusters
Treg = RenameIdents(Treg, 
                   '0' = "T_CD4_FOXP3_KLF2",
                   '1' = "T_CD4_FOXP3_TNFRSF9_s1",
                   '2' = "T_CD4_FOXP3_TNFRSF9_s2",
                   '3' = "T_CD4_FOXP3_TNFRSF9_s3",
                   '4' = "T_CD4_FOXP3_TNFRSF9_s4",
                   '5' = "T_CD4_FOXP3_TNFRSF9_s5",
                   '7' = "T_CD4_FOXP3_TNFRSF9_s6",
                   '6' = "T_CD4_FOXP3_Dividing")
Treg$Identity.Subtype2 = Idents(Treg)
DimPlot(Treg,label=T)
#-----------------------------------------------------------------------------------------
#TIM
TIM = subset(BOC, idents = c("TIM_VCAN","TIM_C1QA","TIM_Dividing","TAN-PMN"))
TIM = Clustering1(TIM,res = 1)
DimPlot(TIM,label=T)
Idents(TIM) = TIM$seurat_clusters
TIM = RenameIdents(TIM,
                   '0' = "TAN-PMN",
                   '6' = "TAN-PMN",
                   '15' = "TAN-PMN",
                   '10' = "TAN-PMN",
                   '1' = "TIM",
                   '7' = "TIM",
                   '9' = "TIM",
                   '18' = "TIM",
                   '13' = "TIM",
                   '14' = "TIM",
                   '8' = "TIM_Dividing",
                   '17' = "TIM_Dividing",
                   '2' = "TIM",
                   '3' = "TIM",
                   '4' = "TIM",
                   '11' = "TIM",
                   '12' = "TIM",
                   '16' = "TIM",
                   '5' = "LQ"
                   )
TIM$Identity.Celltype2 = Idents(TIM)
DimPlot(TIM)
Idents(TIM) = TIM$seurat_clusters
TIM = RenameIdents(TIM,
                   '0' = "TAN-PMN",
                   '6' = "TAN-PMN",
                   '15' = "TAN-PMN",
                   '10' = "TAN-PMN",
                   '1' = "TIM_C1QA",
                   '7' = "TIM_C1QA",
                   '9' = "TIM_C1QA",
                   '18' = "TIM_C1QA",
                   '13' = "TIM_C1QA",
                   '14' = "TIM_C1QA",
                   '8' = "TIM_C1QA_Dividing",
                   '17' = "TIM_C1QA_Dividing",
                   '2' = "TIM_VCAN",
                   '3' = "TIM_VCAN",
                   '4' = "TIM_VCAN",
                   '11' = "TIM_VCAN",
                   '12' = "TIM_VCAN",
                   '16' = "TIM_VCAN",
                   '5' = "LQ"
                   )
TIM$Identity.Subtype1 = Idents(TIM)
Idents(TIM) = TIM$seurat_clusters
TIM = RenameIdents(TIM,
                   '0' = "TAN-PMN_s1",
                   '6' = "TAN-PMN_s2",
                   '15' = "TAN-PMN_s3",
                   '10' = "TAN-PMN_s4",
                   '1' = "TIM_C1QA_s1",
                   '7' = "TIM_C1QA_s2",
                   '9' = "TIM_C1QA_s3",
                   '18' = "TIM_C1QA_s4",
                   '13' = "TIM_C1QA_s5",
                   '14' = "TIM_C1QA_s6",
                   '8' = "TIM_C1QA_Dividing_s1",
                   '17' = "TIM_C1QA_Dividing_s2",
                   '2' = "TIM_VCAN_s1",
                   '3' = "TIM_VCAN_s2",
                   '4' = "TIM_VCAN_s3",
                   '11' = "TIM_VCAN_s4",
                   '12' = "TIM_VCAN_s5",
                   '16' = "TIM_VCAN_s6",
                   '5' = "LQ"
                   )
TIM$Identity.Subtype2 = Idents(TIM)

#-----------------------------------------------------------------------------------------
#B Cell
B = subset(BOC, idents = "B_cell")
B = Clustering1(B)
Idents(B) = B$seurat_clusters
B = RenameIdents(B,
                 '2' = "B_cell",
                 '4' = "B_cell",
                 '0' = "Plasma_cell",
                 '1' = "Plasma_cell",
                 '3' = "Plasma_cell",
                 '5' = "Plasma_cell",
                 '7' = "Plasma_cell",
                 '6' = "B-Plasma_cell_Dividing")
B$Identity.Celltype2 = Idents(B)
B$Identity.Subtype1 = Idents(B)
Idents(B) = B$seurat_clusters
B = RenameIdents(B,
                 '2' = "B_cell_s1",
                 '4' = "B_cell_s2",
                 '0' = "Plasma_cell_s1",
                 '1' = "Plasma_cell_s2",
                 '3' = "Plasma_cell_s3",
                 '5' = "Plasma_cell_s4",
                 '7' = "Plasma_cell_s5",
                 '6' = "B-Plasma_cell_Dividing")
B$Identity.Subtype2 = Idents(B)

#Embed
Idents(BOC)=BOC$Identity.Celltype
DimPlot(BOC)
tmp1 = BOC[[]] %>% dplyr::select(Identity.Celltype) %>% filter(Identity.Celltype %in% c("cDC1","cDC2","mregDC","pDC","Minor","LQ"))
tmp1$Identity.Celltype2 = tmp1$Identity.Celltype
tmp1$Identity.Subtype1 = tmp1$Identity.Celltype
tmp1$Identity.Subtype2 = tmp1$Identity.Celltype
tmp2 = NK[[]]  %>% dplyr::select(Identity.Celltype,Identity.Celltype2,Identity.Subtype1,Identity.Subtype2)
tmp3 = CD8[[]] %>% dplyr::select(Identity.Celltype,Identity.Celltype2,Identity.Subtype1,Identity.Subtype2)
tmp4 = CD4[[]] %>% dplyr::select(Identity.Celltype,Identity.Celltype2,Identity.Subtype1,Identity.Subtype2)
tmp5 = Treg[[]] %>% dplyr::select(Identity.Celltype,Identity.Celltype2,Identity.Subtype1,Identity.Subtype2)
tmp6 = TIM[[]] %>% dplyr::select(Identity.Celltype,Identity.Celltype2,Identity.Subtype1,Identity.Subtype2)
tmp7 = B[[]] %>% dplyr::select(Identity.Celltype,Identity.Celltype2,Identity.Subtype1,Identity.Subtype2)
tmp = rbind(tmp1,tmp2,tmp3,tmp4,tmp5,tmp6,tmp7)

tmp1 = tmp$Identity.Celltype2
names(tmp1) = rownames(tmp)
BOC = AddMetaData(BOC,tmp1,"Identity.Celltype2")

tmp1 = tmp$Identity.Subtype1
names(tmp1) = rownames(tmp)
BOC = AddMetaData(BOC,tmp1,"Identity.Subtype1")

tmp1 = tmp$Identity.Subtype2
names(tmp1) = rownames(tmp)
BOC = AddMetaData(BOC,tmp1,"Identity.Subtype2")

write.csv(sort(unique(BOC$Identity.Celltype2)),"BOC.CD45.Identity.Celltype2.230712.csv")
write.csv(sort(unique(BOC$Identity.Subtype1)),"BOC.CD45.Identity.Subtype1.230712.csv")
write.csv(sort(unique(BOC$Identity.Subtype2)),"BOC.CD45.Identity.Subtype2.230712.csv")

tmp = read.csv("BOC.CD45.Identity.Celltype2.230712.modified.csv")$x
BOC$Identity.Celltype2 = factor(BOC$Identity.Celltype2, levels = tmp)

tmp = read.csv("BOC.CD45.Identity.Subtype1.230712.modified.csv")$x
BOC$Identity.Subtype1 = factor(BOC$Identity.Subtype1, levels = tmp)

tmp = read.csv("BOC.CD45.Identity.Subtype2.230712.modified.csv")$x
BOC$Identity.Subtype2 = factor(BOC$Identity.Subtype2, levels = tmp)

Idents(BOC) = BOC$Identity.Celltype2
BOC <- RenameIdents(BOC,
                    'NK' = "NK",
                    'NK_Dividing' = "NK",
                    'T_CD8' = "CD8 T cell",
                    'T_CD8_Dividing' = "CD8 T cell",
                    'T_CD4' = "CD4 T cell",
                    'T_CD4_Dividing' = "CD4 T cell",
                    'T_CD4_FOXP3' = "regulatory T cell",
                    'T_CD4_FOXP3_Dividing' = "regulatory T cell",
                    'TAN-PMN' = "TAN-PMN",
                    'TIM' = "TIM",
                    'TIM_Dividing' = "TIM",
                    'cDC1' = "DC",
                    'cDC2' = "DC",
                    'mregDC' = "DC",
                    'pDC' = "DC",
                    'B_cell' = "B cell",
                    'B-Plasma_cell_Dividing' = "B cell",
                    'Plasma_cell' = "Plasma cell")
BOC$Identity.Celltype3 = Idents(BOC)

Idents(BOC) = BOC$Identity.Celltype2
BOC <- RenameIdents(BOC,
                    'NK' = "NK",
                    'NK_Dividing' = "NK",
                    'T_CD8' = "T_CD8",
                    'T_CD8_Dividing' = "T_CD8",
                    'T_CD4' = "T_CD4",
                    'T_CD4_Dividing' = "T_CD4",
                    'T_CD4_FOXP3' = "T_CD4_FOXP3",
                    'T_CD4_FOXP3_Dividing' = "T_CD4_FOXP3",
                    'TAN-PMN' = "TIM",
                    'TIM' = "TIM",
                    'TIM_Dividing' = "TIM",
                    'cDC1' = "DC",
                    'cDC2' = "DC",
                    'mregDC' = "DC",
                    'pDC' = "DC",
                    'B_cell' = "B cell",
                    'B-Plasma_cell_Dividing' = "B cell",
                    'Plasma_cell' = "Plasma cell")
BOC$Identity.Celltype = Idents(BOC)

Idents(BOC) = BOC$Identity.Celltype2
BOC <- RenameIdents(BOC,
                    'NK' = "NK",
                    'NK_Dividing' = "NK",
                    'T_CD8' = "CD8 T cell",
                    'T_CD8_Dividing' = "CD8 T cell",
                    'T_CD4' = "CD4 T cell",
                    'T_CD4_Dividing' = "CD4 T cell",
                    'T_CD4_FOXP3' = "regulatory T cell",
                    'T_CD4_FOXP3_Dividing' = "regulatory T cell",
                    'TAN-PMN' = "TIM",
                    'TIM' = "TIM",
                    'TIM_Dividing' = "TIM",
                    'cDC1' = "DC",
                    'cDC2' = "DC",
                    'mregDC' = "DC",
                    'pDC' = "DC",
                    'B_cell' = "B cell",
                    'B-Plasma_cell_Dividing' = "B cell",
                    'Plasma_cell' = "Plasma cell")
BOC$Identity.CelltypeR = Idents(BOC)

Idents(BOC) = BOC$Identity.Celltype2
BOC <- RenameIdents(BOC,
                    'NK' = "NK",
                    'T_CD8' = "T_CD8",
                    'T_CD4' = "T_CD4",
                    'T_CD4_FOXP3' = "T_CD4_FOXP3",
                    'TAN-PMN' = "TIM",
                    'TIM' = "TIM",
                    'cDC1' = "DC",
                    'cDC2' = "DC",
                    'mregDC' = "DC",
                    'pDC' = "DC",
                    'B_cell' = "B cell",
                    'Plasma_cell' = "Plasma cell",
                    'NK_Dividing' = "Dividing",
                    'T_CD8_Dividing' = "Dividing",
                    'T_CD4_Dividing' = "Dividing",
                    'T_CD4_FOXP3_Dividing' = "Dividing",
                    'TIM_Dividing' = "Dividing",
                    'B-Plasma_cell_Dividing' = "Dividing")
BOC$Identity.Celltype4 = Idents(BOC)

Idents(BOC) = BOC$Identity.Celltype2
BOC <- RenameIdents(BOC,
                    'NK' = "NK",
                    'T_CD8' = "CD8 T cell",
                    'T_CD4' = "CD4 T cell",
                    'T_CD4_FOXP3' = "regulatory T cell",
                    'TAN-PMN' = "TIM",
                    'TIM' = "TIM",
                    'cDC1' = "DC",
                    'cDC2' = "DC",
                    'mregDC' = "DC",
                    'pDC' = "DC",
                    'B_cell' = "B cell",
                    'Plasma_cell' = "Plasma cell",
                    'NK_Dividing' = "Dividing",
                    'T_CD8_Dividing' = "Dividing",
                    'T_CD4_Dividing' = "Dividing",
                    'T_CD4_FOXP3_Dividing' = "Dividing",
                    'TIM_Dividing' = "Dividing",
                    'B-Plasma_cell_Dividing' = "Dividing"
                    )
BOC$Identity.Celltype4R = Idents(BOC)
DimPlot(BOC)
saveRDS(BOC, "BOC_preSubmitted.230713.rds")
```

#Exclude Minor-LQ
```{r}
tmp = levels(Idents(BOC)) %>% setdiff(c("Minor","LQ"))
BOC = subset(BOC, idents = tmp)
BOC = RunUMAP(BOC, reduction = "harmony", dims = 1:30, min.dist = 1, spread = 1 )
saveRDS(BOC, "BOC_preSubmitted.QC_Cluster.230713.rds")
```
#PTGER2 Group
```{r}
BOC <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.PTGER4Group.230713.rds")
Idents(BOC) = BOC$Identity.Celltype4
DimPlot(BOC)
tmp = PTGER2.Group(BOC,Identity = "Identity.Celltype4",Batch = "Batch.scRNA" )
BOC = AddMetaData(BOC,tmp,"PTGER2.Group.Celltype4")
table(BOC$Identity.Celltype4, BOC$PTGER2.Group.Celltype4)
BOC$PTGER2.Group.Celltype4 = factor(BOC$PTGER2.Group.Celltype4, levels = c("Negative","Positive"))

```

#PTGER4 Grouping
```{r}
tmp = PTGER4.Group(BOC,Identity = "Identity.Celltype",Batch = "Batch.scRNA" )
BOC = AddMetaData(BOC,tmp,"PTGER4.Group.Celltype")
BOC$PTGER4.Group.Celltype = factor(BOC$PTGER4.Group.Celltype, levels = c("Undetected","Low","Intermediate","High"))

tmp = PTGER4.Group(BOC,Identity = "Identity.Celltype2",Batch = "Batch.scRNA" )
BOC = AddMetaData(BOC,tmp,"PTGER4.Group.Celltype2")
BOC$PTGER4.Group.Celltype2 = factor(BOC$PTGER4.Group.Celltype2, levels = c("Undetected","Low","Intermediate","High"))


tmp = PTGER4.Group(BOC,Identity = "Identity.Celltype4",Batch = "Batch.scRNA" )
BOC = AddMetaData(BOC,tmp,"PTGER4.Group.Celltype4")
BOC$PTGER4.Group.Celltype4 = factor(BOC$PTGER4.Group.Celltype4, levels = c("Undetected","Low","Intermediate","High"))

tmp = PTGER4.Group(BOC,Identity = "Identity.Subtype1",Batch = "Batch.scRNA" )
BOC = AddMetaData(BOC,tmp,"PTGER4.Group.Subtype1")
BOC$PTGER4.Group.Subtype1 = factor(BOC$PTGER4.Group.Subtype1, levels = c("Undetected","Low","Intermediate","High"))
saveRDS(BOC,"BOC.PTGER4Group.230713.rds")
#BOC = readRDS("BOC.PTGER4Group.230713.rds")
```



#DE (Bulk)
```{r}
#DE_bulk.Celltype.r
library(Seurat)
library(harmony)
library(tidyverse)
options(future.globals.maxSize = 100000 * 1024^2)

BOC = readRDS("//home/siwakorn/Human/RDS/BOC.PTGER4Group.230713.rds")

DE3 = list()
Idents(BOC) = BOC$Identity.Celltype
for(i in levels(BOC$Identity.Celltype)){
      tryCatch({
            print(i)
            DE = list()
            tmp = subset(BOC,idents = i )
            Idents(tmp) = tmp$PTGER4.Group.Celltype
            DE[["High-Low"]] = FindMarkers(tmp, ident.1 = "High", ident.2 = "Low", logfc.threshold = 0.01, min.pct = 0.01)
            DE[["High-Intermediate"]] = FindMarkers(tmp, ident.1 = "High", ident.2 = "Intermediate", logfc.threshold = 0.01, min.pct = 0.01)
            DE[["High-Undetected"]] = FindMarkers(tmp, ident.1 = "High", ident.2 = "Undetected", logfc.threshold = 0.01, min.pct = 0.01)
            tmp = RenameIdents(tmp, 'High' = "Positive",'Intermediate' = "Positive", 'Low' = "Positive",'Undetected' = "Negative")
            DE[["Positive-Negative"]] = FindMarkers(tmp, ident.1 = "Positive",ident.2 = "Negative", logfc.threshold = 0.01, min.pct = 0.01)
            DE3[[i]] = DE
      },error = function(e){print(e)})
}
saveRDS(DE3,"//home/siwakorn/Human/RDS/BOC.DE_Bulk.Celltype.230713.rds")


#DE_bulk.Celltype2.r
library(Seurat)
library(harmony)
library(tidyverse)
options(future.globals.maxSize = 100000 * 1024^2)

BOC = readRDS("//home/siwakorn/Human/RDS/BOC.PTGER4Group.230713.rds")

DE3 = list()
Idents(BOC) = BOC$Identity.Celltype2
for(i in levels(BOC$Identity.Celltype2)){
      tryCatch({
            print(i)
            DE = list()
            tmp = subset(BOC,idents = i )
            Idents(tmp) = tmp$PTGER4.Group.Celltype2
            DE[["High-Low"]] = FindMarkers(tmp, ident.1 = "High", ident.2 = "Low", logfc.threshold = 0.01, min.pct = 0.01)
            DE[["High-Intermediate"]] = FindMarkers(tmp, ident.1 = "High", ident.2 = "Intermediate", logfc.threshold = 0.01, min.pct = 0.01)
            DE[["High-Undetected"]] = FindMarkers(tmp, ident.1 = "High", ident.2 = "Undetected", logfc.threshold = 0.01, min.pct = 0.01)
            tmp = RenameIdents(tmp, 'High' = "Positive",'Intermediate' = "Positive", 'Low' = "Positive",'Undetected' = "Negative")
            DE[["Positive-Negative"]] = FindMarkers(tmp, ident.1 = "Positive",ident.2 = "Negative", logfc.threshold = 0.01, min.pct = 0.01)
            DE3[[i]] = DE
      },error = function(e){print(e)})
}
saveRDS(DE3,"//home/siwakorn/Human/RDS/BOC.DE_Bulk.Celltype2.230713.rds")

#DE_bulk.Celltype4.r
library(Seurat)
library(harmony)
library(tidyverse)
options(future.globals.maxSize = 100000 * 1024^2)

BOC = readRDS("//home/siwakorn/Human/RDS/BOC.PTGER4Group.230713.rds")

DE3 = list()
Idents(BOC) = BOC$Identity.Celltype4
for(i in levels(BOC$Identity.Celltype4)){
      tryCatch({
            print(i)
            DE = list()
            tmp = subset(BOC,idents = i )
            Idents(tmp) = tmp$PTGER4.Group.Celltype4
            DE[["High-Low"]] = FindMarkers(tmp, ident.1 = "High", ident.2 = "Low", logfc.threshold = 0.01, min.pct = 0.01)
            DE[["High-Intermediate"]] = FindMarkers(tmp, ident.1 = "High", ident.2 = "Intermediate", logfc.threshold = 0.01, min.pct = 0.01)
            DE[["High-Undetected"]] = FindMarkers(tmp, ident.1 = "High", ident.2 = "Undetected", logfc.threshold = 0.01, min.pct = 0.01)
            tmp = RenameIdents(tmp, 'High' = "Positive",'Intermediate' = "Positive", 'Low' = "Positive",'Undetected' = "Negative")
            DE[["Positive-Negative"]] = FindMarkers(tmp, ident.1 = "Positive",ident.2 = "Negative", logfc.threshold = 0.01, min.pct = 0.01)
            DE3[[i]] = DE
      },error = function(e){print(e)})
}
saveRDS(DE3,"//home/siwakorn/Human/RDS/BOC.DE_Bulk.Celltype4.230713.rds")
#DE_bulk.Subtype1.r
library(Seurat)
library(harmony)
library(tidyverse)
options(future.globals.maxSize = 100000 * 1024^2)

BOC = readRDS("//home/siwakorn/Human/RDS/BOC.PTGER4Group.230713.rds")

DE3 = list()
Idents(BOC) = BOC$Identity.Subtype1
for(i in levels(BOC$Identity.Subtype1)){
      tryCatch({
            print(i)
            DE = list()
            tmp = subset(BOC,idents = i )
            Idents(tmp) = tmp$PTGER4.Group.Subtype1
            DE[["High-Low"]] = FindMarkers(tmp, ident.1 = "High", ident.2 = "Low", logfc.threshold = 0.01, min.pct = 0.01)
            DE[["High-Intermediate"]] = FindMarkers(tmp, ident.1 = "High", ident.2 = "Intermediate", logfc.threshold = 0.01, min.pct = 0.01)
            DE[["High-Undetected"]] = FindMarkers(tmp, ident.1 = "High", ident.2 = "Undetected", logfc.threshold = 0.01, min.pct = 0.01)
            tmp = RenameIdents(tmp, 'High' = "Positive",'Intermediate' = "Positive", 'Low' = "Positive",'Undetected' = "Negative")
            DE[["Positive-Negative"]] = FindMarkers(tmp, ident.1 = "Positive",ident.2 = "Negative", logfc.threshold = 0.01, min.pct = 0.01)
            DE3[[i]] = DE
      },error = function(e){print(e)})
}
saveRDS(DE3,"//home/siwakorn/Human/RDS/BOC.DE_Bulk.Subtype1.230713.rds")
```

#DE (Per specimen)
```{r}
#DE_specimen.Celltype.r
library(Seurat)
library(harmony)
library(tidyverse)
options(future.globals.maxSize = 100000 * 1024^2)

FullDE <- function(Obj,Group = "PTGER4.Group.Celltype2", Batch = "ID",A = "High", B = "Low"){
      DE = list()
      Idents(Obj) = Batch
      for(i in unique(Obj[[]][,Batch]) ){
            tmp = subset(Obj, idents = i)
            print(paste0(i," : ", ncol(tmp), " Cells"))
            tryCatch({
                  Idents(tmp) = Group
                  DE[[i]] = FindMarkers(tmp,ident.1 = A, ident.2 = B, logfc.threshold = 0,min.pct =0.01 )
            }, error = function(e){print(e)})
      }
      #Sum table
      df = data.frame()
      for(i in names(DE) ){
            tmp = DE[[i]] %>% as_tibble(rownames = "Genes") %>% dplyr::select(Genes, avg_log2FC)
            tmp$Datasets = i
            df = rbind(df,tmp)
      }
      df = spread(df, Genes, avg_log2FC) %>% as.data.frame()
      rownames(df) = df$Datasets
      df = dplyr::select(df,-Datasets)
      df2 = matrix(nrow = ncol(df),ncol=0) %>% data.frame()
      rownames(df2) = colnames(df)
      df2$Upregulation = "NA"
      df2$Downregulation = "NA"
      for(i in colnames(df)){
            tmp = df[,i] > 0 
            df2[i,"Upregulation"] = sum(tmp)
            tmp = df[,i] < 0 
            df2[i,"Downregulation"] = sum(tmp)
      }
      df2$Upregulation = as.numeric(df2$Upregulation)
      df2$Downregulation = as.numeric(df2$Downregulation)
      DE[["FoldChange.Table"]] = df
      DE[["FoldChange.Sum"]] = df2
      return(DE)
}

BOC = readRDS("//home/siwakorn/Human/RDS/BOC.PTGER4Group.230713.rds")

DE = list()
Idents(BOC) = BOC$Identity.Celltype
for(i in levels(Idents(BOC)) ){
      print(i)
      tmp = subset(BOC, idents = i)
      DE[[i]] = FullDE(tmp, Group = "PTGER4.Group.Celltype", Batch = "Batch.scRNA")
      saveRDS(DE,"//home/siwakorn/Human/RDS/BOC.DE_Specimen.Celltype.230713.rds")
      
}

saveRDS(DE,"//home/siwakorn/Human/RDS/BOC.DE_Specimen.Celltype.230713.rds")

#DE_specimen.Celltype2.r
library(Seurat)
library(harmony)
library(tidyverse)
options(future.globals.maxSize = 100000 * 1024^2)

FullDE <- function(Obj,Group = "PTGER4.Group.Celltype2", Batch = "ID",A = "High", B = "Low"){
      DE = list()
      Idents(Obj) = Batch
      for(i in unique(Obj[[]][,Batch]) ){
            tmp = subset(Obj, idents = i)
            print(paste0(i," : ", ncol(tmp), " Cells"))
            tryCatch({
                  Idents(tmp) = Group
                  DE[[i]] = FindMarkers(tmp,ident.1 = A, ident.2 = B, logfc.threshold = 0,min.pct =0.01 )
            }, error = function(e){print(e)})
      }
      #Sum table
      df = data.frame()
      for(i in names(DE) ){
            tmp = DE[[i]] %>% as_tibble(rownames = "Genes") %>% dplyr::select(Genes, avg_log2FC)
            tmp$Datasets = i
            df = rbind(df,tmp)
      }
      df = spread(df, Genes, avg_log2FC) %>% as.data.frame()
      rownames(df) = df$Datasets
      df = dplyr::select(df,-Datasets)
      df2 = matrix(nrow = ncol(df),ncol=0) %>% data.frame()
      rownames(df2) = colnames(df)
      df2$Upregulation = "NA"
      df2$Downregulation = "NA"
      for(i in colnames(df)){
            tmp = df[,i] > 0 
            df2[i,"Upregulation"] = sum(tmp)
            tmp = df[,i] < 0 
            df2[i,"Downregulation"] = sum(tmp)
      }
      df2$Upregulation = as.numeric(df2$Upregulation)
      df2$Downregulation = as.numeric(df2$Downregulation)
      DE[["FoldChange.Table"]] = df
      DE[["FoldChange.Sum"]] = df2
      return(DE)
}

BOC = readRDS("//home/siwakorn/Human/RDS/BOC.PTGER4Group.230713.rds")

DE = list()
Idents(BOC) = BOC$Identity.Celltype2
for(i in levels(Idents(BOC)) ){
      print(i)
      tmp = subset(BOC, idents = i)
      DE[[i]] = FullDE(tmp, Group = "PTGER4.Group.Celltype2", Batch = "Batch.scRNA")
      saveRDS(DE,"//home/siwakorn/Human/RDS/BOC.DE_Specimen.Celltype2.230713.rds")
      
}

saveRDS(DE,"//home/siwakorn/Human/RDS/BOC.DE_Specimen.Celltype2.230713.rds")
#DE_specimen.Celltype4.r
library(Seurat)
library(harmony)
library(tidyverse)
options(future.globals.maxSize = 100000 * 1024^2)

FullDE <- function(Obj,Group = "PTGER4.Group.Celltype2", Batch = "ID",A = "High", B = "Low"){
      DE = list()
      Idents(Obj) = Batch
      for(i in unique(Obj[[]][,Batch]) ){
            tmp = subset(Obj, idents = i)
            print(paste0(i," : ", ncol(tmp), " Cells"))
            tryCatch({
                  Idents(tmp) = Group
                  DE[[i]] = FindMarkers(tmp,ident.1 = A, ident.2 = B, logfc.threshold = 0,min.pct =0.01 )
            }, error = function(e){print(e)})
      }
      #Sum table
      df = data.frame()
      for(i in names(DE) ){
            tmp = DE[[i]] %>% as_tibble(rownames = "Genes") %>% dplyr::select(Genes, avg_log2FC)
            tmp$Datasets = i
            df = rbind(df,tmp)
      }
      df = spread(df, Genes, avg_log2FC) %>% as.data.frame()
      rownames(df) = df$Datasets
      df = dplyr::select(df,-Datasets)
      df2 = matrix(nrow = ncol(df),ncol=0) %>% data.frame()
      rownames(df2) = colnames(df)
      df2$Upregulation = "NA"
      df2$Downregulation = "NA"
      for(i in colnames(df)){
            tmp = df[,i] > 0 
            df2[i,"Upregulation"] = sum(tmp)
            tmp = df[,i] < 0 
            df2[i,"Downregulation"] = sum(tmp)
      }
      df2$Upregulation = as.numeric(df2$Upregulation)
      df2$Downregulation = as.numeric(df2$Downregulation)
      DE[["FoldChange.Table"]] = df
      DE[["FoldChange.Sum"]] = df2
      return(DE)
}

BOC = readRDS("//home/siwakorn/Human/RDS/BOC.PTGER4Group.230713.rds")

DE = list()
Idents(BOC) = BOC$Identity.Celltype4
for(i in levels(Idents(BOC)) ){
      print(i)
      tmp = subset(BOC, idents = i)
      DE[[i]] = FullDE(tmp, Group = "PTGER4.Group.Celltype4", Batch = "Batch.scRNA")
      saveRDS(DE,"//home/siwakorn/Human/RDS/BOC.DE_Specimen.Celltype4.230713.rds")
      
}

saveRDS(DE,"//home/siwakorn/Human/RDS/BOC.DE_Specimen.Celltype4.230713.rds")
#DE_specimen.Subtype1.r
library(Seurat)
library(harmony)
library(tidyverse)
options(future.globals.maxSize = 100000 * 1024^2)

FullDE <- function(Obj,Group = "PTGER4.Group.Celltype2", Batch = "ID",A = "High", B = "Low"){
      DE = list()
      Idents(Obj) = Batch
      for(i in unique(Obj[[]][,Batch]) ){
            tmp = subset(Obj, idents = i)
            print(paste0(i," : ", ncol(tmp), " Cells"))
            tryCatch({
                  Idents(tmp) = Group
                  DE[[i]] = FindMarkers(tmp,ident.1 = A, ident.2 = B, logfc.threshold = 0,min.pct =0.01 )
            }, error = function(e){print(e)})
      }
      #Sum table
      df = data.frame()
      for(i in names(DE) ){
            tmp = DE[[i]] %>% as_tibble(rownames = "Genes") %>% dplyr::select(Genes, avg_log2FC)
            tmp$Datasets = i
            df = rbind(df,tmp)
      }
      df = spread(df, Genes, avg_log2FC) %>% as.data.frame()
      rownames(df) = df$Datasets
      df = dplyr::select(df,-Datasets)
      df2 = matrix(nrow = ncol(df),ncol=0) %>% data.frame()
      rownames(df2) = colnames(df)
      df2$Upregulation = "NA"
      df2$Downregulation = "NA"
      for(i in colnames(df)){
            tmp = df[,i] > 0 
            df2[i,"Upregulation"] = sum(tmp)
            tmp = df[,i] < 0 
            df2[i,"Downregulation"] = sum(tmp)
      }
      df2$Upregulation = as.numeric(df2$Upregulation)
      df2$Downregulation = as.numeric(df2$Downregulation)
      DE[["FoldChange.Table"]] = df
      DE[["FoldChange.Sum"]] = df2
      return(DE)
}

BOC = readRDS("//home/siwakorn/Human/RDS/BOC.PTGER4Group.230713.rds")

DE = list()
Idents(BOC) = BOC$Identity.Celltype4
for(i in levels(Idents(BOC)) ){
      print(i)
      tmp = subset(BOC, idents = i)
      DE[[i]] = FullDE(tmp, Group = "PTGER4.Group.Celltype4", Batch = "Batch.scRNA")
      saveRDS(DE,"//home/siwakorn/Human/RDS/BOC.DE_Specimen.Celltype4.230713.rds")
      
}

saveRDS(DE,"//home/siwakorn/Human/RDS/BOC.DE_Specimen.Celltype4.230713.rds")
```



#DE Table Conversion to df and GSEA
##Bulk (Celltype)
```{r}
#DE <- readRDS("~/RStudioProject/scRNA/BOC.DE_Bulk.Celltype.230713.rds")
DE <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype.230713.rds")
df = data.frame()
for(i in names(DE)){
  tmp = names(DE[[i]]) 
  for(j in tmp ){
      df1 = DE[[i]][[j]] %>% as_tibble(rownames = "Genes")
      df1$Cluster = i
      df1$Condition = j
      df = rbind(df,df1)
      }
}

###GSEA
GSEA = list()
GSEA_H = list()
for(i in names(DE)[1:8] ){
  tmp = DE[[i]][["High-Low"]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC)
  GSEA[[i]] <- fgsea(fgsea_sets, stats = deframe(tmp), nperm = 50000) %>% as_tibble() %>% arrange(desc(NES) )
  GSEA_H[[i]] <- fgsea(fgsea_sets_H, stats = deframe(tmp), nperm = 50000) %>% as_tibble() %>% arrange(desc(NES) )
}
DE$GSEA = GSEA
DE$GSEA_H = GSEA_H


###GSEA p < 0.05
GSEA = list()
GSEA_H = list()
for(i in names(DE)[1:8] ){
  tmp = DE[[i]][["High-Low"]] %>% as_tibble(rownames = "Genes" ) %>% filter(p_val < 0.05) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC)
  GSEA[[i]] <- fgsea(fgsea_sets, stats = deframe(tmp), nperm = 50000) %>% as_tibble() %>% arrange(desc(NES) )
  GSEA_H[[i]] <- fgsea(fgsea_sets_H, stats = deframe(tmp), nperm = 50000) %>% as_tibble() %>% arrange(desc(NES) )
}
DE$GSEA_p05 = GSEA
DE$GSEA_H_p05 = GSEA_H

###GSEA Adj pval < 0.05
GSEA = list()
GSEA_H = list()
for(i in names(DE)[1:8] ){
  tmp = DE[[i]][["High-Low"]] %>% as_tibble(rownames = "Genes" ) %>% filter(p_val_adj < 0.05) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC)
  GSEA[[i]] <- fgsea(fgsea_sets, stats = deframe(tmp), nperm = 50000) %>% as_tibble() %>% arrange(desc(NES) )
  GSEA_H[[i]] <- fgsea(fgsea_sets_H, stats = deframe(tmp), nperm = 50000) %>% as_tibble() %>% arrange(desc(NES) )
}
DE$GSEA_padj05 = GSEA
DE$GSEA_H_padj05 = GSEA_H

###GSEA Multilevel
GSEA = list()
GSEA_H = list()
for(i in names(DE)[1:8] ){
  tmp = DE[[i]][["High-Low"]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC)
  GSEA[[i]] <- fgseaMultilevel(fgsea_sets, stats = deframe(tmp) ) %>% arrange(desc(NES) )
  GSEA_H[[i]] <- fgseaMultilevel(fgsea_sets_H, stats = deframe(tmp) ) %>% arrange(desc(NES) )
}
DE$GSEA2 = GSEA
DE$GSEA_H2 = GSEA_H

DE$df.HighLow = filter(df, Condition == "High-Low")
DE$df.HighInt = filter(df, Condition == "High-Intermediate")
DE$df.HighUndetected= filter(df, Condition == "High-Undetected")
DE$df.PosNeg = filter(df, Condition == "Positive-Negative")

#saveRDS(DE,"~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype.Converted.GSEA_nperm50K.2300901.rds")
DE = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype.Converted.GSEA_nperm50K.2300901.rds")
```
###Check
```{r}

selected.pathway = c("HALLMARK_TNFA_SIGNALING_VIA_NFKB","HALLMARK_INFLAMMATORY_RESPONSE" ,"HALLMARK_OXIDATIVE_PHOSPHORYLATION","HALLMARK_MYC_TARGETS_V1","HALLMARK_INTERFERON_GAMMA_RESPONSE","HALLMARK_IL2_STAT5_SIGNALING",
                     "MOOTHA_GLYCOLYSIS","MOOTHA_PGC","REACTOME_GLYCOLYSIS","WP_MITOCHONDRIAL_COMPLEX_I_ASSEMBLY_MODEL_OXPHOS_SYSTEM","WP_MITOCHONDRIAL_COMPLEX_II_ASSEMBLY","WP_MITOCHONDRIAL_COMPLEX_III_ASSEMBLY","WP_MITOCHONDRIAL_COMPLEX_IV_ASSEMBLY","GOCC_PROTON_TRANSPORTING_ATP_SYNTHASE_COMPLEX")
DE$GSEA2$T_CD8 %>% filter(pathway %in% selected.pathway)
DE$GSEA2$TIM %>% filter(pathway %in% selected.pathway)

```


##Bulk (Celltype4)
```{r}
DE <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype4.230713.rds")
df = data.frame()
for(i in names(DE)){
  tmp = names(DE[[i]]) 
  for(j in tmp ){
      df1 = DE[[i]][[j]] %>% as_tibble(rownames = "Genes")
      df1$Cluster = i
      df1$Condition = j
      df = rbind(df,df1)
      }
}
DE$df.HighLow = filter(df, Condition == "High-Low")
DE$df.HighInt = filter(df, Condition == "High-Intermediate")
DE$df.HighUndetected= filter(df, Condition == "High-Undetected")
DE$df.PosNeg = filter(df, Condition == "Positive-Negative")

GSEA = list()
###GSEA
for(i in names(DE)){
  print(i)
  tmp = DE[[i]][["High-Low"]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC)
  ranks<- deframe(tmp)
  fgseaRes1 <- fgsea(fgsea_sets_H, stats = ranks, nperm = 1000)
  tmp1 = fgseaRes1 %>% as_tibble() %>% arrange(desc(NES) ) #%>% filter(padj < 0.05)
  fgseaRes1 <- fgsea(fgsea_sets_c2, stats = ranks, nperm = 1000)
  tmp2 = fgseaRes1 %>% as_tibble() %>% arrange(desc(NES) ) #%>% filter(padj < 0.05)
  GSEA[[i]] = rbind(tmp1,tmp2) %>% arrange(desc(NES) )
}
DE$GSEA = GSEA
#saveRDS(DE,"~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype4.230713.Converted.rds")
DE = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype4.230713.Converted.rds")
DE = readRDS("~/RStudioProject/scRNA/BOC.DE_Bulk.Celltype4.230713.Converted.rds")
```

##Per Specimen Celltype
```{r}
DE2 <- readRDS("BOC.DE_Specimen.Celltype.230713.rds")
df = data.frame()
for(i in names(DE2)){
  tmp = names(DE2[[i]]) %>% setdiff(c("FoldChange.Table","FoldChange.Sum"))
  for(j in tmp ){
      df1 = DE2[[i]][[j]] %>% as_tibble(rownames = "Genes")
      df1$Cluster = i
      df1$Dataset = j
      df = rbind(df,df1)
      }
}
df$Cluster = factor(df$Cluster, levels= names(DE2) )
DE2$df = df
GSEA = list()
for(j in c("T_CD8","TIM")){
  tmp1 = setdiff(names(DE2[[j]] ),c("FoldChange.Table", "FoldChange.Sum"))
  df = data.frame()
  for(i in tmp1){
    tmp = DE2[[j]][[i]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC)
    ranks<- deframe(tmp)
    fgseaRes1 <- fgsea(fgsea_sets, stats = ranks, nperm = 1000)
    df1 = fgseaRes1 %>% arrange(NES)
    df1$Dataset = i
    df = rbind(df,df1)
  }
  df$Cluster = j
  GSEA[[j]] = df
}
DE2$GSEA = GSEA
saveRDS(DE2,"~/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.converted.rds")
```

##Per Specimen Celltype4
```{r}
DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype4.230713.rds")
df = data.frame()
for(i in names(DE2)){
  tmp = names(DE2[[i]]) %>% setdiff(c("FoldChange.Table","FoldChange.Sum"))
  for(j in tmp ){
      df1 = DE2[[i]][[j]] %>% as_tibble(rownames = "Genes")
      df1$Cluster = i
      df1$Dataset = j
      df = rbind(df,df1)
      }
}
df$Cluster = factor(df$Cluster, levels= names(DE2) )
DE2$df = df

GSEA = list()
for(j in c("T_CD8","TIM")){
  tmp1 = setdiff(names(DE2[[j]] ),c("FoldChange.Table", "FoldChange.Sum"))
  df = data.frame()
  for(i in tmp1){
    tmp = DE2[[j]][[i]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC)
    ranks<- deframe(tmp)
    fgseaRes1 <- fgsea(fgsea_sets, stats = ranks, nperm = 1000)
    df1 = fgseaRes1 %>% arrange(NES)
    df1$Dataset = i
    df = rbind(df,df1)
  }
  df$Cluster = j
  GSEA[[j]] = df
}
DE2$GSEA = GSEA
#saveRDS(DE2,"~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype4.230713.converted.rds")
DE2 = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype4.230713.converted.rds")
```

##Per Specimen Subtype1
```{r}
DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Subtype1.230713.rds")
DE2$
df = data.frame()
for(i in names(DE2)[c(3:5,11)]){
  tmp = names(DE2[[i]]) %>% setdiff(c("FoldChange.Table","FoldChange.Sum"))
  for(j in tmp ){
      df1 = DE2[[i]][[j]] %>% as_tibble(rownames = "Genes")
      df1$Cluster = i
      df1$Dataset = j
      df = rbind(df,df1)
      }
}
df$Cluster = factor(df$Cluster, levels = names(DE2))
DE2$df.CD8 = df

df = data.frame()
for(i in names(DE2)[19:22] ){
  tmp = names(DE2[[i]]) %>% setdiff(c("FoldChange.Table","FoldChange.Sum"))
  for(j in tmp ){
      df1 = DE2[[i]][[j]] %>% as_tibble(rownames = "Genes")
      df1$Cluster = i
      df1$Dataset = j
      df = rbind(df,df1)
      }
}
df$Cluster = factor(df$Cluster, levels = names(DE2))
DE2$df.TIM = df
#saveRDS(DE2,"~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Subtype1.230713.converted.rds")
```

#PLOT: DE
###GSEA | NES (color)
```{r}
GSEA = DE$GSEA
selected.pathway = c("Interferon","Oxidative","Cebp")
df = data.frame()
for(p in selected.pathway){
  for(i in names(GSEA)){
    tmp1 = GSEA[[i]][grep(p,GSEA[[i]]$pathway, ignore.case = T),]
    tmp1$Cluster = i
    tmp1$pw = p
    df = rbind(df,tmp1)
  }
}
df1 = df %>% dplyr::select(pw,pathway,pval,padj,NES,Cluster)
df1$Cluster = factor(df1$Cluster, levels = names(GSEA)) 
for(i in 1){
  df1$p_val_cat = df1$pval
  df1$p_val_cat[df1$pval > 0.05 ] = ">0.05"
  df1$p_val_cat[df1$pval < 0.05 ] = "<0.05"
  df1$p_val_cat[df1$pval < 0.01 ] = "<0.01"
  df1$p_val_cat[df1$pval < 0.001 ] = "<0.001"
  df1$p_val_cat = factor(df1$p_val_cat, levels = c(">0.05","<0.05","<0.01","<0.001"))
  PNG("BOC.Bulk.GSEA",w= c(5 + (length(unique(df1$pathway)))*0.3),h=14)
  print(
    ggplot(df1,aes(x = pathway, y = fct_rev(Cluster) )) + 
  geom_point(aes(color = NES, size = p_val_cat) ) + 
  facet_grid(. ~ pw, scales = "free", space="free", switch = "y")+
  scale_size_manual(values = c(4,6,8,10)) + 
  scale_color_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(df1$NES),-0.7,0,0.7,max(df1$NES)) ), name = "NES")+ 
  theme_classic() + 
  theme(plot.title = element_text(size =20, face = "bold",color = "black"),
                        axis.title = element_blank(), 
                        axis.text.x = element_text(size =11,angle = 90,color = "black",hjust=1),
                        axis.text.y = element_text(size =11, face = "bold", color = "black"),
                        strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.text.x.top = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "bottom"
                        )
  
  )
  
  dev.off()
}
```

#####selected candiates
```{r}
selected.pathway = c("GERY_CEBP_TARGETS","HALMOS_CEBPA_TARGETS_UP","TAVOR_CEBPA_TARGETS_UP",
                     "HALLMARK_INTERFERON_ALPHA_RESPONSE","BROWNE_INTERFERON_RESPONSIVE_GENES",
                     "REACTOME_INTERFERON_ALPHA_BETA_SIGNALING","WP_INTERFERON_TYPE_I_SIGNALING_PATHWAYS",
                     "HALLMARK_INTERFERON_GAMMA_RESPONSE","REACTOME_INTERFERON_GAMMA_SIGNALING","WP_TYPE_II_INTERFERON_SIGNALING_IFNG",
                     "REACTOME_INTERFERON_SIGNALING","ZHANG_INTERFERON_RESPONSE",
                     "KEGG_OXIDATIVE_PHOSPHORYLATION","HALLMARK_OXIDATIVE_PHOSPHORYLATION","WP_OXIDATIVE_PHOSPHORYLATION"  )
selected.pathway = c("WP_AEROBIC_GLYCOLYSIS","MOOTHA_GLYCOLYSIS","REACTOME_GLYCOLYSIS")

df1 = filter(df, pathway %in% selected.pathway) %>% dplyr::select(pw,pathway,pval,padj,NES,Cluster)
df1$Cluster = factor(df1$Cluster, levels = names(GSEA)) 
for(i in 1){
  df1$p_val_cat = df1$pval
  df1$p_val_cat[df1$pval > 0.05 ] = ">0.05"
  df1$p_val_cat[df1$pval < 0.05 ] = "<0.05"
  df1$p_val_cat[df1$pval < 0.01 ] = "<0.01"
  df1$p_val_cat[df1$pval < 0.001 ] = "<0.001"
  df1$p_val_cat = factor(df1$p_val_cat, levels = c(">0.05","<0.05","<0.01","<0.001"))
  PNG("BOC.Bulk.GSEA.candidates",w= c(3 + (length(unique(df1$pathway)))*0.3),h=9)
  print(
    ggplot(df1,aes(x = pathway, y = fct_rev(Cluster) )) + 
  geom_point(aes(color = NES, size = p_val_cat) ) + 
  facet_grid(. ~ pw, scales = "free", space="free", switch = "y")+
  scale_size_manual(values = c(4,6,8,10)) + 
  scale_color_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(df1$NES),-0.7,0,0.7,max(df1$NES)) ), name = "NES")+ 
  theme_classic() + 
  theme(plot.title = element_text(size =20, face = "bold",color = "black"),
                        axis.title = element_blank(), 
                        axis.text.x = element_text(size =11,angle = 90,color = "black",hjust=1),
                        axis.text.y = element_text(size =11, face = "bold", color = "black"),
                        strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.text.x.top = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "bottom"
                        )
  
  )
  
  dev.off()
}
```

###GSEA | Table
```{r}
for(i in c("T_CD8","TIM")){
    tmp1 = DE[[i]][["High-Low"]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC)
    tmp1 = deframe(tmp1)
    PNG(paste0("BOC.Bulk.GSEA.Table.",i),w=9,h=7)
      print(plotGseaTable(pathways = fgsea_sets[selected.pathway],tmp1, GSEA[[i]],gseaParam = 0.3 ) )
  dev.off()
}
```

###GSEA | Running Plot
```{r}
DE <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype.Converted.GSEA_nperm50K.230821.rds")
selected.pathway = c("MOOTHA_PGC","HALLMARK_TNFA_SIGNALING_VIA_NFKB","HALLMARK_INFLAMMATORY_RESPONSE" ,"HALLMARK_OXIDATIVE_PHOSPHORYLATION","HALLMARK_MYC_TARGETS_V1","HALLMARK_INTERFERON_GAMMA_RESPONSE" )
selected.pathway = c("MOOTHA_PGC")
GSEA$T_CD8 %>% filter(pathway %in% selected.pathway)
GSEA$T_CD8 
GSEA = DE$GSEA
for(i in c("T_CD8","TIM")){
  tmp1 = DE[[i]][["High-Low"]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC)
  tmp2 = GSEA[[i]] %>% as.data.frame()
  rownames(tmp2) = tmp2$pathway
  ranks = deframe(tmp1)
  for(p in selected.pathway){
    tmp3 = paste0("NES = ",tmp2[p,"NES"],"\n p-value = ", tmp2[p,"pval"],"\n adjusted p-value = ", tmp2[p,"padj"])
    tmp = plotEnrichment(fgsea_sets[[p]], ranks,0.5,0.3  ) + 
      ggtitle(paste0(i," | ", p)) + 
      labs(subtitle = tmp3) +
      theme(title = element_text(size=5))
    tmp$layers[[5]]$aes_params$colour <- 'firebrick'
    PNG(paste0("Temporary.BOC.Bulk.Celltype.GSEAPlot.",i,".",p),w=5,h=3)
    #print(tmp  +  annotate("text", x=10, y=(tmp2[p,"NES"])/5, label= tmp3,size =2,hjust=0) )
    print(tmp)
    dev.off()
  }
}
```

###GSEA | NES (x position)
```{r}
DE2 = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype4.230713.converted.rds")
selected.pathway = names(fgsea_sets)[grep("aspartate", names(fgsea_sets), ignore.case = T)]

selected.pathway = c("HALLMARK_FATTY_ACID_METABOLISM" ,"REACTOME_FATTY_ACIDS","REACTOME_MITOCHONDRIAL_FATTY_ACID_BETA_OXIDATION","WP_FATTY_ACID_TRANSPORTERS","WP_FATTY_ACID_BETAOXIDATION","BIOCARTA_MALATEX_PATHWAY")
selected.genes = sort(unique(unlist(fgsea_sets[selected.pathway])))
GeneSet$DE$FattyMetabolism = selected.genes
for(c in c("T_CD8","TIM")){
  df = DE2$GSEA[[c]]
  df1 = filter(df, pathway %in% selected.pathway )
  df1$padj_cat = ">0.05"
  df1$padj_cat[c(df1$padj<0.05)] = "<0.05"
  plot1 = df1 |> ggplot(aes(y = fct_rev(Dataset))) + 
    geom_point(shape = 18,size =3,aes(x = NES)) +
    geom_vline(xintercept = 0 ,linetype="dotdash", )+
    xlim(-2.5,2.5)+
    theme_classic() +
    facet_grid(.~pathway) +
    ylab("Dataset")+
    theme(axis.text = element_text(color = "black"),
        panel.border = element_rect(color = "black", fill = NA, size =1))
  for(i in 1){
    PNG(paste0("BOC.CD45.",c,".GSEAperSpecimen.Fatty"), h = 4, w = 30, r=200)
    print(plot1)
    dev.off()
  }
}

```


##GSEA | by GGGSEA
```{r}
library(gggsea)
DE <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype.Converted.GSEA_nperm50K.230821.rds")
tmp1  = DE[["T_CD8"]][["High-Low"]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(desc(avg_log2FC))
ranks = deframe(tmp1)
tmp2 = list("Mootha_Glycolysis" =fgsea_sets$MOOTHA_GLYCOLYSIS )
df <- gseaCurve(ranks, tmp2)
ggplot2::ggplot() +   geom_gsea(df)
```

#PLOT: Heatmap
##Bulk (Celltype4)
```{r}
DE <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype4.230713.Converted.rds")
DE <- readRDS("~/RStudioProject/scRNA/BOC.DE_Bulk.Celltype4.230713.Converted.rds")
df = DE$df.HighLow

selected.cluster = c("NK","T_CD8","T_CD4","TIM","DC")
GeneSet$DE$Common
GeneSet$DE$tmp = c("NDUFA5","NDUFA6","NDUFA7","COX4I1","COX5A","COX6B1","ATP5MC1","ATP5MC2","ATP5PD" )
for(i in c("tmp") ){
  selected.genes = unlist( GeneSet$DE[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes )  %>% filter(Cluster %in% selected.cluster)
  df1$Cluster = factor(df1$Cluster, levels = selected.cluster)
  df1$Genes = factor(df1$Genes, levels = selected.genes  )
  df1$p_val_cat = df1$p_val
  df1$p_val_cat[df1$p_val > 0.05 ] = ">0.05"
  df1$p_val_cat[df1$p_val < 0.05 ] = "<0.05"
  df1$p_val_cat[df1$p_val < 0.01 ] = "<0.01"
  df1$p_val_cat[df1$p_val < 0.001 ] = "<0.001"
  df1$p_val_cat = factor(df1$p_val_cat, levels = c(">0.05","<0.05","<0.01","<0.001"))
  if( class(GeneSet$DE[[i]]) == "list"){
    tmp = data.frame(matrix(ncol = (ncol(df1)+1), nrow = 0))
    colnames(tmp) = c(colnames(df1),"Set")
    for(j in names(GeneSet$DE[[i]])){
      tmp1 = filter(df1, Genes %in% GeneSet$DE[[i]][[j]] ) %>% filter(!Genes %in% tmp[,1])
      tmp1$Set = j
      tmp = rbind(tmp,tmp1)
    }
    tmp$Set = factor(tmp$Set, levels = names(GeneSet$DE[[i]]))
    df1 = tmp
    plot = ggplot(df1, aes(y = fct_rev(Cluster), x = Genes  ) ) + facet_grid(. ~ Set, scales = "free", space="free", switch = "y") 
                  
  } else {
    plot = ggplot(df1, aes(y = fct_rev(Cluster), x = Genes  ) ) + facet_grid(. ~ . , scales = "free", space="free", switch = "y") 
  }
  plot = plot + theme_bw() + Dot_axis90A + ggtitle(i)+
                  geom_tile(color = "white",aes(fill =avg_log2FC)) +  scale_fill_gradientn(colours = Col.BW , values = scales::rescale(c(min(df1$avg_log2FC),-0.1,0,0.1,max(df1$avg_log2FC)) ))+
                  #geom_tile(color = "white",aes(fill =avg_log2FC)) +  scale_fill_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(df1$avg_log2FC),-0.1,0,0.1,max(df1$avg_log2FC)) ))+
                  #geom_point(aes(color = avg_log2FC, size = p_val_cat))+scale_size_manual(values = c(4,6,8,10)) + scale_color_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(df1$avg_log2FC),-0.6,0,0.6,max(df1$avg_log2FC)) ), name = "Average\nLog2 FoldChange")+ 
                  theme(plot.title = element_text(size =20, face = "bold",color = "black"),
                        axis.title = element_blank(), 
                        axis.text.x = element_text(size =16 ),
                        axis.text.y = element_text(size =16, color = "black"),
                        strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.text.x.top = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "bottom"
                        )
                
  PNG(paste0("BOC.DE.Heatmap.Celltype4.BW.",i), h = 3.5, w = c(1.5 + (length(unique(df1$Genes))*0.3) ))
  print(plot)
  dev.off()
}
```

##Per specimen (Celltype)

```{r}
#DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype4.230713.converted.rds")
DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.converted.rds")
df = DE2$df
selected.cluster = c("NK","T_CD8","T_CD4","T_CD4_FOXP3","TIM","DC")
GeneSet$DE$PGC = fgsea_sets$MOOTHA_PGC
for(i in c("PGC") ){
  selected.genes = unlist( GeneSet$DE[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes )  %>% filter(Cluster %in% selected.cluster)
  df1$Genes = factor(df1$Genes, levels = selected.genes  )
  df1$p_val_cat = df1$p_val
  df1$p_val_cat[df1$p_val > 0.05 ] = ">0.05"
  df1$p_val_cat[df1$p_val < 0.05 ] = "<0.05"
  df1$p_val_cat[df1$p_val < 0.01 ] = "<0.01"
  df1$p_val_cat[df1$p_val < 0.001 ] = "<0.001"
  df1$p_val_cat = factor(df1$p_val_cat, levels = c(">0.05","<0.05","<0.01","<0.001"))
  if( class(GeneSet$DE[[i]]) == "list"){
    tmp = data.frame(matrix(ncol = (ncol(df1)+1), nrow = 0))
    colnames(tmp) = c(colnames(df1),"Set")
    for(j in names(GeneSet$DE[[i]])){
      tmp1 = filter(df1, Genes %in% GeneSet$DE[[i]][[j]] ) %>% filter(!Genes %in% tmp[,1])
      tmp1$Set = j
      tmp = rbind(tmp,tmp1)
    }
    tmp$Set = factor(tmp$Set, levels = names(GeneSet$DE[[i]]))
    df1 = tmp
    plot = ggplot(df1, aes(y = Dataset , x = Genes  ) ) + facet_grid(Cluster ~ Set, scales = "free", space="free", switch = "y") 
                  
  } else {
    plot = ggplot(df1, aes(y = Dataset , x = Genes  ) ) + facet_grid(Cluster ~ . , scales = "free", space="free", switch = "y") 
  }
  plot = plot + theme_bw() + Dot_axis90A + ggtitle(i)+
                  geom_tile(color = "white",aes(fill =avg_log2FC)) +  scale_fill_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(df1$avg_log2FC),-0.1,0,0.1,max(df1$avg_log2FC)) ))+
                  #geom_point(aes(color = avg_log2FC, size = p_val_cat))+scale_size_manual(values = c(4,6,8,10)) + scale_color_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(df1$avg_log2FC),-0.2,0,0.2,max(df1$avg_log2FC)) ), name = "Average\nLog2 FoldChange")+ 
                  theme(plot.title = element_text(size =20, face = "bold",color = "black"),
                        axis.title = element_blank(), 
                        axis.text.x = element_text(size =16, face = "bold"),
                        axis.text.y = element_text(size =16, face = "bold", color = "black"),
                        strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.text.x.top = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "bottom"
                        )
                
  PNG(paste0("Temporary.BOC.DE.perSpec.Heatmap.Celltype.",i), h = 30, w = c(3.5 + (length(unique(df1$Genes))*0.3) ))
  print(plot)
  dev.off()
}

```

#PLOT: Volcano
```{r}
tmp3 = DE2[[i]] %>% arrange(desc(avg_log2FC)) %>% as_tibble(rownames = "Genes") %>% filter(!Genes == "PTGER4")
#tmp3A = filter(tmp3, Genes %in% fgsea_sets_H$HALLMARK_OXIDATIVE_PHOSPHORYLATION)
#tmp3B = filter(tmp3, !Genes %in% fgsea_sets_H$HALLMARK_OXIDATIVE_PHOSPHORYLATION)
tmp3A = filter(tmp3, Genes %in% fgsea_sets_H$HALLMARK_INFLAMMATORY_RESPONSE)
tmp3B = filter(tmp3, !Genes %in% fgsea_sets_H$HALLMARK_INFLAMMATORY_RESPONSE)
tmp3A$Pathway = "selected"
tmp3B$Pathway = "Other"
tmp3 = rbind(tmp3A,tmp3B)

tmp3$logp = log10(tmp3$p_val_adj )
tmp3$logp = tmp3$logp*(-1) 
ggplot(tmp3, aes(x=avg_log2FC, y = logp)) + 
  geom_point(aes(color = Pathway,size = Pathway)) +
  scale_color_manual(values = c("black","red")) + 
  scale_size_manual(values = c(0.2,1))
tmp1

tmp3 = BOCDF$DE.HU[[i]] %>% arrange(desc(avg_log2FC)) %>% as_tibble(rownames = "Genes") %>% filter(!Genes == "PTGER4")
tmp3A = filter(tmp3, Genes %in% fgsea_sets_H$HALLMARK_OXIDATIVE_PHOSPHORYLATION)
tmp3B = filter(tmp3, !Genes %in% fgsea_sets_H$HALLMARK_OXIDATIVE_PHOSPHORYLATION)
#tmp3A = filter(tmp3, Genes %in% fgsea_sets_H$HALLMARK_INFLAMMATORY_RESPONSE)
#tmp3B = filter(tmp3, !Genes %in% fgsea_sets_H$HALLMARK_INFLAMMATORY_RESPONSE)
tmp3A$Pathway = "selected"
tmp3B$Pathway = "Other"
tmp3 = rbind(tmp3A,tmp3B)

tmp3$logp = log10(tmp3$p_val_adj )
tmp3$logp = tmp3$logp*(-1) 
ggplot(tmp3, aes(x=avg_log2FC, y = logp)) + 
  geom_point(aes(color = Pathway,size = Pathway)) +
  scale_color_manual(values = c("black","red")) + 
  scale_size_manual(values = c(0.2,1))
```


#PLOT: Comparison Hi-Int-Lo-UD
```{r}
Idents(BOC) = BOC$Identity.Celltype
CD8 = subset(BOC,idents= "T_CD8")
Idents(CD8) = CD8$PTGER4.Group.Celltype
tmp = DotPlot(CD8, features = GeneSet$DE$CD8.Overview2 ) + Dot_axis90A+scale_ig 
tmp$layers[[1]] = geom_tile(aes(fill = avg.exp.scaled))
tmp + scale_fill_gradientn(colours = Col.HiLow.9Shades)
VlnPlot(CD8,"IL2RA")
```


#Most Up/Down gene
```{r}
df = data.frame(Genes = rownames(DE$T_CD8_TCF7$FoldChange.Sum) )
df
for(i in names(DE)[c(3:5,11)]){
  tmp = DE[[i]]$FoldChange.Sum %>% as_tibble(rownames = "Genes")
  tmp[is.na(tmp)] = 0
  tmp[[paste0("Total.",i)]] = tmp$Upregulation-tmp$Downregulation
  tmp = tmp[,c(1,4)]
  df= left_join(df,tmp)
}
df$Total = df$Total.T_CD8_TCF7+df$Total.T_CD8_GZMK+df$Total.T_CD8_HAVCR2
df = df %>% arrange(desc(Total))
df %>% arrange(Total)

BOCDF$MostUpDown = list()
BOCDF$MostUpDown$CD8Subtype = df
```


#MultiConditionComparison
```{r}
tmp = subset(BOC, Identity.Celltype2 == "T_CD8")
Idents(tmp) = tmp$PTGER4.Group.Celltype2
GeneSet$DE$MTC
tmp1 = FindMarkers(tmp, ident.1 = "High", ident.2 = "Low", features = c(GeneSet$DE$MT, GeneSet$DE$MTC, GeneSet$DE$Ribosome, GeneSet$DE$Common), min.pct = 0.01, logfc.threshold = 0.01 ) %>% as_tibble(rownames = "Genes")
tmp1$Condition = "High-Low"

tmp2 = FindMarkers(tmp, ident.1 = "High", ident.2 = "Intermediate", features = c(GeneSet$DE$MT, GeneSet$DE$MTC, GeneSet$DE$Ribosome, GeneSet$DE$Common), min.pct = 0.01, logfc.threshold = 0.01 ) %>% as_tibble(rownames = "Genes")
tmp2$Condition = "High-Intermediate"

tmp3 = FindMarkers(tmp, ident.1 = "Intermediate", ident.2 = "Low", features = c(GeneSet$DE$MT, GeneSet$DE$MTC, GeneSet$DE$Ribosome, GeneSet$DE$Common), min.pct = 0.01, logfc.threshold = 0.01 ) %>% as_tibble(rownames = "Genes")
tmp3$Condition = "Intermediate-Low"

tmp4 = FindMarkers(tmp, ident.1 = "High", ident.2 = "Undetected", features = c(GeneSet$DE$MT, GeneSet$DE$MTC, GeneSet$DE$Ribosome, GeneSet$DE$Common), min.pct = 0.01, logfc.threshold = 0.01 ) %>% as_tibble(rownames = "Genes")
tmp4$Condition = "High-Undetected"

tmp5 = FindMarkers(tmp, ident.1 = "Intermediate", ident.2 = "Undetected", features = c(GeneSet$DE$MT, GeneSet$DE$MTC, GeneSet$DE$Ribosome, GeneSet$DE$Common), min.pct = 0.01, logfc.threshold = 0.01 ) %>% as_tibble(rownames = "Genes")
tmp5$Condition = "Intermediate-Undetected"

tmp6 = FindMarkers(tmp, ident.1 = "Low", ident.2 = "Undetected", features = c(GeneSet$DE$MT, GeneSet$DE$MTC, GeneSet$DE$Ribosome, GeneSet$DE$Common), min.pct = 0.01, logfc.threshold = 0.01 ) %>% as_tibble(rownames = "Genes")
tmp6$Condition = "Low-Undetected"

df = rbind(tmp1,tmp2,tmp3,tmp4,tmp5,tmp6)
df$Condition %>% unique()
df$Condition = factor(df$Condition, levels = c("High-Intermediate","High-Low","High-Undetected", "Intermediate-Low","Intermediate-Undetected","Low-Undetected"))
df$Genes = factor(df$Genes, levels = c(GeneSet$DE$MT, GeneSet$DE$MTC, GeneSet$DE$Ribosome, GeneSet$DE$Common) )
df1 = df
for(j in 1){
  PNG(paste0("MultiCondition.",i), h = 5 , w = c(7 + (length(unique(df1$Genes))*0.3) ))
  print(
        ggplot(df1, aes(y = Condition, x = Genes  ) ) + theme_classic() + Dot_axis90A +ggtitle(i)+
                  geom_tile(color = "white",aes(fill =avg_log2FC)) +
                  #geom_point(aes(color = avg_log2FC, size = p_val_cat))+scale_size_manual(values = c(2,6,8,10))+
                  #geom_point(aes(color = avg_log2FC),size = 9)+
                  #scale_color_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(df1$avg_log2FC),-0.2,0,0.2,max(df1$avg_log2FC)) ), name = "Average\nLog2 FoldChange")+
                  scale_fill_gradientn(colours = Col.HiLow.9Shades,  values = scales::rescale(c(min(df1$avg_log2FC),-0.2,0,0.2,max(df1$avg_log2FC)) ), name = "Average\nLog2 FoldChange")+
                  theme(axis.title = element_blank(), 
                        axis.text.x = element_text(size =16, face = "bold"),
                        axis.text.y = element_text(size =16, face = "bold", color = "black"),
                        strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "bottom"
                        )
          
      )
  dev.off()
}

df1 = DotPlot(tmp, features = c(GeneSet$DE$MT, GeneSet$DE$MTC, GeneSet$DE$Ribosome, GeneSet$DE$Common))$data
df1
for(j in 1){
  PNG(paste0("MultiConditionScale.",i), h = 5 , w = c(7 + (length(unique(df1$features.plot))*0.3) ))
  print(
    ggplot(df1, aes(y = id, x = features.plot)) + theme_classic() + Dot_axis90A +
      geom_tile(color = "white", aes(fill =avg.exp.scaled)) +
      scale_fill_gradientn(colours = Col.HiLow.9Shades,  values = scales::rescale(c(min(df1$avg.exp.scaled),-0.2,0,0.2,max(df1$avg.exp.scaled)) ))+
      theme(axis.title = element_blank(), 
                        axis.text.x = element_text(size =16, face = "bold"),
                        axis.text.y = element_text(size =16, face = "bold", color = "black"),
                        strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "bottom"
                        )
  )
  dev.off()
}
```
#=====LLC1=======
##Celltype2
```{r}
DE <- readRDS("~/RStudioProject/LLC/DE.LLC.Celltype2.230714.rds")
#DE = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/LLC/DE.LLC.Celltype3.230719.rds")
selected.cluster = setdiff(names(DE$Day6),"Doublet")
df = data.frame()
for(t in  c("Day1.5","Day6")){
  for(i in  selected.cluster ){
    tmp = DE[[t]][[i]] %>% as_tibble(rownames = "Genes")
    if(!is.null(tmp)){
      tmp$Dataset = t
      tmp$Cluster = i
      tmp$Condition = "EP2iEP4i-Control"
      df = rbind(df,tmp) }
  }
}
df$Dataset = factor(df$Dataset,levels = c("Day1.5","Day6"))
df$Cluster = factor(df$Cluster, levels = selected.cluster )
LLCDF$df.DE.Celltype2 = df

```

##Celltype3
```{r}
DE = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/LLC/DE.LLC.Celltype3.230719.rds")
selected.cluster = setdiff(names(DE$Day6),"Doublet")
df = data.frame()
for(t in  c("Day1.5","Day6")){
  for(i in  selected.cluster ){
    tmp = DE[[t]][[i]] %>% as_tibble(rownames = "Genes")
    if(!is.null(tmp)){
      tmp$Dataset = t
      tmp$Cluster = i
      tmp$Condition = "EP2iEP4i-Control"
      df = rbind(df,tmp) }
  }
}
df$Dataset = factor(df$Dataset,levels = c("Day1.5","Day6"))
df$Cluster = factor(df$Cluster, levels = selected.cluster )
LLCDF$df.DE.Celltype3 = df

```


```{r}
BOCDF$DE.LLC = list("Celltype2" = LLCDF$df.DE.Celltype2, "Celltype3"=LLCDF$df.DE.Celltype3)
```

#--------RNA-seq------------------
#In vitro ( CD8 )
##Calculation
###M23-21 (24 hr)
```{r}
i="Veh1"
df =  read.delim(paste0("~/Lab_Diary/230707 M23-21 24hr RNA-seq/htseq/M23-21_",i,"_htseq.tabular"), header=FALSE) 
colnames(df) = c("Genes",i)
for(i in c("Veh2","Veh3","PGE2_1","PGE2_2","PGE2_3")){
  tmp <- read.delim(paste0("~/Lab_Diary/230707 M23-21 24hr RNA-seq/htseq/M23-21_",i,"_htseq.tabular"), header=FALSE) 
  colnames(tmp) = c("Genes",i)
  df = left_join(df,tmp)
}
df = as.data.frame(df)
rownames(df) = df$Genes
df = dplyr::select(df, - Genes)
Meta <- data.frame("id" = colnames(df),
                       "sampleNames" = c("Veh1","Veh2","Veh3","PGE2_1","PGE2_2","PGE2_3"),
                       "dex" = c("Vehicle","Vehicle","Vehicle","PGE2","PGE2","PGE2")
                       )
#DE
dds <- DESeqDataSetFromMatrix(countData=df, 
                              colData=Meta , 
                              design= ~dex)
dds$dex = relevel(dds$dex,ref = "Vehicle")
dds <- estimateSizeFactors(dds)
dds <- DESeq(dds)
resultsNames(dds) # lists the coefficients
DE <- results(dds, name="dex_PGE2_vs_Vehicle") %>% as.data.frame()

#Count
count.norm <- counts(dds, normalized = T) 
scaleExp = count.norm %>% t() %>% scale() %>% t() %>% as.data.frame() %>% as_tibble(rownames = "Genes")
count.norm = count.norm %>% as_tibble(rownames = "Genes")

#GSEA
tmp = as_tibble(DE, rownames = "Genes") %>% dplyr::select(Genes, log2FoldChange) %>% arrange(log2FoldChange) 
tmp = tmp[!is.na(tmp$log2FoldChange),]
ranks = deframe(tmp)
fgseaRes1 <- fgsea(mfgsea_sets, stats = ranks, nperm = 50000) %>% arrange(NES)

BOCDF$M2321 = list("RawCount" = df,"NormalizedCount" = count.norm,"Scale"=scaleExp,"DE" = DE, "GSEA" = fgseaRes1 )
```


###M23-28 (48 hr)
```{r}
i ="Veh1"
df <- read.delim("~/Lab_Diary/230722 M23-28 48hr RNA-seq/htseq/M23-28_Veh1.tabular", header=FALSE)
colnames(df) = c("Genes",i)
for(i in c("Veh2","Veh3","PGE2_1","PGE2_2","PGE2_3")){
  tmp <- read.delim(paste0("~/Lab_Diary/230722 M23-28 48hr RNA-seq/htseq/M23-28_",i,".tabular"), header=FALSE) 
  colnames(tmp) = c("Genes",i)
  df = left_join(df,tmp)
}
df = as.data.frame(df)
rownames(df) = df$Genes
df = dplyr::select(df, - Genes)
Meta <- data.frame("id" = colnames(df),
                       "sampleNames" = c("Veh1","Veh2","Veh3","PGE2_1","PGE2_2","PGE2_3"),
                       "dex" = c("Vehicle","Vehicle","Vehicle","PGE2","PGE2","PGE2")
                       )
#DE
dds <- DESeqDataSetFromMatrix(countData=df, 
                              colData=Meta , 
                              design= ~dex)
dds$dex = relevel(dds$dex,ref = "Vehicle")
dds <- estimateSizeFactors(dds)
dds <- DESeq(dds)
resultsNames(dds) # lists the coefficients
DE <- results(dds, name="dex_PGE2_vs_Vehicle") %>% as.data.frame()

#Count
count.norm <- counts(dds, normalized = T) 
scaleExp = count.norm %>% t() %>% scale() %>% t() %>% as.data.frame() %>% as_tibble(rownames = "Genes")
count.norm = count.norm %>% as_tibble(rownames = "Genes")

#GSEA
tmp = as_tibble(DE, rownames = "Genes") %>% dplyr::select(Genes, log2FoldChange) %>% arrange(log2FoldChange) 
tmp = tmp[!is.na(tmp$log2FoldChange),]
ranks = deframe(tmp)
fgseaRes1 <- fgsea(mfgsea_sets, stats = ranks, nperm = 1000) %>% arrange(NES)

BOCDF$M2328 = list("RawCount" = df,"NormalizedCount" = count.norm,"Scale"=scaleExp,"DE" = DE, "GSEA" = fgseaRes1 )
```


###M23-31 (60 hr)
```{r}
i ="Veh1"
df <- read.delim("~/Lab_Diary/230808 M23-31 RNA-seq (60 hr)/htseq/M23-31_Veh1.tabular", header=FALSE)
colnames(df) = c("Genes",i)
for(i in c("Veh2","Veh3","PGE2_1","PGE2_2","PGE2_3")){
  tmp <- read.delim(paste0("~/Lab_Diary/230808 M23-31 RNA-seq (60 hr)/htseq/M23-31_",i,".tabular"), header=FALSE) 
  colnames(tmp) = c("Genes",i)
  df = left_join(df,tmp)
}

df = as.data.frame(df)
rownames(df) = df$Genes
df = dplyr::select(df, - Genes)

Meta <- data.frame("id" = colnames(df),
                       "sampleNames" = c("Veh1","Veh2","Veh3","PGE2_1","PGE2_2","PGE2_3"),
                       "dex" = c("Vehicle","Vehicle","Vehicle","PGE2","PGE2","PGE2")
                       )

#DE
dds <- DESeqDataSetFromMatrix(countData=df, 
                              colData=Meta , 
                              design= ~dex)
dds$dex = relevel(dds$dex,ref = "Vehicle")
dds <- estimateSizeFactors(dds)
dds <- DESeq(dds)
resultsNames(dds) # lists the coefficients
DE <- results(dds, name="dex_PGE2_vs_Vehicle") %>% as.data.frame()

#Count
count.norm <- counts(dds, normalized = T) # %>% as_tibble(rownames = "Genes")
scaleExp = count.norm %>% t() %>% scale() %>% t() %>% as.data.frame() %>% as_tibble(rownames = "Genes")
count.norm = count.norm %>% as_tibble(rownames = "Genes")

#GSEA
tmp = as_tibble(DE, rownames = "Genes") %>% dplyr::select(Genes, log2FoldChange) %>% arrange(log2FoldChange) 
tmp = tmp[!is.na(tmp$log2FoldChange),]
ranks = deframe(tmp)
fgseaRes1 <- fgsea(mfgsea_sets, stats = ranks, nperm = 1000) %>% arrange(NES)

BOCDF$M2331 = list("RawCount" = df,"NormalizedCount" = count.norm,"Scale"=scaleExp,"DE" = DE, "GSEA" = fgseaRes1 )
```

```{r}
tmp1 = BOCDF$M2321$NormalizedCount %>% filter(Genes %in% geneSet$IL2R )
tmp1$Time = "24hr"
tmp2 = BOCDF$M2328$NormalizedCount %>% filter(Genes %in% geneSet$IL2R )
tmp2$Time = "48hr"
tmp3 = BOCDF$M2331$NormalizedCount %>% filter(Genes %in% geneSet$IL2R )
tmp3$Time = "72hr"
tmp = rbind(tmp1,tmp2,tmp3)
write.csv(tmp,"M23.RNA-seq.IL2R.csv")

BOCDF$M2321$DE[geneSet$IL2R,]
BOCDF$M2321$GSEA %>% filter(pathway %in% names(fgsea_sets_H))
```


##GSEA (NES)
```{r}
selected.pathway = c("HALLMARK_IL2_STAT5_SIGNALING","HALLMARK_OXIDATIVE_PHOSPHORYLATION","HALLMARK_MYC_TARGETS_V1","KEGG_RIBOSOME","HALLMARK_MTORC1_SIGNALING","REACTOME_GLYCOLYSIS","HALLMARK_INTERFERON_GAMMA_RESPONSE","HALLMARK_INTERFERON_ALPHA_RESPONSE")

names(fgsea_sets)[grep("ribosome",names(fgsea_sets),ignore.case = T)]
tmp1 = BOCDF$M2321$GSEA %>% filter(pathway %in% selected.pathway) %>% arrange(desc(NES))
tmp2 = BOCDF$M2328$GSEA %>% filter(pathway %in% selected.pathway) %>% arrange(desc(NES))
tmp3 = BOCDF$M2331$GSEA %>% filter(pathway %in% selected.pathway) %>% arrange(desc(NES))
BOCDF$M2321$GSEA %>% arrange(desc(NES))
tmp1$pathway = factor(tmp1$pathway, levels = selected.pathway)
tmp1$Time = "24hr"
tmp2$pathway = factor(tmp2$pathway, levels = selected.pathway)
tmp2$Time = "48hr"
tmp3$pathway = factor(tmp3$pathway, levels = selected.pathway)
tmp3$Time = "60hr"

tmp = rbind(tmp1,tmp2,tmp3)
plot1 = ggplot(tmp, aes(y = fct_rev(pathway), x= NES))+
  geom_bar(stat = "identity") + 
  xlim(-3,3) +
  theme_classic() +
  theme(axis.text = element_text(color = "black"),
        axis.text.y = element_text(size = 12,color="black"),
        axis.text.x = element_text(size = 12,color="black"),
        axis.title.y = element_blank(),
        strip.text.x = element_text(size = 14, face="bold")) + 
  facet_grid(.~Time, scales = "free", space="free") 

for(i in 1){
  PNG("InVitro.GSEAplot.2",w=20,h=4.5,r=200)
  print(plot1)
  dev.off()
}

```

##Volcano
```{r}
selected.pathway = list(
  "IFNG" = c("Ifng","Ifngr1","Ifngr2"),
  "IL2" = geneSet$IL2R,
  "IL2-signaling" = mfgsea_sets$HALLMARK_IL2_STAT5_SIGNALING,
  "OXPHOS" = mfgsea_sets$HALLMARK_OXIDATIVE_PHOSPHORYLATION,
  "ETC.selected" = geneSet$ETC.selected,
  "MYC Target" = mfgsea_sets$HALLMARK_MYC_TARGETS_V1,
  "Ribosome" = mfgsea_sets$KEGG_RIBOSOME,
  "MTORC1" = mfgsea_sets$HALLMARK_MTORC1_SIGNALING,
  "PI3K-AKT" = mfgsea_sets$HALLMARK_PI3K_AKT_MTOR_SIGNALING,
  "Glycolysis1" = geneSet$Glycolysis,
  "Glycolysis2" = geneSet$Glycolysis2,
  "Pparg" = c("Pparg","Ppargc1a","Ppargc1b")
)
tmp3=c("24 hrs", "48 hrs", "60 hrs")
names(tmp3) = c("M2321","M2328","M2331")
for(i in c("M2321","M2328","M2331")){
  df = BOCDF[[i]]$DE 
  for(q in names(selected.pathway)){
    tmp = df %>% as_tibble(rownames = "Gene.symbol")
    tmp$logP = (-1)*(log10(tmp$pvalue))
    tmp1 = tmp %>% filter(Gene.symbol %in% selected.pathway[[q]]  )
    tmp1$Group = q
    tmp2 = tmp %>% filter(!Gene.symbol %in% selected.pathway[[q]] )
    tmp2$Group = "other"
    tmp = rbind(tmp1,tmp2)
    tmp$logP %>% range()
    tmp = tmp[!is.na(tmp$logP),]
    tmp = filter(tmp, !logP == "Inf")
    a = ceiling(max(tmp$logP) ) 
    b = ceiling( max(abs(range(tmp$log2FoldChange))) )
    for(j in 1){  
      PNG(paste0(i,".Volcano.",q),w=7,h=6,r=200)
      print(
      ggplot(tmp, aes(x = log2FoldChange, y = logP)) + 
      geom_point(size = 0.4,color ="grey")+
      geom_point(size = 1, color = "red",  data = subset(tmp, Group %in% q  ) )+
      geom_text_repel(aes(label = Gene.symbol),color ="black",size =3.5,
                      fontface ="bold.italic", 
                      data = subset(tmp, Group == q) , 
                      #max.overlaps = Inf,box.padding = 1,
                      max.overlaps = 50,box.padding = 1,
                      max.time = 2) +
      theme_linedraw() +
      xlim(-b,b) + ylim(0,a+10) +
      ggtitle(paste0(i,"| PGE2-Vehicle | ",tmp3[[i]] ," | ",q))
    )
    dev.off()
    }
  }
}


```

##Heatmap (FoldChange)
```{r}
tmp1 = BOCDF$M2321$DE %>% as_tibble(rownames = "Genes")
tmp1$Time = "24hr"
tmp2 = BOCDF$M2328$DE %>% as_tibble(rownames = "Genes")
tmp2$Time = "48hr"
tmp3 = BOCDF$M2331$DE %>% as_tibble(rownames = "Genes")
tmp3$Time = "60hr"
df = rbind(tmp1,tmp2,tmp3)

for(i in names(selected.pathway) ){
  selected.genes = unlist( selected.pathway[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes ) 
  df1 = df1[complete.cases(df1),]
  df1$Genes = factor(df1$Genes, levels = selected.genes  )
  df1$p_val_cat = df1$padj
  df1$p_val_cat[df1$padj > 0.05 ] = ">0.05"
  df1$p_val_cat[df1$padj < 0.05 ] = "<0.05"
  df1$p_val_cat[df1$padj < 0.01 ] = "<0.01"
  df1$p_val_cat[df1$padj < 0.001 ] = "<0.001"
  df1$p_val_cat = factor(df1$p_val_cat, levels = c(">0.05","<0.05","<0.01","<0.001"))
  if( class(geneSet[[i]]) == "list"){
    tmp = data.frame(matrix(ncol = (ncol(df1)+1), nrow = 0))
    colnames(tmp) = c(colnames(df1),"Set")
    for(j in names(geneSet[[i]])){
      tmp1 = filter(df1, Genes %in% geneSet[[i]][[j]] ) %>% filter(!Genes %in% tmp[,1])
      tmp1$Set = j
      tmp = rbind(tmp,tmp1)
    }
    tmp$Set = factor(tmp$Set, levels = names(geneSet[[i]]))
    df1 = tmp
    plot = ggplot(df1, aes(y = Time, x = Genes  ) ) + facet_grid(. ~ Set, scales = "free", space="free", switch = "y") 
                  
  } else {
    plot = ggplot(df1, aes(y = Time, x = Genes  ) ) + facet_grid(. ~ . , scales = "free", space="free", switch = "y") 
  }
  plot = plot + theme_bw() + Dot_axis90A + ggtitle(i)+
                  geom_tile(color = "white",aes(fill =log2FoldChange)) +  
    scale_fill_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(df1$log2FoldChange),-0.1,0,0.1,max(df1$log2FoldChange)) ))+
                  #geom_point(aes(color = log2FoldChange, size = p_val_cat))+scale_size_manual(values = c(4,6,8,10)) + scale_color_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(df1$log2FoldChange),-0.2,0,0.2,max(df1$log2FoldChange)) ), name = "Average\nLog2 FoldChange")+ 
                  theme(plot.title = element_text(size =20, face = "bold",color = "black"),
                        axis.title = element_blank(), 
                        axis.text.x = element_text(size =16, face = "bold"),
                        axis.text.y = element_text(size =16, face = "bold", color = "black"),
                        strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.text.x.top = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "bottom"
                        )
                
  PNG(paste0("M23-21-28.Heatmap2.",i), h = 3.5, w = c(2.5 + (length(unique(df1$Genes))*0.3) ))
  print(plot)
  dev.off()
}

```

##Heatmap (Scale expression)
```{r}
tmp1 = BOCDF$M2321$Scale # %>% as_tibble(rownames = "Genes")
tmp1$Time = "24hr"
tmp2 = BOCDF$M2328$Scale # %>% as_tibble(rownames = "Genes")
tmp2$Time = "48hr"
tmp3 = BOCDF$M2331$Scale # %>% as_tibble(rownames = "Genes")
tmp3$Time = "60hr"
df = rbind(tmp1,tmp2,tmp3) %>% gather(key ="Sample", value = "Expression",-Time,-Genes) %>% filter(!Expression == "NaN")

for(i in names(selected.pathway) ){
  print(i)
  tmp = filter(df, Genes %in% selected.pathway[[i]])
  #tmp$Genes = factor(tmp$Genes, levels = selected.pathway[[i]])
  PNG(paste0("M23.RNA-seq.ScaleExp_Heatmap.",i), h = 12, w = c(2.5 + (length(unique(tmp$Genes))*0.3) ))
  print(
    ggplot(tmp, aes(y = Sample, x = Genes  ) ) + 
      facet_grid(Time ~ . , scales = "free", space="free", switch = "y")+
      geom_tile(color = "white",aes(fill =Expression) ) +  
      scale_fill_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(tmp$Expression),-0.5,0,0.5,max(tmp$Expression ) ) ) )+
      theme_bw() + Dot_axis90A + 
      theme(plot.title = element_text(size =20, face = "bold",color = "black"),
                        axis.title = element_blank(), 
                        axis.text.x = element_text(size =16, face = "bold"),
                        axis.text.y = element_text(size =16, face = "bold", color = "black"),
                        strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.text.x.top = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "bottom"
                        )+
      ggtitle(i)
  )
  dev.off()
}

```

##Publication candidate
###Fig1
```{r}
df = BOCDF$M2321$Scale # %>% as_tibble(rownames = "Genes")
df = df %>% gather(key = "Sample", value = "Expression", -Genes)
selected.pathway = list(
  "OXPHOS" = geneSet$ETC.selected,
  "Ribosome" = c("Rpl3","Rpl4","Rpl5","Rpl6","Rpl7","Rpl8","Rps3","Rps5","Rps6","Rps7","Rps8","Rps9")
)

for(i in 1 ){
  selected.genes = unlist( selected.pathway ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes ) 
  df1$Genes = factor(df1$Genes, levels = selected.genes  )
  tmp = data.frame(matrix(ncol = (ncol(df1)+1), nrow = 0))
  colnames(tmp) = c(colnames(df1),"Set")
  for(j in names(selected.pathway)){
      tmp1 = filter(df1, Genes %in% selected.pathway[[j]] ) %>% filter(!Genes %in% tmp[,1])
      tmp1$Set = j
      tmp = rbind(tmp,tmp1)
  }
  tmp$Set = factor(tmp$Set, levels = names(selected.pathway))
  df1 = tmp
  plot = ggplot(df1, aes(y = Sample, x = Genes  ) ) + 
    facet_grid(. ~ Set, scales = "free", space="free", switch = "y")  + 
    theme_bw() + 
    Dot_axis90A + 
    geom_tile(color = "white",aes(fill =Expression)) +  
    scale_fill_gradientn(colours = Col.HiLow.9Shades)+
    theme(plot.title = element_text(size =20, face = "bold",color = "black"),
          axis.title = element_blank(), 
          axis.text.x = element_text(size =16 ),
          axis.text.y = element_text(size =16, color = "black"),
          strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
          strip.text.x.top = element_text(size =18, face = "bold", color = "black",angle = 0),
          strip.background = element_rect(fill = "white"),
          strip.placement = "outside",
          legend.position = "bottom"
          )
  PNG(paste0("M23-21.Publication.Candidate.Fig.1"), h = 5, w = c(1.5 + (length(unique(df1$Genes))*0.3) ))
  print(plot)
  dev.off()
}

```
###Fig2
```{r}
df = BOCDF$M2321$GSEA %>% filter(pathway %in% names(fgsea_sets_H))
df = df[c(1:5,46:50), ]
df$Change = "Upregulation"
df$Change[(df$NES<0)] = "Downregulation"
df$Change = factor(df$Change, levels = c("Upregulation","Downregulation"))
plot = ggplot(df, aes(y = fct_rev(pathway), x= NES, fill = Change))+
  scale_fill_manual(values = c("firebrick2","dodgerblue4")) +
  geom_bar(stat = "identity") + 
  theme_classic() +
  theme(axis.text = element_text(color = "black"),
        axis.text.y = element_text(size = 12,color="black"),
        axis.text.x = element_text(size = 12,color="black"),
        axis.title.y = element_blank(),
        strip.text.x = element_text(size = 14, face="bold")) 

for(i in 1){
  PNG("M23-21.Publication.Candidate.Fig.2",w=10,h=3,r=400)
  print(plot)
  dev.off()
}
```

###Fig3
```{r}
selected.pathway = list(
  "IL2" = c("Il2","Il2ra")
)

df = BOCDF$M2321$DE 
df
for(i in c("M2321")){
  df = BOCDF[[i]]$DE 
  for(q in names(selected.pathway)){
    tmp = df %>% as_tibble(rownames = "Gene.symbol")
    tmp$logP = (-1)*(log10(tmp$padj))
    tmp1 = tmp %>% filter(Gene.symbol %in% selected.pathway[[q]]  )
    tmp1$Group = q
    tmp2 = tmp %>% filter(!Gene.symbol %in% selected.pathway[[q]] )
    tmp2$Group = "other"
    tmp = rbind(tmp1,tmp2)
    tmp$logP %>% range()
    tmp = tmp[!is.na(tmp$logP),]
    tmp = filter(tmp, !logP == "Inf")
    a = ceiling(max(tmp$logP) ) 
    b = ceiling( max(abs(range(tmp$log2FoldChange))) )
    for(j in 1){  
      PNG(paste0("M23-21.Publication.Candidate.Fig.3"),w=5,h=5,r=400)
      print(
      ggplot(tmp, aes(x = log2FoldChange, y = logP)) + 
      geom_point(size = 0.4,color ="grey")+
      geom_point(size = 1, color = "red",  data = subset(tmp, Group %in% q  ) )+
      geom_text_repel(aes(label = Gene.symbol),color ="black",size =5,
                      fontface ="bold.italic", 
                      data = subset(tmp, Group == q) , 
                      #max.overlaps = Inf,box.padding = 1,
                      max.overlaps = 50,box.padding = 1,
                      max.time = 2) +
      theme_linedraw() +
      ylab("-Log10(adjusted p-value)")+
      xlim(-3,3) + ylim(0,25) +
      ggtitle("M23-21 (24hr) | PGE2-Vehicle | ")
    )
    dev.off()
    }
  }
}
```


#--------------------------------------
#Multi-Model analysis
```{r}
DE <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype4.230713.Converted.rds")
df1A = DE$df.HighLow
df1A$Human_gene = df1A$Genes
df1A$Cluster %>% unique()
df1A= df1A %>% dplyr::select(Human_gene,avg_log2FC,Cluster) %>% filter(Cluster %in% c("NK","T_CD4","T_CD4_FOXP3","DC") )
df1A$Dataset = "Human"

DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype4.230713.converted.rds")
df1B = DE2$df 
df1B = filter(df1B, Cluster %in% c("T_CD8","TIM") )
df1B$Human_gene = df1B$Genes
df1B$tmp = df1B$Cluster
df1B$Cluster = df1B$Dataset
df1B$Dataset = df1B$tmp
df1B= df1B %>% dplyr::select(Human_gene,avg_log2FC,Cluster,Dataset) 

df2 = LLCDF$DE.LLC.Celltype3.df
df2$Human_gene = ref$M2H[df2$Genes,"Human_gene"]
df2 = dplyr::select(df2, Human_gene, avg_log2FC, Cluster, Dataset)
df2$Dataset = paste0("LLC1_",df2$Dataset)

df3 = read.csv("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/PAN.Immune.PGE2/IntegratedData.230612.csv")
df3 = gather(df3, key = "Cluster", value = "avg_log2FC", -X, -Human_gene, -Mouse_gene)
df3 = df3 %>% dplyr::select(Human_gene, avg_log2FC, Cluster)
df3$Dataset = "Public"

tmp1 = BOCDF$M2321$DE %>% as_tibble(rownames = "Genes")
tmp1$Cluster = "CD8_24hr"
tmp2 = BOCDF$M2328$DE %>% as_tibble(rownames = "Genes")
tmp2$Cluster = "CD8_48hr"
df4 = rbind(tmp1,tmp2)
df4$Dataset = "In_vitro"
df4$Human_gene = ref$M2H[df4$Genes,"Human_gene"]
df4$avg_log2FC = df4$log2FoldChange
df4 = dplyr::select(df4, Human_gene, avg_log2FC, Cluster, Dataset) 
df4 = df4[!is.na(df4$Human_gene),]
df4 = df4[!is.na(df4$avg_log2FC),]

df = rbind(df1A,df1B,df2,df3,df4)
df$Genes = df$Human_gene
df$Dataset = factor(df$Dataset,levels = c("LLC1_Day1.5","LLC1_Day6","Human","T_CD8","In_vitro","TIM","Public"))
BOCDF$MultiData = df
```

##Plot
```{r}
df = BOCDF$MultiData 
for(i in names(GeneSet$DE2) ){
  selected.genes = unlist( GeneSet$DE2[[i]] ) %>% unique()
  df1 = df[!is.na(df$avg_log2FC),] 
  df1 = filter(df1, Genes %in% selected.genes )  
  df1$Genes = factor(df1$Genes, levels = selected.genes  )
  df1$avg_log2FC[grep("Inf",df1$avg_log2FC)]
  if( class(GeneSet$DE[[i]]) == "list"){
    tmp = data.frame(matrix(ncol = (ncol(df1)+1), nrow = 0))
    colnames(tmp) = c(colnames(df1),"Set")
    for(j in names(GeneSet$DE[[i]])){
      tmp1 = filter(df1, Genes %in% GeneSet$DE2[[i]][[j]] ) %>% filter(!Genes %in% tmp[,1])
      tmp1$Set = j
      tmp = rbind(tmp,tmp1)
    }
    tmp$Set = factor(tmp$Set, levels = names(GeneSet$DE2[[i]]))
    df1 = tmp
    plot = ggplot(df1, aes(y = Cluster , x = Genes  ) ) + facet_grid(Dataset ~ Set, scales = "free", space="free", switch = "y") 
                  
  } else {
    plot = ggplot(df1, aes(y = Cluster , x = Genes  ) ) + facet_grid(Dataset ~ . , scales = "free", space="free", switch = "y") 
  }
  plot = plot + theme_bw() + Dot_axis90A + ggtitle(i)+
                  geom_tile(color = "white",aes(fill =avg_log2FC )) +  scale_fill_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(df1$avg_log2FC),-0.2,0,0.2,max(df1$avg_log2FC)) ))+
                  theme(plot.title = element_text(size =20, face = "bold",color = "black"),
                        axis.title = element_blank(), 
                        axis.text.x = element_text(size =16, face = "bold"),
                        axis.text.y = element_text(size =16, face = "bold", color = "black"),
                        strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.text.x.top = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "bottom"
                        )
                
  PNG(paste0("MultiModality2.",i), h = 27, w = c(3.5 + (length(unique(df1$Genes))*0.3) ))
  print(plot)
  dev.off()
}
```
#---------------------------------------
#Schutze Monocyte derived macrophage [GSE47189 ]
##GEO2R analysis
```{r}
###GMCSF-PGE2
M_GMCSF <- read.delim("~/RStudioProject/PublicBulkRNA/PAN.Immune.PGE2/GSE47189.M_GMCSF_PGE2_72hr_vs_M0_GMCSF_0h.tsv")
M_GMCSF %>% filter(Gene.symbol %in% c("MYC","PPARGC1A","PPARGC1B","PPARG"))

###P3C-PGE2
M_GMCSFP3C <- read.delim("~/RStudioProject/PublicBulkRNA/PAN.Immune.PGE2/GSE47189.M_GMCSF_P3C_PGE2_72h_VS_M_GMCSF_P3C_72h.tsv")
M_GMCSFP3C %>% filter(Gene.symbol %in% selected.hgenes) %>% arrange(desc(logFC))

###TNFP3C_PGE2
M_GMCSF_TP <- read.delim("~/RStudioProject/PublicBulkRNA/PAN.Immune.PGE2/GSE47189.M_GMCSF_TNFP3C_PGE2_72h_VS_M_GMCSF_TNFP3C_72h.tsv")
M_GMCSF_TP  %>% filter(Gene.symbol %in% c("MYC","PPARGC1A","PPARGC1B","PPARG"))
```

##Volcano
```{r}
names(DE)[5:7] = c("TNF_PGE2 vs TNF", "P3C_PGE2 vs P3C", "TNF_P3C_PGE2 vs TNF_P3C")
for(i in names(DE)){
  print(i)
  for(p in c("Ribosome","ETC")) {
    selected.genes = GeneSet[[p]] %>% unique()
    tmp = DE[[i]]
    tmp$logP = (-1)*(log10(tmp$P.Value))
    tmp1 = tmp %>% filter(Symbol %in% selected.genes )
    tmp1$Group = p
    tmp2 = tmp %>% filter(!Symbol %in%  selected.genes )
    tmp2$Group = "other"
    tmp = rbind(tmp1,tmp2)
    #png(filename = paste0("PAN.Immune.PGE2/Fig/230716/GSE47189.",i,".",p,".230716.png"), width = 7, height = 6, units = "in",res=200)
    PNG(paste0("GSE47189.",i,".",p,".230716"), w=7,h=6,r=200 )
    print(
      ggplot(tmp, aes(x = logFC, y = logP)) + 
      geom_point(size = 0.4,color ="grey")+
      geom_point(size = 1, aes(color = Group),  data = subset(tmp, Group %in% c(p) ) )+
      geom_text_repel(aes(label = Symbol),
                      #hjust = 1.2,
                      color ="black",
                      size =3,
                      fontface ="bold.italic", 
                      data = subset(tmp, Group %in% c(p ) ) , 
                      max.time = 2,
                      max.overlaps = 50,box.padding = 1) +
      scale_color_manual(values= c("brown","seagreen4"))+
      theme_linedraw() +
      xlim(-3,3) +
      ggtitle(paste0(i, " | ", p ))
    )
    dev.off()
  }
}
p="IFN"
for(i in names(DE)){
  selected.genes = GeneSet[[p]] %>% unique()
  print(dplyr::select(filter(DE[[i]],Symbol %in% selected.genes ),Symbol,logFC,P.Value,adj.P.Val, Condition) )
}
```


##Analysis 230830
```{r}
library("GEOquery")
#Xue = getGEO("GSE47189")
Xue <- readRDS("~/RStudioProject/PublicBulkRNA/GSE47189.Xue.230716.rds")
Xue = Xue$`GSE47189-GPL6947_series_matrix.txt.gz`
GPL <- read.delim("~/RStudioProject/PublicBulkRNA/GPL6947-13512.edited.txt")
rownames(GPL) = GPL$ID

tmp = c("GSM1140660","GSM1140673","GSM1140674","GSM1140669","GSM1140672","GSM1140677","GSM1140657","GSM1140666","GSM1140670","GSM1140659","GSM1140662","GSM1140668","GSM1140664","GSM1140665","GSM1140680","GSM1140671","GSM1140676","GSM1140679","GSM1140661","GSM1140663","GSM1140667","GSM1140658","GSM1140675","GSM1140678")
pData(Xue)[tmp,]
Xue = Xue[,tmp]
Xue$Condition = Xue$`activation stimuli:ch1`
Xue$Condition = gsub("\\+","_",Xue$Condition)
Xue$Condition = gsub("TNFa_PGE2_P3C","TNFa_P3C_PGE2", Xue$Condition)
Xue$ID = paste0(Xue$Condition,"_",1:3)

ex <- exprs(Xue)
qx <- as.numeric(quantile(ex, c(0., 0.25, 0.5, 0.75, 0.99, 1.0), na.rm=T))
LogC <- (qx[5] > 100) ||
          (qx[6]-qx[1] > 50 && qx[2] > 0)
if (LogC) { 
    ex[which(ex <= 0)] <- NaN  
    exprs(Xue) <- log2(ex) 
}
```

###DE
```{r}
DE = list()
for(i in c("PGE2","TNFa","P3C","TNFa_P3C")){
  tmp1 = filter(pData(Xue), Condition %in% c("con", i))
  Xue2 = Xue[,rownames(tmp1)]
  Xue2$Condition = factor(Xue2$Condition, levels = c(i,"con"))
  print(pData(Xue2)[,c(1,2,3,39,40)] )
  design = model.matrix(~Condition + 0 ,Xue2)
  colnames(design) = levels(Xue2$Condition)
  Xue2 = Xue2[complete.cases(exprs(Xue2)),]
  fit = lmFit(Xue2,design)
  cts = paste0(i,"-con")
  cont.matrix <- makeContrasts(contrasts=cts, levels=design)
  fit2 <- contrasts.fit(fit, cont.matrix)
  fit2 <- eBayes(fit2, 0.01)
  df1 <- topTable(fit2, adjust="fdr", sort.by="B", number=dim(fit2)[1])
  df1 <- subset(df1, select=c("ID","Symbol","adj.P.Val","P.Value","t","B","logFC","AveExpr","GI","ILMN_Gene"))
  df1$Condition = cts
  DE[[paste0(i,"-baseline")]] = df1
}

for(i in c("P3C","TNFa","TNFa_P3C")){
  tmp1 = filter(pData(Xue), Condition %in% c(i,paste0(i,"_PGE2")))
  Xue2 = Xue[,rownames(tmp1)]
  Xue2$Condition = factor(Xue2$Condition, levels = c(paste0(i,"_PGE2") , i ))
  print(pData(Xue2)[,c(1,2,3,39,40)] )
  design = model.matrix(~Condition + 0 ,Xue2)
  colnames(design) = levels(Xue2$Condition)
  Xue2 = Xue2[complete.cases(exprs(Xue2)),]
  fit = lmFit(Xue2,design)
  cts = paste0(i,"_PGE2-",i)
  cont.matrix <- makeContrasts(contrasts=cts, levels=design)
  fit2 <- contrasts.fit(fit, cont.matrix)
  fit2 <- eBayes(fit2, 0.01)
  df1 <- topTable(fit2, adjust="fdr", sort.by="B", number=dim(fit2)[1])
  df1 <- subset(df1, select=c("ID","Symbol","adj.P.Val","P.Value","t","B","logFC","AveExpr","GI","ILMN_Gene"))
  df1$Condition = cts
  DE[[ cts ]] = df1
}
#Confirm with GEO2R
M_GMCSF_TP <- read.delim("~/RStudioProject/PublicBulkRNA/PAN.Immune.PGE2/GSE47189.M_GMCSF_TNFP3C_PGE2_72h_VS_M_GMCSF_TNFP3C_72h.tsv")
M_GMCSF_TP
DE$`TNFa_P3C_PGE2-TNFa_P3C`
```

###GSEA Summary
```{r}
GSEA = list()
for(i in names(DE)){
  tmp =  DE[[i]]  %>% dplyr::select(Symbol, logFC) %>% arrange(logFC)
  ranks<- deframe(tmp)
  fgseaRes1 <- fgsea(fgsea_sets, stats = ranks, nperm = 50000)
  GSEA[[i]] = fgseaRes1 %>% as_tibble() %>% arrange(desc(NES) ) #%>% filter(padj < 0.05)
}
DE$GSEA = GSEA 



df = data.frame()
for(i in names(GSEA)){
  tmp1 = GSEA[[i]] %>% filter(pathway  %in% c("MOOTHA_GLYCOLYSIS", "MOOTHA_PGC", "REACTOME_GLYCOLYSIS" ) )
  tmp1 = tmp1[,1:7]
  print(tmp1)
  tmp2 = GSEA[[i]] %>% filter(pathway %in% names(fgsea_sets_H)) %>% arrange(NES)
  tmp2 = tmp2[1:7]
  print(tmp2)
  tmp = rbind(tmp1,tmp2)
  tmp$Dataset = i
  df = rbind(df,tmp)
}
df$Dataset = factor(df$Dataset, levels = names(GSEA))
selected.pathway = c("HALLMARK_MYC_TARGETS_V1","HALLMARK_MYC_TARGETS_V2","HALLMARK_OXIDATIVE_PHOSPHORYLATION","MOOTHA_GLYCOLYSIS", "MOOTHA_PGC", "REACTOME_GLYCOLYSIS","HALLMARK_INFLAMMATORY_RESPONSE","HALLMARK_TNFA_SIGNALING_VIA_NFKB")
for(i in 1){
  df1 = filter(df, pathway %in% selected.pathway)
  df1$pathway = factor(df1$pathway,levels= selected.pathway)
  df1$p_val_cat = df1$padj
  df1$p_val_cat[df1$padj > 0.05 ] = ">0.05"
  df1$p_val_cat[df1$padj < 0.05 ] = "<0.05"
  df1$p_val_cat[df1$padj < 0.01 ] = "<0.01"
  df1$p_val_cat[df1$padj < 0.001 ] = "<0.001"
  PNG("Test.Xue.GSEA.overview",w=8,h=5,r=400)
  print(
    ggplot(df1, aes(x = Dataset, y = fct_rev(pathway), color = NES, size = p_val_cat)) +
      geom_point()+
      scale_color_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(df1$NES),0,max(df1$NES)) ) )+
      scale_size_manual(values = rev(c(4,6,8,10)) )+
      theme_classic()+
      theme(axis.text.y = element_text(color = "black",size =12),
            axis.text.x = element_text(colour = "black",size =12, angle = 90, vjust =0.3,hjust=1),
            axis.title = element_blank())
  )
  dev.off()
```

###GSEA Running
```{r}
}
selected.pathway = c("MOOTHA_GLYCOLYSIS", "MOOTHA_PGC", "REACTOME_GLYCOLYSIS")
for(i in names(GSEA)  ){
  tmp1 = DE[[i]] %>% dplyr::select(Symbol, logFC ) %>% arrange(logFC) %>% as_tibble()
  colnames(tmp1) = c("Genes", "log2FoldChange")
  tmp1 = tmp1[!is.na(tmp1$Genes),]
  tmp1 = tmp1[!is.na(tmp1$log2FoldChange ),]
  tmp1$log2FoldChange %>% range()
  tmp2 = GSEA[[i]] %>% as.data.frame()
  rownames(tmp2) = tmp2$pathway
  ranks = deframe(tmp1)
  for(p in selected.pathway){
    tmp3 = paste0("NES = ",tmp2[p,"NES"],"\n p-value = ", tmp2[p,"pval"],"\n adjusted p-value = ", tmp2[p,"padj"])
    #PNG(paste0("Test.Xue.GSEAPlot.",i,".",p),w=6,h=3)
    #print(plotEnrichment(fgsea_sets[[p]], ranks,gseaParam = 1,ticksSize = 0.3  ) + ggtitle(paste0(i," | ", p),tmp3)  )
    #dev.off()
    tmp = plotEnrichment(fgsea_sets[[p]], ranks,gseaParam = 1,ticksSize = 0.3  ) + 
      ggtitle(paste0(i," | ", p),tmp3) +
      theme_classic() + 
      theme(title = element_text(size=12), axis.title = element_blank(),axis.text = element_text(color = "black"))
    tmp$layers[[1]]$aes_params$colour = "#354f52"
    a = tmp$layers[[3]]$data
    tmp$layers[[6]]$mapping$y = as.numeric(a-0.1)
    tmp$layers[[6]]$mapping$yend= as.numeric(a-0.2)
    tmp$layers[[6]]$aes_params$size=0.3
    tmp$layers[[6]]$aes_params$colour = "#84A98C"
    #tmp$layers[[5]] = NULL
    tmp$layers[[5]] = geom_line(color ="#354f52",size=1)
    #tmp$layers[[5]] = geom_smooth(se = F,color ="black")
    tmp$layers[[2]]$aes_params$colour = "black"
    tmp$layers[[3]]$aes_params$colour = "black"
    PNG(paste0("Test.Xue.GSEAPlot.",i,".",p),w=5,h=3)
    print(tmp )
    dev.off()
    
  }
}
```

###Scale Data
```{r}
colnames(Xue) = Xue$ID
Xue = Xue[intersect(rownames(Xue), GPL$ID) ]
intersect(rownames(Xue), GPL$ID) %>% length()

GPL[rownames(Xue),"ID"] %>% duplicated() %>% summary()
rownames(Xue) = GPL[rownames(Xue),"ID"]

pData(Xue)
XueS = list()
df = data.frame()
for(i in c("P3C","TNFa","TNFa_P3C") ){
    tmp1 = filter(pData(Xue), Condition %in% c(i,paste0(i,"_PGE2")))
    Xue2 = Xue[,tmp1$ID]
    tmp2 = exprs(Xue2)
    tmp2 = scale(t(tmp2)) %>% t() %>% as.data.frame() %>% as_tibble(rownames = "ProbeID") %>% gather(key = "Sample", value = "Expression", -ProbeID)
    tmp2$Genes = GPL[tmp2$ProbeID,"Symbol"]
    tmp2$Dataset = i
    df = rbind(df,tmp2)
    tmp2$Sample = factor(tmp2$Sample, levels = unique(Xue2$ID) )
    XueS[[paste0(i,"_PGE2")]] = tmp2
}
DE$df = df

#saveRDS(DE, "~/RStudioProject/PublicBulkRNA/GSE47189.Xue.Schultze.Macrophage/DE.Xue.230830.rds")
#saveRDS(Xue,"~/RStudioProject/PublicBulkRNA/GSE47189.Xue.Schultze.Macrophage/GSE47189.Xue.processed.230831.rds")
```
###Heatmap
```{r}
GeneSet$DE$ETC.Beyer
GeneSet$DE$PGC2 = list("PGC" = c("PPARG","PPARGC1A","PPARGC1B","MYC") )
df$Genes_ProbeID = paste0(df$Genes, "_", df$ProbeID)
for(i in c("Ribosome.Beyer","ETC.Beyer","PGC2") ){
  #df1 = filter(df, Genes %in% GeneSet$DE[[i]])
  df1 = GeneGroup(df,GeneSet$DE[[i]] )
  df1 = arrange(df1,Genes)
  df1$Genes_ProbeID = factor(df1$Genes_ProbeID, levels = unique(df1$Genes_ProbeID))
  PNG(paste0("Test.Xue.Heatmap.",i), h = 10, w = c(3.5 + (length(unique(df1$Genes_ProbeID))*0.3) ))
  print(
    ggplot(df1, aes(y = Sample, x = Genes_ProbeID  ) ) + 
      facet_grid(Dataset ~ Set , scales = "free", space="free", switch = "y")+
      geom_tile(color = "white",aes(fill =Expression) ) +  
      scale_fill_gradientn(colours = Col.HiLow.9Shades   )+
      theme_bw() + Dot_axis90A + 
      theme(plot.title = element_text(size =20, face = "bold",color = "black"),
                        axis.title = element_blank(), 
                        axis.text.x = element_text(size =16, face = "italic"),
                        axis.text.y = element_text(size =16, color = "black"),
                        strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.text.x.top = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "bottom"
                        )
      #ggtitle(i)
  )
  dev.off()
}
```

#Sanin [M2-PGE2 vs M2]
```{r}
Sanin = list()
df = data.frame()
for(i in c("M2_1","M2_2","M2_3","M2_PGE2_1","M2_PGE2_2","M2_PGE2_3")){
   df1 <- read.delim(paste0("~/RStudioProject/PublicBulkRNA/GSE119509.Sanin/GSE119509_RAW/Rename/",i,".txt"), header=FALSE)  
  colnames(df1) = c("Genes",i)
  if(ncol(df) > 0 ){
    df = left_join(df,df1)} else {
      df = df1
    }
  }
rownames(df) = df$Genes
df = df %>% dplyr::select(-Genes)
Sanin$Count = df
Sanin$metaData <- data.frame("id" = c("M2_1","M2_2","M2_3","M2_PGE2_1","M2_PGE2_2","M2_PGE2_3"),
                       "sampleNames" = c(paste0("Sample",1:6) ),
                       "dex" = c(rep("M2",3),rep("M2_PGE2",3)) 
                       )

#DE
Sanin$dds <- DESeqDataSetFromMatrix(countData=Sanin$Count, 
                              colData=Sanin$metaData , 
                              design= ~dex)
Sanin$dds <- estimateSizeFactors(Sanin$dds)
sizeFactors(Sanin$dds)
Sanin$dds <- DESeq(Sanin$dds)
resultsNames(Sanin$dds) # lists the coefficients
Sanin$DE <- results(Sanin$dds, name="dex_M2_PGE2_vs_M2") %>% as.data.frame()
Sanin$DE = Sanin$DE %>% as_tibble(rownames = "ensembl_gene_id")
mmart = useMart(biomart = "ENSEMBL_MART_ENSEMBL",
                dataset = "mmusculus_gene_ensembl",
                host = "https://www.ensembl.org")

mmartx <- getBM(filters = "ensembl_gene_id", 
                attributes = c("ensembl_gene_id", "description","external_gene_name","mgi_symbol"),
                values = Sanin$DE$ensembl_gene_id, mart = mmart) 
df = dplyr::select(mmartx,mgi_symbol,ensembl_gene_id)
Sanin$DE = left_join(Sanin$DE,df)

#Expression
Sanin$count.norm <- counts(Sanin$dds, normalized = T)

#Scale Expression
tmp1A = counts(Sanin$dds,normalized = T) 
tmp2 = mapIds(org.Mm.eg.db, keys= rownames(tmp1), keytype = "ENSEMBL", column = "SYMBOL")
tmp2 = data.frame("ENSEMBL" = names(tmp2),"Genes" = tmp2)
tmp1B = t(apply(tmp1A,1, scale))
colnames(tmp1B) = colnames(tmp1A)
tmp1B = as_tibble(tmp1B,rownames = "ENSEMBL")
df = left_join(tmp1B,tmp2) %>% dplyr::select(Genes, colnames(tmp1A))
Sanin$Scale = df
BOCDF$`Sanin_M2PGE2-M2_Scale` = df

#GSEA
DE = Sanin$DE
DE$Genes = DE$mgi_symbol
tmp = DE %>% dplyr::select(Genes, log2FoldChange) %>% arrange(log2FoldChange) 
tmp = tmp[!is.na(tmp$log2FoldChange),]
tmp = tmp[!is.na(tmp$Genes),]
ranks = deframe(tmp)
fgseaRes1 <- fgsea(mfgsea_sets, stats = ranks, nperm = 50000) %>% arrange(NES)
Sanin$GSEA = fgseaRes1 %>% arrange(desc(NES))

saveRDS(Sanin,"~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/GSE119509.Sanin/Sanin.230828.rds" )
Sanin = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/GSE119509.Sanin/Sanin.230828.rds" )

Sanin$GSEA2 <- fgseaMultilevel(mfgsea_sets, stats = ranks ) %>% as_tibble() %>% arrange(desc(NES) )
Sanin$GSEA_H2 <- fgseaMultilevel(mfgsea_sets_H, stats = ranks ) %>% as_tibble() %>% arrange(desc(NES) )

saveRDS(Sanin,"~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/GSE119509.Sanin/Sanin.230908.rds" )
```

###GSEA
```{r}
Sanin = readRDS("~/RStudioProject/PublicBulkRNA/GSE119509.Sanin/Sanin.230810.rds" )
df = Sanin$GSEA %>% filter(pathway %in% names(fgsea_sets_H) )
nrow(df)
df = df[c(1:8,43:50),]
df$pathway = factor(df$pathway, levels = df$pathway)
df$Change = "Down"
df$Change[c(df$NES>0)] = "Up"
df$Change = factor(df$Change,levels = c("Up","Down"))

for(i in 1){
  PNG("Sanin.GSEA.230817",w=12,h=5,r=300)
  print(
    ggplot(df, aes(y = fct_rev(pathway), x= NES))+
      geom_bar(stat = "identity", aes(fill = Change)) + 
      scale_fill_manual(values = c("firebrick","dodgerblue4"))+
      theme_classic() +
      theme(axis.text = element_text(color = "black"),
            axis.text.y = element_text(size = 14,color="black"),
            axis.text.x = element_text(size = 14,color="black"),
            axis.title.y = element_blank()) 
  )
  dev.off()
}

```


###Volcano
```{r}
df = Sanin$DE 
df$Genes = df$mgi_symbol
BOCDF[["Sanin_M2PGE2-M2"]] = df

for(q in c("ETC.selected","Ribosome")){
  tmp = df 
  tmp$logP = (-1)*(log10(tmp$pvalue))
  tmp1 = tmp %>% filter(Genes %in% geneSet[[q]] )
  tmp1$Group = q
  tmp2 = tmp %>% filter(!Genes %in% geneSet[[q]] )
  tmp2$Group = "other"
  tmp = rbind(tmp1,tmp2)
  tmp$logP %>% range()
  tmp = tmp[!is.na(tmp$logP),]
  tmp
  for(i in 1){  
    png(paste0("~/RStudioProject/PublicBulkRNA/GSE119509.Sanin/Fig/Sanin.M2_PGE2-M2.",q,".png"),width=7,height=6,res=200,units = "in")
    print(
      ggplot(tmp, aes(x = log2FoldChange, y = logP)) + 
      geom_point(size = 0.4,color ="grey")+
      geom_point(size = 1, color = "red",  data = subset(tmp, Group %in% q  ) )+
      geom_text_repel(aes(label = Genes),color ="black",size =3.5,
                      fontface ="bold.italic", 
                      data = subset(tmp, Group == q) , 
                      #max.overlaps = Inf,box.padding = 1,
                      max.overlaps = 50,box.padding = 0.4,
                      max.time = 2) +
      theme_linedraw() +
      xlim(-4,4) + ylim(0,55) +
      ggtitle(paste0("Sanin: PGE2 M2 vs M2 | ",q))
    )
    dev.off()
    }
}

```
###Heatmap
```{r}
tmp1A = counts(Sanin$dds,normalized = T) 
tmp2 = mapIds(org.Mm.eg.db, keys= rownames(tmp1), keytype = "ENSEMBL", column = "SYMBOL")
tmp2 = data.frame("ENSEMBL" = names(tmp2),"Genes" = tmp2)
tmp1B = t(apply(tmp1A,1, scale))
colnames(tmp1B) = colnames(tmp1A)
tmp1B = as_tibble(tmp1B,rownames = "ENSEMBL")
df = left_join(tmp1B,tmp2) %>% dplyr::select(Genes, colnames(tmp1A))
Sanin$Scale = df
BOCDF$`Sanin_M2PGE2-M2_Scale` = df
df = BOCDF$`Sanin_M2PGE2-M2_Scale`
df
df = df[complete.cases(df),]
df = df %>% gather(key = "ID", value = "Expression",-Genes) 
df

for(q in c("LLC")){
  df1 = df %>% filter(Genes %in% geneSet[[q]])
  for(i in 1){  
    png(paste0("~/RStudioProject/PublicBulkRNA/GSE119509.Sanin/Fig/Sanin.M2_PGE2-M2.Heatmap.",q,".png"),width= 3+(length(unique(df1$Genes))*0.3) ,height=4,res=200,units = "in")
    print(
      ggplot(df1, aes(y = ID, x = Genes  ) )  + 
        theme_bw() + Dot_axis90A + ggtitle(paste0("Sanin: PGE2 M2 vs M2 | ",q)) +
        geom_tile(color = "white",aes(fill =Expression)) +  scale_fill_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(df1$Expression),-0.1,0,0.1,max(df1$Expression) )) ) +
                  theme(plot.title = element_text(size =20, face = "bold",color = "black"),
                        axis.title = element_blank(), 
                        axis.text.x = element_text(size =16, face = "bold"),
                        axis.text.y = element_text(size =16, face = "bold", color = "black"),
                        strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.text.x.top = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "bottom"
                        )
    )
    dev.off()
    }
}
#saveRDS(Sanin,"/Users/Siwakorn/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/GSE119509.Sanin/Sanin.230810.rds" )
```

#Sanin [M2 vs M0]
```{r}
Sanin2 = list()
df = data.frame()
for(i in c("M0_1","M0_2","M0_3","M2_1","M2_2","M2_3")){
   df1 <- read.delim(paste0("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/GSE119509.Sanin/GSE119509_RAW/Rename/",i,".txt"), header=FALSE)  
  colnames(df1) = c("Genes",i)
  if(ncol(df) > 0 ){
    df = left_join(df,df1)} else {
      df = df1
    }
  }
rownames(df) = df$Genes
df = df %>% dplyr::select(-Genes)
Sanin2$Count = df
Sanin2$metaData <- data.frame("id" = c("M0_1","M0_2","M0_3","M2_1","M2_2","M2_3"),
                       "sampleNames" = c(paste0("Sample",1:6) ),
                       "dex" = c(rep("M0",3),rep("M2",3)) 
                       )
Sanin2$Count
Sanin2$metaData

#DE
Sanin2$dds <- DESeqDataSetFromMatrix(countData=Sanin2$Count, 
                              colData=Sanin2$metaData , 
                              design= ~dex)
Sanin2$dds <- estimateSizeFactors(Sanin2$dds)
Sanin2$dds <- DESeq(Sanin2$dds)
resultsNames(Sanin2$dds) # lists the coefficients
Sanin2$DE <- results(Sanin2$dds, name="dex_M2_vs_M0") %>% as.data.frame()
Sanin2$DE = Sanin2$DE %>% as_tibble(rownames = "ensembl_gene_id")
mmart = useMart(biomart = "ENSEMBL_MART_ENSEMBL",
                dataset = "mmusculus_gene_ensembl",
                host = "https://www.ensembl.org")

mmartx <- getBM(filters = "ensembl_gene_id", 
                attributes = c("ensembl_gene_id", "description","external_gene_name","mgi_symbol"),
                values = Sanin2$DE$ensembl_gene_id, mart = mmart) 
saveRDS(mmartx,"~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/Ref/mmartx.230906.rds")
df = dplyr::select(mmartx,mgi_symbol,ensembl_gene_id)
Sanin2$DE = left_join(Sanin2$DE,df)
Sanin2$DE %>% filter(mgi_symbol %in% c("Ptger2","Ptger4"))
```
##Volcano
```{r}
df = Sanin2$DE
df$Genes = df$mgi_symbol
BOCDF[["Sanin_M2-M0"]] = df
geneSet$PGE2B = c("Ptgs1","Ptgs2","Ptger1","Ptger2","Ptger3","Ptger4")
for(q in c("PGE2B")){
  tmp = df 
  tmp$logP = (-1)*(log10(tmp$pvalue))
  tmp1 = tmp %>% filter(Genes %in% geneSet[[q]] )
  tmp1$Group = q
  tmp2 = tmp %>% filter(!Genes %in% geneSet[[q]] )
  tmp2$Group = "other"
  tmp = rbind(tmp1,tmp2)
  tmp$logP %>% range()
  tmp = tmp[!is.na(tmp$logP),]
  for(i in 1){  
    PNG(paste0("Test.Sanin.M2_M0.",q),w=7,h=6)
    print(
      ggplot(tmp, aes(x = log2FoldChange, y = logP)) + 
      geom_point(size = 0.4,color ="grey")+
      geom_point(size = 1, color = "red",  data = subset(tmp, Group %in% q  ) )+
      geom_text_repel(aes(label = Genes),color ="black",size =3.5,
                      fontface ="bold.italic", 
                      data = subset(tmp, Group == q) , 
                      #max.overlaps = Inf,box.padding = 1,
                      max.overlaps = 50,box.padding = 0.4,
                      max.time = 2) +
      theme_linedraw() +
      xlim(-4,4) + ylim(0,55) +
      ggtitle(paste0("Sanin: PGE2 M2 vs M2 | ",q))
    )
    dev.off()
    }
}
```


#Beyer (Schultze) CD4 
##In house analysis 
```{r}
library("GEOquery")
Beyer1 = getGEO("GSE15390")
Beyer1 = Beyer1$GSE15390_series_matrix.txt.gz
#saveRDS(Beyer1,"~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/GSE15390.rds" )
Beyer1 = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/GSE15390.rds" )

Beyer2 = getGEO("GSE52185")
saveRDS(Beyer2,"~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/GSE52185.rds" )
Beyer2 = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/GSE52185.rds" )
Beyer2 = Beyer2$`GSE52185-GPL2507_series_matrix.txt.gz`

GPL <- read.csv("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/GPL2507_Human_WG-6.csv")
tmp = GPL$Target[duplicated(GPL$Target)]
GPL = GPL[!duplicated(GPL$Target),]
GPL$Genes_ID = paste0(GPL$Symbol,"_",GPL$Target)
rownames(GPL) = GPL$Target

#write.csv(pData(Beyer1),"~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/pData.GSE15390.csv" ) #Beyer, Nat Imm 2011
tmp1 = c("GSM425388","GSM425389","GSM425390","GSM777688","GSM430153","GSM430149","GSM430152","GSM777692")
#write.csv(pData(Beyer2),"~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/pData.GSE52185-GPL2507.csv" ) #Beyer, Nat Imm 2016
tmp2 = c("GSM448914","GSM448915","GSM448916","GSM448934","GSM448930","GSM448933")

Beyer1 = Beyer1[,tmp1]
Beyer1 = Beyer1[complete.cases(exprs(Beyer1)),]
Beyer1$Group = c(rep("CD3CD28",4),rep("CD3CD28_PGE2",4))
Beyer1$Group = factor(Beyer1$Group, levels = c("CD3CD28_PGE2","CD3CD28") )
Beyer1$ID = paste0(Beyer1$Group,"_",1:4)
pData(Beyer1) %>% dplyr::select(title,Group,ID)

Beyer2 = Beyer2[,tmp2]
Beyer2 = Beyer2[complete.cases(exprs(Beyer2)),]
Beyer2$Group = c(rep("CD3CD28",3),rep("CD3CD28_PGE2",3))
Beyer2$Group = factor(Beyer2$Group, levels = c("CD3CD28_PGE2","CD3CD28") )
Beyer2$ID = paste0(Beyer2$Group,"_",1:3)
pData(Beyer2) %>% dplyr::select(title,Group,ID)

DE = list()
Beyer = list("Beyer1"=Beyer1,"Beyer2" = Beyer2)
for(i in c("Beyer1","Beyer2")){
  ex <- exprs(Beyer[[i]])
  qx <- as.numeric(quantile(ex, c(0., 0.25, 0.5, 0.75, 0.99, 1.0), na.rm=T))
  LogC <- (qx[5] > 100) ||
          (qx[6]-qx[1] > 50 && qx[2] > 0)
  if (LogC) { 
    ex[which(ex <= 0)] <- NaN  
    exprs(Beyer[[i]]) <- log2(ex) 
    }
  design = model.matrix(~Group+ 0 ,Beyer[[i]])
  colnames(design) = levels(Beyer[[i]]$Group)
  fit = lmFit(Beyer[[i]],design)
  cts = "CD3CD28_PGE2-CD3CD28"
  cont.matrix <- makeContrasts(contrasts=cts, levels=design)
  fit2 <- contrasts.fit(fit, cont.matrix)
  fit2 <- eBayes(fit2, 0.01)
  df1 <- topTable(fit2, adjust="fdr", sort.by="B", number=dim(fit2)[1])
  df1$Genes = GPL[df1$ID,"Symbol"]
  df1 <- subset(df1, select=c("Genes","ID","GB_ACC","logFC","AveExpr","adj.P.Val","P.Value","t","B"))
  df1$Condition = cts
  DE[[i]] = df1
}

#Confirm with GEO2R
DE$Beyer1[1:10,] %>% arrange(ID)
tmp <- read.delim("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/GSE15390.CD4.CD3CD28PGE2_vs_CD3CD28.tsv") %>% filter(!Gene.symbol == "")
tmp %>% filter(ID %in% DE$Beyer1$ID[1:10]) %>% arrange(ID)


DE$Beyer2[1:10,] %>% arrange(ID)
tmp <- read.delim("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/GSE52185.CD4.CD3CD28PGE2_vs_CD3CD28.tsv")
tmp %>% filter(ID %in% DE$Beyer2$ID[1:10]) %>% arrange(ID)

`
Beyer2 = Beyer$Beyer2
colnames(Beyer2) = Beyer2$ID
Beyer2 = Beyer2[intersect(rownames(Beyer2),GPL$Target),]

GPL[rownames(Beyer2),"Genes_ID"] %>% duplicated() %>% summary()
rownames(Beyer2) = GPL[rownames(Beyer2),"Genes_ID"]

tmp2 = exprs(Beyer2)
tmp2 = scale(t(tmp2)) %>% t() %>% as.data.frame() %>% as_tibble(rownames = "Genes_ProbeID") %>% gather(key = "Sample", value = "Expression", -Genes_ProbeID)

rownames(GPL) = GPL$Genes_ID
tmp2$Genes = GPL[tmp2$Genes_ProbeID, "Symbol"]
Beyer$Beyer2.df = tmp2

DE$Beyer2
tmp =  DE$Beyer2  %>% dplyr::select(Genes, logFC) %>% arrange(logFC)
ranks<- deframe(tmp)
fgseaRes1 <- fgsea(fgsea_sets, stats = ranks, nperm = 50000)
DE$Beyer2.GSEA = fgseaRes1 %>% as_tibble() %>% arrange(desc(NES) ) #%>% filter(padj < 0.05)

#saveRDS(DE,    "~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/DE.CD4.Schultze-Meyer.230829.rds")
#saveRDS(Beyer, "~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/Beyer.230829.rds")
DE = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/DE.CD4.Schultze-Meyer.230829.rds")
Beyer = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/Beyer.230829.rds")

tmp =  DE$Beyer2  %>% dplyr::select(Genes, logFC) %>% arrange(logFC) %>% deframe()
DE$Beyer2.GSEA2 = fgseaMultilevel(fgsea_sets, stats = tmp ) %>% as_tibble() %>% arrange(desc(NES) )
DE$Beyer2.GSEA_H2 = fgseaMultilevel(fgsea_sets_H, stats = tmp ) %>% as_tibble() %>% arrange(desc(NES) )
saveRDS(DE,    "~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/DE.CD4.Schultze-Meyer.230908.rds")

DE = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/DE.CD4.Schultze-Meyer.230908.rds")
DE$Beyer2.GSEA2 # %>% filter(pathway %in% "MOOTHA_PGC")
```
#==================


#Wu
```{r}
Wu = readRDS("~/RStudioProject/scRNA/Wu.230820.rds")
Idents(Wu) = Wu$Identity.primary
for(i in 1){
  PNG(paste0("Confirm.Wu.DM"),w = 6,h=6,r=600)
  print(DimPlot(Wu,label=T,pt.size=0.01,raster = F  ) + NoLegend() )
  dev.off()
}
for(i in c("PTPRC","PTGER1","PTGER2","PTGER3","PTGER4","PTGS1","PTGS2","CD3D","CSF1R","CSF3R","MS4A1","IGKC","NKG7","MKI67","EPCAM","KRT8","COL3A1","COL6A2" ) ){
  PNG(paste0("Confirm.Wu.FP.",i),h=6,w=6,r=500)
  print(   
    FeaturePlot(Wu, i,pt.size = 0.01, cols = col_orange3,raster = F) + 
      theme(plot.title = element_text(size =40, face="bold.italic") )+ 
              NoLegend()       ) 
  dev.off()
}
Wu
```

#Weiguo
```{r}
Weiguo <- Weiguo <- readRDS("~/RStudioProject/scRNA.Public/Weiguo.230820.rds")
Weiguo$Sample %>% as.factor() %>% summary()
Idents(Weiguo) = Weiguo$Identity.primary
tmp = paste0("Cancer",1:7)
Weiguo = subset(Weiguo, Sample %in% tmp)
for(i in 1){
  PNG(paste0("Confirm.Weiguo.DM"),w = 6,h=6,r=600)
  print(DimPlot(Weiguo,label=T,pt.size=0.5,raster = F  ) + NoLegend() )
  dev.off()
}
for(i in c("PTPRC","PTGER1","PTGER2","PTGER3","PTGER4","PTGS1","PTGS2","CD3D","CSF1R","CSF3R","MS4A1","IGKC","NKG7","MKI67","EPCAM","KRT8","COL3A1","COL6A2" ) ){
  PNG(paste0("Confirm.Weiguo.FP.",i),h=6,w=6,r=500)
  print(   
    FeaturePlot(Weiguo, i,pt.size = 0.5, cols = col_orange3,raster = F) + 
      theme(plot.title = element_text(size =40, face="bold.italic") )+ 
              NoLegend()       ) 
  dev.off()
}
Weiguo
```


#Bonavita
```{r}
DE=readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA.Public/Bonavita/DE.Bonavita.Celltype2.230714.rds")
df = data.frame()
DE$NK
for(i in names(DE)){
      df1 = DE[[i]] %>% as_tibble(rownames = "Genes")
      df1$Cluster = i
      df1$Dataset = "Bonavita"
      df = rbind(df,df1)
      }
df$Cluster = factor(df$Cluster, levels= names(DE) )
df$Cluster %>% unique()
```


#-----------------------------------------
#Figure 1 (Overview)-------
##Fig 1A UMAP
```{r}
BOC <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.PTGER4Group.230713.rds")
BOC = readRDS("//home/siwakorn/Human/RDS/BOC.PTGER4Group.230713.rds")
Idents(BOC) = BOC$Identity.Celltype4R
for(i in c(1)){
  for(j in c(1) ) {
      PNG(paste0("BOC.CD45.All.DM"))
      print(DimPlot(BOC,label =F, pt.size = 0.1,
                    cols = BOCDF$cols$Celltype4
                    ) +NoLegend())
      dev.off()
      }
  }

for(i in 1){
      PDF("Fig.1A.BOC.CD45.All.DM1",r=500,w=8,h=8)
      print(DimPlot(BOC,label =F, pt.size = 0.1,
                    cols = BOCDF$cols$Celltype4
                    ) + NoLegend())
      dev.off()
      PDF("Fig.1A.BOC.CD45.All.DM2", w=9,h=6)
      print(DimPlot(BOC,label =T, 
                    cols = BOCDF$cols$Celltype4
                    ) ) 
      dev.off()
}
```

##Fig 1B Signature Celltype4
```{r}
BOCDF$AllMarkers = list()
Idents(BOC) = BOC$Identity.Celltype2
BOCDF$AllMarkers$Celltype2 = FindAllMarkers(BOC,max.cells.per.ident = 100)

Idents(BOC) = BOC$Identity.Celltype3
BOCDF$AllMarkers$Celltype3 = FindAllMarkers(BOC,max.cells.per.ident = 100)

Idents(BOC) = BOC$Identity.Celltype4
BOCDF$AllMarkers$Celltype4 = FindAllMarkers(BOC,max.cells.per.ident = 100)

Idents(CD8) = CD8$Identity.Subtype1
BOCDF$AllMarkers$CD8.Subtype1 = FindAllMarkers(CD8, max.cells.per.ident = 100)

Idents(TIM) = TIM$Identity.Subtype1
BOCDF$AllMarkers$TIM = FindAllMarkers(TIM, max.cells.per.ident = 200)
BOCDF$AllMarkers$Celltype4
tmp1 = BOCDF$AllMarkers$Celltype4 %>% group_by(cluster) %>% top_n(n=30, wt=avg_log2FC)
write.csv(tmp1, "AllMarker.Celltype4.230819.csv")

tmp1 = c("NCAM1","KLRD1","KLRC3","CD8A","GZMH","GZMK","CD4","RORA","IL7R","FOXP3","CTLA4","IL2RA","CSF1R","CSF3R","IL1B","HLA-DRA","HLA-DQB1","CD86","MS4A1","CD79A","TCF4","JCHAIN","IGHG1","IGKC","MKI67","STMN1","HMGB1")
Idents(BOC) = BOC$Identity.Celltype4R
df = DotPlot(BOC,features = unique(tmp1) )$data
for(i in 1){
  PDF("Fig.1B.BOC.Signature.Celltype4", w=1.4,h=3.7,r=500)
  print(ggplot(df, aes(y = fct_rev(features.plot), x = id, fill = avg.exp.scaled)) + 
          geom_tile(color = "white")+ scale_fill_gradientn(colours = col_viridis) + theme_classic()+
          scale_y_discrete(position = "right")+
          theme(text = element_text(family="Arial"),
                axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.3, color ="black",size = 6),
                axis.text.y = element_text(face = "italic",color = "black",size=6),
                axis.title = element_blank(),
                legend.position = "bottom" ) )
  dev.off()
}
```


##Fig 1C Percentage
```{r}
tmp1 = table(BOC$Identity.Celltype4R, BOC$Batch.scRNA )
apply(tmp1,1,function(x) x/colSums(tmp1)*100) %>% t() %>% as_tibble(rownames = "Cluster")
tmp1 = apply(tmp1,1,function(x) x/colSums(tmp1)*100) %>% t() %>% as_tibble(rownames = "Cluster") %>% gather(key = "ID", value = "Pct", -Cluster)
tmp1$Cluster =factor(tmp1$Cluster, levels = levels(BOC$Identity.Celltype4R) )
tmp1 = filter(tmp1, !Cluster %in% c("LQ","Minor"))
tmp1$Cancer = NA
tmp1$Cancer[grep("BRCA",tmp1$ID)] = "BRCA"
tmp1$Cancer[grep("CRC",tmp1$ID)] = "CRC"
tmp1$Cancer[grep("OVCA",tmp1$ID)] = "OVCA"

tmp2 = table(BOC$Identity.Celltype4R, BOC$Cancer)
tmp2 = apply(tmp2,1,function(x) x/colSums(tmp2)*100) %>% t() %>% as_tibble(rownames = "Cluster") %>% gather(key = "Cancer", value = "Pct", -Cluster)
tmp2$Cluster =factor(tmp2$Cluster, levels = levels(BOC$Identity.Celltype4R) )
tmp2 = filter(tmp2, !Cluster %in% c("LQ","Minor"))
tmp2$ID = tmp2$Cancer
tmp2$Cancer = "All"
tmp= rbind(tmp1,tmp2)

for(i in 1){
      PDF("Fig.1C.BOC.Fraction.Identity.Celltype4R.ID", w=3.2,h=3.2)
      print(
            ggplot(tmp,aes(x = ID ,y = Pct,fill = Cluster )) +
                  geom_bar(stat="identity")  +
                  scale_fill_manual(values= BOCDF$cols$Celltype4) + 
                  theme_classic()+ 
                  facet_grid(.~ Cancer, scales = "free", space="free", switch = "y")+
                  theme(axis.text.x = element_text(family="Arial",color = "black", size = 6, angle = 90, hjust =1,vjust=0.3),
                        axis.text.y = element_text(family="Arial",color = "black",size =6),
                        legend.position = "bottom",
                        axis.title = element_blank(),
                        strip.background = element_rect(fill = "black"),
                        strip.text.x.top = element_text(family="Arial",color = "white",size=6)
                        ) #+ NoLegend()
      )
      dev.off()
}


```


##Fig 1D PGE2 plot
```{r}
for(i in GeneSet$PGE2B  ){
  PNG(paste0("Fig.1D.BOC.FP.V1.or3.",i),h=5,w=5,r=500)
  print(
    FeaturePlot(BOC, i,pt.size = 0.03, cols = col_orange3,raster = F) +
      theme(plot.title = element_blank(),
            axis.title = element_text(size =15))+
      NoLegend()
        )
  dev.off()
 }
for(i in "PTGER4"  ){
  PDF(paste0("Fig.1D.BOC.FP.V1.or3.Legend.",i),h=5,w=5.5)
  print(
    FeaturePlot(BOC, i,pt.size = 0.03, cols = col_orange3,raster = F) +
      theme(plot.title = element_blank(),
            axis.title = element_text(size =15))
        )
  dev.off()
 }
```


##Fig 1E pct.exp PG gens
```{r}
Idents(BOC) = BOC$Identity.Celltype4R
tmp = DotPlot(BOC, features = GeneSet$PGE2B)$data
tmp$pct.exp.cat = (floor(tmp$pct.exp/10)*10) 
tmp$pct.exp.cat = gsub("^0","<10%",tmp$pct.exp.cat,  perl = T)
tmp$pct.exp.cat = gsub("^10","10-20%",tmp$pct.exp.cat,  perl = T)
tmp$pct.exp.cat = gsub("^20","20-30%",tmp$pct.exp.cat,  perl = T)
tmp$pct.exp.cat = gsub("^30","30-40%",tmp$pct.exp.cat,  perl = T)
tmp$pct.exp.cat = gsub("^40","40-50%",tmp$pct.exp.cat,  perl = T)
tmp$pct.exp.cat = gsub("^50","50-60%",tmp$pct.exp.cat,  perl = T)
tmp$pct.exp.cat = factor(tmp$pct.exp.cat, levels = sort(unique(tmp$pct.exp.cat)) )

for(i in 1){
  PDF(paste0("Fig.1e.BOC.DP.PctExp.PGE2"),w = 1.8,h=2.3,r=800)
  print(
    ggplot(tmp, aes(x = id, y = fct_rev(features.plot)))+
      geom_point(colour = "black",pch = 21,aes(size = pct.exp.cat, fill = pct.exp.cat) )+
      scale_fill_manual(values= col_BlueRed2 ) +
      scale_size_manual(values = seq(1,6,0.5))+
      scale_y_discrete(position = "right")+
      theme_classic()+
      theme(axis.text.y = element_text(family = "Arial", size = 6,color = "black",face = "italic"),
            axis.title = element_blank(),
            axis.text.x = element_text(family = "Arial", size = 6,color = "black",angle = 90, hjust =1,vjust =0.3), 
            legend.position = "bottom"
            )
  )
  dev.off()
}

for(i in 1){
  PDF(paste0("Fig.1e.BOC.DP.PctExp.PGE2.Flip"),w = 1.7,h=2.6,r=800)
  print(
    ggplot(tmp, aes(y = fct_rev(id), x = features.plot))+
      geom_point(colour = "black",pch = 21,aes(size = pct.exp.cat, fill = pct.exp.cat) )+
      scale_fill_manual(values= col_BlueRed2 ) +
      scale_size_manual(values = seq(1,6,0.5))+
      scale_y_discrete(position = "right")+
      theme_classic()+
      theme(axis.text.y = element_text(family = "Arial", size = 6,color = "black" ),
            axis.title = element_blank(),
            axis.text.x = element_text(family = "Arial", size = 6,color = "black",face = "italic",
                                       angle = 90, hjust =1,vjust =0.3), 
            legend.position = "bottom"
            )
  )
  dev.off()
}

```

##Supplement Fig 1D FP plot (enhaced version)
```{r}

tmp = FetchData(BOC,vars = c("UMAP_1","UMAP_2",GeneSet$PGE2))
for(i in GeneSet$PGE2){
  tmp$Expression = tmp[,i]
  tmp1 = filter(tmp, Expression > 0)
  tmp2 = filter(tmp, Expression == 0)
  tmp3 = rbind(tmp2,tmp1)
  PNG(paste0("Fig.1D.BOC.FP.Enhance.NoTitle.",i),w = 5,h=5,r=300)
  print(
    ggplot(tmp3, aes(x = UMAP_1, y = UMAP_2, color = Expression))+
      geom_point(size = 0.2)+
      scale_orange+
      theme_classic()+ 
      ggtitle(i)+
      theme(plot.title = element_blank(),
            axis.title = element_text(size =15))+
      NoLegend()
  )
  dev.off()
}

tmp = FetchData(BOC,vars = c("UMAP_1","UMAP_2",GeneSet$PGE2))
for(i in GeneSet$PGE2[9]){
  tmp$Expression = tmp[,i]
  PNG(paste0("Fig.1D.BOC.FP.V3.pt0.7.alpha1.or4g.NoTitle.",i),w = 10,h=10,r=300)
  print(
    ggplot(tmp, aes(x = UMAP_1, y = UMAP_2, color = Expression))+
      geom_point(size = 0.7,alpha=1)+
      scale_color_gradientn(colours = col_orange4, values = c(0,0.05,0.1,0.3,0.4,1))+
      theme_classic()+ 
      ggtitle(i)+
      theme(plot.title = element_blank(),
            axis.title = element_text(size =15))+
      NoLegend()
  )
  dev.off()
}
```

##Supplement PTGER4 Group expression
```{r}
tmp = subset(BOC, Identity.Celltype2 == "T_CD8") %>% subset(Batch.scRNA == "scBRCA1")
Idents(tmp) = tmp$PTGER4.Group.Celltype2
for(i in 1){
  PNG("BOC.CD45.PTGER4Group.DM.CD8.scBRCA1", w= 8, h =7)
  print(DimPlot(tmp, cols = c("grey","dodgerblue4","orange","darkred")))
  dev.off()
  PNG("BOC.CD45.PTGER4Group.VP.CD8.scBRCA1", w= 3, h =8)
  print(VlnPlot(tmp, "PTGER4", pt.size = 1,cols =  c("grey","dodgerblue4","orange","darkred") ) + NoLegend() + theme(axis.title = element_blank() )+ Dot_axis90B  )
  dev.off()
}


tmp = subset(BOC, Identity.Celltype2 == "T_CD8") %>% subset(Batch.scRNA == "scBRCA1")
Idents(tmp) = tmp$PTGER4.Group.Celltype2
for(i in 1){
  PNG("BOC.CD45.PTGER4Group.DM.CD8.scBRCA1", w= 8, h =7)
  print(DimPlot(tmp, cols = c("grey","dodgerblue4","orange","darkred")))
  dev.off()
  #PNG("BOC.CD45.PTGER4Group.VP.CD8.scBRCA1", w= 3, h =8)
  PNG("BOC.CD45.PTGER4Group.VP.CD8.scBRCA1.V2", w= 4, h =5,r=300)
  print(
    VlnPlot(tmp, "PTGER4", pt.size = 0.2,cols =  c("grey","dodgerblue4","orange","darkred") ) + 
      NoLegend() + 
      theme(axis.text.x =  element_text(size = 15, angle = 90, hjust = 1, vjust = 0.3,color = "black"), 
            axis.text.y = element_text(size = 25,color = "black"),
            axis.title = element_blank(),
            title = element_blank()
            ) 
      )
  dev.off()
}

tmp = FetchData(BOC,vars = c("PTGER4","PTGER4.Group.Celltype4" , "Identity.Celltype4","Batch.scRNA"))
for(i in 1){
  PNG("BOC.CD45.VP.PTGER4Group.v2", w= 20, h =16)
  print(
    ggplot(tmp, aes(x = PTGER4.Group.Celltype4, y=PTGER4, fill = Identity.Celltype4 ) )+ 
      geom_violin()+
      facet_grid( Identity.Celltype4 ~ Batch.scRNA) + 
      theme_bw() + Dot_axis90B   )
  dev.off()
}
```

#Figure 2/ Ext 2 (CD8) ------------
##Fig 2A DM 
```{r}
BOC <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.PTGER4Group.230713.rds")
CD8 = subset(BOC,Identity.Celltype3 == "CD8 T cell") #CD8+Dividing CD8
BOC = NULL
CD8 = Clustering1(CD8, dist = 1, spread =1 )
Idents(CD8) = CD8$Identity.Subtype1
for(i in 1){
  PNG("Fig.2A.BOC.CD8.DM.Subtype1.pt04",w= 6,h=6)
  print(
    DimPlot(CD8,label=F, pt.size = 0.4,
            cols = BOCDF$cols$CD8.Subtype1,raster = F )  + 
      theme(axis.title = element_blank(),
                     axis.text = element_blank(),
                     axis.line = element_line(colour = 'black', size = 1),
                     axis.ticks = element_line(colour = 'black', size = 0.7))+
      NoLegend()
  )
  dev.off()
  PDF("Fig.2A.BOC.CD8.DM.Subtype1.L",w= 9,h=6,r=200)
  print(
    DimPlot(CD8,label=T,cols = BOCDF$cols$CD8.Subtype1,pt.size =0.5 ) 
  )
  dev.off()
}
```

##Fig 2B PTGER4 expression (EP4 Group)
```{r}
Idents(CD8) = CD8$PTGER4.Group.Celltype
tmp2 = c("#400E32","#A61F69","#F2921D","#F2CD5C")
for(i in 1){
  PDF("Fig.2B.BOC.CD8.Vln.PTGER4.PTGER4Group.Celltype",w=1,h=1.8,r=500)
  print(
    VlnPlot(CD8, "PTGER4",cols = tmp2, pt.size = 0) + 
      NoLegend() +
      #ylab("Normalize expression") +
          theme(plot.title = element_blank(),
                axis.text.x = element_text(size =4.5, family = "Arial", color = "black", angle = 90, hjust =1, vjust =0.3),
                axis.text.y = element_text(size =4.5, family = "Arial", color = "black"),
                axis.line = element_line(colour = 'black', size = 0.25),
                axis.ticks = element_line(colour = 'black', size = 0.1),
                axis.ticks.length = unit(0.02,"cm"),
                legend.position = "bottom",
                axis.title = element_blank()) )
  dev.off
}
```


##Fig 2C Bar Subtype1/PTGERGroup
```{r}
tmp1 = table(CD8$Identity.Subtype1, CD8$PTGER4.Group.Celltype )
tmp1 = tmp1[!(tmp1[,"Undetected"] ==0 ) , ]
tmp1 = apply(tmp1,1,function(x) x/colSums(tmp1)*100) %>% t() %>% as_tibble(rownames = "Cluster") %>% gather(key = "ID", value = "Pct", -Cluster)
tmp1$Cluster =factor(tmp1$Cluster, levels = levels(CD8$Identity.Subtype1) )
tmp1$ID = factor(tmp1$ID, levels =c("Undetected","Low","Intermediate","High"))
tmp2 = table(CD8$PTGER4.Group.Celltype,CD8$Identity.Subtype1)
tmp2 = tmp2[ , !(tmp2["Undetected",] ==0 )]
tmp2 = apply(tmp2,1,function(x) x/colSums(tmp2)*100) %>% t() %>% as_tibble(rownames = "Cluster") %>% gather(key = "ID", value = "Pct", -Cluster)
tmp2$Cluster =factor(tmp2$Cluster,levels =rev(c("Undetected","Low","Intermediate","High") )  )
tmp2$ID = factor(tmp2$ID, levels =levels(CD8$Identity.Subtype1)  )
tmp1$Set = "Subtype"
tmp2$Set = "PTGER4Group"
tmp = rbind(tmp1,tmp2)

tmp$Set = factor(tmp$Set, levels = c("Subtype","PTGER4Group"))

for(i in 1){
      PDF("Fig.2C_Left.BOC.CD8.PCT.Identity.Subtype1-PTGER4.Group.Celltype.L", w=3.2, h=2.3,r=600)
      print(
            ggplot(tmp,aes(x = ID ,y = Pct,fill = Cluster )) +
                  geom_bar(stat="identity")  +
                  scale_fill_manual(values= c(BOCDF$cols$CD8.Subtype1,rev(c("#400E32","#A61F69","#F2921D","#F2CD5C") ) )) + 
                  theme_classic()+ Dot_axis90B+
                  facet_grid(.~ Set, scales = "free", space="free", switch = "y")+
                  theme(legend.position = "right",
                        axis.text.x = element_text(size =5, family = "Arial", color = "black",angle = 90, hjust =1, vjust =0.3),
                        axis.text.y = element_text(size =5, family = "Arial", color = "black"),
                        axis.line = element_line(colour = 'black', size = 0.5),
                        axis.ticks = element_line(colour = 'black', size = 0.3),
                        axis.ticks.length = unit(0.05,"cm"),
                        axis.title = element_blank(),
                        strip.background = element_blank(),
                        strip.text = element_blank())# + NoLegend()
      )
      dev.off()

}
```


##Fig 2D DE Summary
```{r}
DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.rds")
for(i in c("T_CD8")){
  #Exp = DE[[i]][["FoldChange.Table"]] %>% t() %>% as.data.frame() %>% drop_na() %>% t() %>% as.data.frame()
  #Exp2 = DE[[i]][["FoldChange.Table"]]
  #Exp2[is.na(Exp2)] = 0
  ###Overview
      tmp = DE2[[i]]$FoldChange.Sum[!is.na(DE2[[i]]$FoldChange.Sum[,"Upregulation"]),]
      tmp$Total =tmp$Upregulation+tmp$Downregulation
      df = data.frame("Upregulation" = 0:max(tmp$Total),"Downregulation" = max(tmp$Total):0)
      df$Count = NA
      for(j in 0:max(tmp$Total)){
        tmp1 = filter(tmp, Upregulation == j)
        df[j+1,"Count"] = nrow(tmp1)
        }
      cutoff = (max(tmp$Total)/2)
      tmp1 = colSums(filter(df, Upregulation > (max(tmp$Total)/2) ) )[3]
      tmp2 = colSums(filter(df, Downregulation > (max(tmp$Total)/2) ) )[3]
      for(j in 1){
          PDF(paste0("Fig.2D.BOC.CD8.DESummary.L"),w = 8, h =5,r=500)
          print(
            ggplot(df, aes(x = Upregulation, y = Count) )+ 
              geom_bar(fill = "black",stat="identity") +
              geom_vline(xintercept = cutoff,linetype=2, size =1) + 
              theme_classic()+
              scale_x_continuous(breaks = c(seq(0,15,3)) )+
              theme(axis.text = element_text(size =15,color="black"),
                    plot.title = element_text(size = 6),
                    axis.title = element_blank()
                    )+
              ggtitle(paste0(i, " (PTGER4 High-Low) Favor Downregulation ", tmp2," genes // Favor Upregulation ", tmp1, " genes") )
            )
          dev.off()
          PDF(paste0("Fig.2D.BOC.CD8.DESummary"),w = 4, h =5,r=500)
          print(
            ggplot(df, aes(x = Upregulation, y = Count) )+ 
              geom_bar(fill = "black",stat="identity",width = 0.7) +
              geom_vline(xintercept = cutoff,linetype=2, size =1) + 
              theme_classic()+
              scale_x_continuous(breaks = c(seq(0,15,3)) )+
              theme(axis.text = element_blank(),
                    axis.title = element_blank()
                    )
            )
          dev.off()
          }
}

```

##Fig 2E GSEA Running
```{r}
DE = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype.Converted.GSEA_nperm50K.2300901.rds")
selected.pathway = c("HALLMARK_IL2_STAT5_SIGNALING","HALLMARK_OXIDATIVE_PHOSPHORYLATION","HALLMARK_MYC_TARGETS_V1")
GSEA = DE$GSEA_H2
for(i in c("T_CD8")){
  tmp1 = DE[[i]][["High-Low"]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC) %>% deframe()
  tmp2 = GSEA[[i]] %>% as.data.frame()
  rownames(tmp2) = tmp2$pathway
  for(p in selected.pathway){
    tmp3 = paste0("NES = ",tmp2[p,"NES"],"\n p-value = ", tmp2[p,"pval"],"\n adjusted p-value = ", tmp2[p,"padj"])
    PDF(paste0("Fig.2E.BOC.Bulk.Celltype4.GSEAPlot.",i,".",p),w=5,h=3)
    print(plotEnrichment(fgsea_sets[[p]], tmp1 ,gseaParam = 1,ticksSize = 0.3  ) + ggtitle(paste0(i," | ", p),tmp3)  )
    dev.off()
    tmp = plotEnrichment(fgsea_sets[[p]], tmp1 ,1,0.3  ) + 
      theme_classic() + 
      theme(plot.title = element_blank() , 
            axis.title = element_blank(),
            axis.text = element_text(size =4.5, family = "Arial", color = "black" ) )
    tmp$layers[[1]]$aes_params$colour = "#C02429"
    a = tmp$layers[[3]]$data
    tmp$layers[[6]]$mapping$y = as.numeric(a-0.1)
    tmp$layers[[6]]$mapping$yend= as.numeric(a-0.2)
    tmp$layers[[6]]$aes_params$size=0.3
    tmp$layers[[6]]$aes_params$colour = "#E0575B"
    tmp$layers[[5]] = geom_line(color ="#C02429",size=1)
    tmp$layers[[2]]$aes_params$colour = "black"
    tmp$layers[[3]]$aes_params$colour = "black"
    PDF(paste0("Fig.2E.BOC.Bulk.Celltype.GSEAPlot.",i,".",p,".UL.col2"),w=2.2,h=1)
    print(tmp )
    dev.off()
  }
}
DE$GSEA$T_CD8 %>% filter(pathway %in% selected.pathway)
```

##Fig 2F Heatmap
```{r}
DE2 <- readRDS("~/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.converted.rds")
DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.converted.rds")

df = DE2$df

i = "CD8.Overview2"
selected.cluster = c("T_CD8")
for(i in c("CD8.Overview2") ){
  selected.genes = unlist( GeneSet$DE[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes )  %>% filter(Cluster %in% selected.cluster)
  df1 = pCat(df1,"p_val_adj")
  df1 = GeneGroup(df1, GeneSet$DE[[i]] )
  Fsize = 6
  a = max(abs(df1$avg_log2FC))+0.2 
  plot = ggplot(df1, aes(y = Dataset , x = Genes  ) ) + 
    facet_grid(Cluster ~ Set, scales = "free", space="free", switch = "y") + 
    theme_classic() + 
    Dot_axis90A + 
    ggtitle(i)+
    geom_tile(color = "white",aes(fill =avg_log2FC)) +  
    scale_fill_gradientn(colours = Col.HiLow.7Shades,
                         values =  c( 0,0.43,0.5,0.57,  a ),                                 
                         limits = c(-a,a) ) +
    theme(plot.title = element_blank(),
          axis.text.x = element_text(size =Fsize, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =Fsize, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', size = 0.25),
          axis.ticks = element_line(colour = 'black', size = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          axis.title = element_blank(), 
          strip.text.y = element_blank(),
          strip.text.x.top = element_text(size =Fsize, family = "Arial",colour = "black",
                                          margin = margin(t = 0.1, r = 0, b = 0.1, l = 0, unit = "cm") ),
          strip.background = element_rect(fill = "white",linewidth = 0.35),
          strip.background.y =  element_blank(),
          strip.placement = "outside",
          legend.key.size = unit(0.1, 'in'),
                        legend.title = element_text(size = Fsize),
                        legend.text = element_text(size=Fsize-1),
          
          plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
          legend.position = "bottom"
          )
  
                
  PDF(paste0("Fig.2F.BOC.CD8.DE.perSpec.Heatmap.Celltype.",i), h = 2.4, w = 4.5 )
  print(plot)
  dev.off()
}

```

###Sipplement [omitted] FP 
```{r}
Idents(CD8) = CD8$PTGER4.Group.Celltype4
tmp2 = c("#400E32","#A61F69","#F2921D","#F2CD5C")
names(tmp2) = levels(CD8$PTGER4.Group.Celltype4)
for(i in levels(CD8$PTGER4.Group.Celltype4)){
  tmp = subset(CD8, PTGER4.Group.Celltype4 == i )
  PNG(paste0("BOC.CD45.CD8.PTGER4Group.",i),w= 6,h=6,r=200)
  print(
    DimPlot(tmp,label=F,cols =  tmp2[i]  ,pt.size =0.5 )  + NoLegend()
  )
  dev.off()
}
```



#Figure3 (TIM)
##Fig 3A1 UMAP
```{r}
BOC = readRDS("BOC.PTGER4Group.230713.rds")
Idents(BOC) = BOC$Identity.Celltype2
TIM = subset(BOC, idents = c("TAN-PMN","TIM","TIM_Dividing"))
BOC = 0
TIM = Clustering1(TIM, spread = 1, dist = 1)
Idents(TIM) = TIM$Identity.Subtype1

for(i in 1){
  PNG("Fig.3A.BOC.TIM.Subtype1.pt1",w= 6,h=6)
  print(
    DimPlot(TIM, pt.size = 1, raster =F,
            cols = BOCDF$cols$TIM.Subtype1)  +
      theme(axis.title = element_blank(),
                     axis.text = element_blank(),
                     axis.line = element_line(colour = 'black', size = 1),
                     axis.ticks = element_line(colour = 'black', size = 0.7)) +
    NoLegend()
  )
  
  dev.off()
  PDF("Fig.3A.BOC.TIM.Subtype1.UL",w= 2,h=2)
  print(  
    DimPlot(TIM, 
            cols = BOCDF$cols$TIM.Subtype1, 
            pt.size = 0.01)+
      theme(axis.text = element_text(size =5, family = "Arial", color = "black"),
            axis.title = element_text(size = 5, family = "Arial", color = "black"),
            axis.line = element_line(colour = 'black', size = 0.25),
            axis.ticks = element_line(colour = 'black', size = 0.15),
            axis.ticks.length = unit(0.05,"cm")  
            )  +
      NoLegend()
    )
  dev.off()
  
  
  PDF("Fig.3A.BOC.TIM.Subtype1.L",w= 9,h=6)
  print(  DimPlot(TIM, cols = BOCDF$cols$TIM.Subtype1, pt.size = 1)    )
  dev.off()
}
```

##Fig 3A2 Signature Dotplot
```{r}
#BOCDF$AllMarkers$TIM = FindAllMarkers(TIM, max.cells.per.ident = 200)
BOCDF$AllMarkers$TIM %>% group_by(cluster) %>% top_n(n=30, wt=avg_log2FC)
GeneSet$Markers.TIM = c("CSF3R","ADGRG3","NAMPT","AQP9","CXCL8","FCGR3B","TNFAIP6","CXCR4","VCAN","FCN1","IL1A","IL1B","NLRP3","VEGFA","KYNU","AREG","C1QA","C1QC","APOE","TREM2","TYRO3","AXL","MERTK","HLA-DRA","HLA-DRB5","HLA-DQB1","HLA-DMA","HLA-DQA1","CD206","MKI67","STMN1","TOP2A","TPX2","TUBA1B","TUBB","HIST1H4C")
GeneSet$Markers.TIM2 = c("CSF3R","ADGRG3","CXCL8","FCGR3B","CXCR4","VCAN","IL1A","IL1B","NLRP3","VEGFA","C1QA","C1QC","APOE","TREM2","AXL","MERTK","HLA-DRA","HLA-DRB5","HLA-DQB1","HLA-DMA","MKI67","STMN1","TOP2A","TUBA1B","HIST1H4C")
GeneSet$Markers.TIM3 = c("CSF3R","ADGRG3","CXCL8","FCGR3B","CXCR4","VCAN","IL1B","NLRP3","VEGFA","C1QA","APOE","TREM2","AXL","MERTK","MKI67","STMN1","TOP2A","TUBA1B","HIST1H4C")
Idents(TIM) = TIM$Identity.Subtype1
tmp = DotPlot(TIM, features = GeneSet$Markers.TIM3)$data

for(i in 1){
  PDF("Fig3A2.BOC.TIM.Signature3",w=2.9,h=2.6)
  print(
    ggplot(tmp,aes(y = fct_rev(features.plot), x = id, size =pct.exp, color = avg.exp.scaled))+
      geom_point() + 
      scale_size(range = c(0.5,2.5),breaks = c(20,40,60,80,100),name = "Percent expressed cells")+
      scale_PRainbow +
      scale_y_discrete(position = "left")+
      theme_classic() + 
      theme(plot.title = element_blank(),
                axis.title = element_blank(),
                axis.text.x = element_text(size =5, family = "Arial", color = "black",angle = 90, hjust =1, vjust =0.3),
                axis.text.y = element_text(size =5, family = "Arial", color = "black", face = "italic"),
                axis.line = element_line(colour = 'black', size = 0.25),
                axis.ticks = element_line(colour = 'black', size = 0.15),
                axis.ticks.length = unit(0.05,"cm"),
                legend.position = "right"
                )
  )
  dev.off()
}
for(i in 1){
  PDF("Fig3A2.BOC.TIM.Signature3.Smaller",w=2.8,h=2.3)
  print(
    ggplot(tmp,aes(y = fct_rev(features.plot), x = id, size =pct.exp, color = avg.exp.scaled))+
      geom_point() + 
      scale_size(range = c(0.5,1.8),breaks = c(10,30,50,70,90),name = "Percent expressed cells")+
      scale_PRainbow +
      scale_y_discrete(position = "left")+
      theme_classic() + 
      theme(plot.title = element_blank(),
                axis.title = element_blank(),
                axis.text.x = element_text(size =5, family = "Arial", color = "black",angle = 90, hjust =1, vjust =0.3),
                axis.text.y = element_text(size =5, family = "Arial", color = "black", face = "italic"),
                axis.line = element_line(colour = 'black', size = 0.25),
                axis.ticks = element_line(colour = 'black', size = 0.15),
                axis.ticks.length = unit(0.05,"cm"),
                legend.position = "right"
                )
  )
  dev.off()
}
```

##Fig 3B1 FP (EP2/4)
```{r}
for(i in c("PTGER2","PTGER4")  ){
  PDF(paste0("Fig.3B1.BOC.TIM.FP.",i),h=1.5,w=1.5)
  print(
    FeaturePlot(TIM, i,pt.size = 0.01, cols = col_orange3) +
      theme(plot.title = element_blank(),
            axis.text = element_text(size =5, family = "Arial", color = "black"),
            axis.title = element_text(size = 5, family = "Arial", color = "black"),
            axis.line = element_line(colour = 'black', size = 0.25),
            axis.ticks = element_line(colour = 'black', size = 0.15),
            axis.ticks.length = unit(0.05,"cm")  
            )  +
      NoLegend()
        )
  dev.off()
}
for(i in c("PTGER4")  ){
  PDF(paste0("Fig.3B1.BOC.TIM.FP.L.",i),h=2,w=2)
  print(
    FeaturePlot(TIM, i,pt.size = 0.01, cols = col_orange3) +
      theme(plot.title = element_blank(),
            axis.title = element_text(size =15))
        )
  dev.off()
}

```

##Fig 3B2 pct.exp PGs
```{r}
GeneSet$PGE2B
tmp = DotPlot(TIM, features = GeneSet$PGE2B)$data
tmp$pct.exp.cat = (floor(tmp$pct.exp/10)*10) 
tmp$pct.exp.cat = gsub("^0","<10%",tmp$pct.exp.cat,  perl = T)
tmp$pct.exp.cat = gsub("^10","10-20%",tmp$pct.exp.cat,  perl = T)
tmp$pct.exp.cat = gsub("^20","20-30%",tmp$pct.exp.cat,  perl = T)
tmp$pct.exp.cat = gsub("^30","30-40%",tmp$pct.exp.cat,  perl = T)
tmp$pct.exp.cat = gsub("^40","40-50%",tmp$pct.exp.cat,  perl = T)
tmp$pct.exp.cat = gsub("^50","50-60%",tmp$pct.exp.cat,  perl = T)
tmp$pct.exp.cat = gsub("^60","60-70%",tmp$pct.exp.cat,  perl = T)
tmp$pct.exp.cat = factor(tmp$pct.exp.cat, levels = sort(unique(tmp$pct.exp.cat)) )

for(i in 1){
  PDF(paste0("Fig.3B2.BOC.TIM.DP.PGE2"),w = 2.75,h=1.1)
  print(
    ggplot(tmp, aes(y = fct_rev(id), x = features.plot))+
      geom_point(colour = "black",pch = 21,aes(size = pct.exp.cat, fill = pct.exp.cat) )+
      scale_fill_manual(values=  col_BlueRed2 ) +
      scale_size_manual(values = seq(2,6,0.5))+
      #scale_y_discrete(position = "right")+
      theme_classic()+
      theme(plot.title = element_blank(),
            axis.title = element_blank(),
            axis.text.x = element_text(size =5, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
            axis.text.y = element_text(size =5, family = "Arial", color = "black"),
            axis.line = element_line(colour = 'black', size = 0.25),
            axis.ticks = element_line(colour = 'black', size = 0.15),
            axis.ticks.length = unit(0.05,"cm"),
            legend.position = "right"
                )
  )
  dev.off()

}
tmp %
```


##Fig 3C PTGER4 expression (EP4 Group)
```{r}
Idents(TIM) = TIM$PTGER4.Group.Celltype
tmp2 = c("#400E32","#A61F69","#F2921D","#F2CD5C")
for(i in 1 ){
  PDF("Fig.3C.BOC.TIM.Vln.PTGER4.PTGER4Group.Celltype",w=1,h=2)
  print(
    VlnPlot(TIM, "PTGER4",cols = tmp2, pt.size = 0) + 
      NoLegend() +
      theme(axis.title = element_blank(),
            axis.text.x = element_text(size =5, family = "Arial", color = "black",angle = 90, hjust =1, vjust =0.3),
            axis.text.y = element_text(size =5, family = "Arial", color = "black"),
            plot.title = element_blank())
  )
  dev.off
}
```

##Fig 3D1 DE count Summary
```{r}
DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.converted.rds")

for(i in c("TIM")){
      tmp = DE2[[i]]$FoldChange.Sum[!is.na(DE2[[i]]$FoldChange.Sum[,"Upregulation"]),]
      tmp$Total =tmp$Upregulation+tmp$Downregulation
      df = data.frame("Upregulation" = 0:max(tmp$Total),"Downregulation" = max(tmp$Total):0)
      df$Count = NA
      for(j in 0:max(tmp$Total)){
        tmp1 = filter(tmp, Upregulation == j)
        df[j+1,"Count"] = nrow(tmp1)
        }
      cutoff = (max(tmp$Total)/2)
      tmp1 = colSums(filter(df, Upregulation > (max(tmp$Total)/2) ) )[3]
      tmp2 = colSums(filter(df, Downregulation > (max(tmp$Total)/2) ) )[3]
      for(j in 1){
          PDF(paste0("Fig.3D.BOC.TIM.DESummary.L"),w = 8, h =5)
          print(
            ggplot(df, aes(x = Upregulation, y = Count) )+ 
              geom_bar(fill = "black",stat="identity") +
              geom_vline(xintercept = cutoff,linetype=2, size =1) + 
              theme_classic()+
              scale_x_continuous(breaks = c(seq(0,15,3)) )+
              theme(axis.text = element_text(size =15,color="black"),
                    plot.title = element_text(size = 6),
                    axis.title = element_blank()
                    )+
              ggtitle(paste0(i, " (PTGER4 High-Low) Favor Downregulation ", tmp2," genes // Favor Upregulation ", tmp1, " genes") )
            )
          dev.off()
          PDF(paste0("Fig.3D.BOC.TIM.DESummary"),w = 4, h =5)
          print(
            ggplot(df, aes(x = Upregulation, y = Count) )+ 
              geom_bar(fill = "black",stat="identity",width = 0.7) +
              geom_vline(xintercept = cutoff,linetype=2, size =1) + 
              theme_classic()+
              scale_x_continuous(breaks = c(seq(0,15,3)) )+
              theme(axis.text = element_blank(),
                    axis.title = element_blank()
                    )
            )
          dev.off()
          }
}

```

##Fig 3D2 DE count Summary
```{r}
DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Subtype1.230713.converted.rds")

for(i in c("TIM_C1QA")){
      tmp = DE2[[i]]$FoldChange.Sum[!is.na(DE2[[i]]$FoldChange.Sum[,"Upregulation"]),]
      tmp$Total =tmp$Upregulation+tmp$Downregulation
      df = data.frame("Upregulation" = 0:max(tmp$Total),"Downregulation" = max(tmp$Total):0)
      df$Count = NA
      for(j in 0:max(tmp$Total)){
        tmp1 = filter(tmp, Upregulation == j)
        df[j+1,"Count"] = nrow(tmp1)
        }
      cutoff = (max(tmp$Total)/2)
      tmp1 = colSums(filter(df, Upregulation > (max(tmp$Total)/2) ) )[3]
      tmp2 = colSums(filter(df, Downregulation > (max(tmp$Total)/2) ) )[3]
      for(j in 1){
          PDF(paste0("Fig.3D.BOC.TIM_C1QA.DESummary.L"),w = 8, h =5)
          print(
            ggplot(df, aes(x = Upregulation, y = Count) )+ 
              geom_bar(fill = "black",stat="identity") +
              geom_vline(xintercept = cutoff,linetype=2, size =1) + 
              theme_classic()+
              scale_x_continuous(breaks = c(seq(0,15,3)) )+
              theme(axis.text = element_text(size =15,color="black"),
                    plot.title = element_text(size = 6),
                    axis.title = element_blank()
                    )+
              ggtitle(paste0(i, " (PTGER4 High-Low) Favor Downregulation ", tmp2," genes // Favor Upregulation ", tmp1, " genes") )
            )
          dev.off()
          PDF(paste0("Fig.3D.BOC.TIM_C1QA.DESummary"),w = 4, h =5,r=500)
          print(
            ggplot(df, aes(x = Upregulation, y = Count) )+ 
              geom_bar(fill = "black",stat="identity",width = 0.7) +
              geom_vline(xintercept = cutoff,linetype=2, size =1) + 
              theme_classic()+
              scale_x_continuous(breaks = c(seq(0,15,3)) )+
              theme(axis.text = element_blank(),
                    axis.title = element_blank()
                    )
            )
          dev.off()
          }
}

```

##Fig 3E GSEA Running
```{r}
DE = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype.Converted.GSEA_nperm50K.2300901.rds")
selected.pathway = c("HALLMARK_TNFA_SIGNALING_VIA_NFKB","HALLMARK_INFLAMMATORY_RESPONSE",
                     "HALLMARK_OXIDATIVE_PHOSPHORYLATION","HALLMARK_MYC_TARGETS_V1" )

GSEA = DE$GSEA_H2
for(i in c("TIM")){
  tmp1 = DE[[i]][["High-Low"]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC) %>% deframe()
  tmp2 = GSEA[[i]] %>% as.data.frame()
  rownames(tmp2) = tmp2$pathway
  for(p in selected.pathway){
    tmp3 = paste0("NES = ",tmp2[p,"NES"],"\n p-value = ", tmp2[p,"pval"],"\n adjusted p-value = ", tmp2[p,"padj"])
    PDF(paste0("Fig.2E.BOC.Bulk.Celltype4.GSEAPlot.",i,".",p),w=5,h=3)
    print(plotEnrichment(fgsea_sets[[p]], tmp1 ,gseaParam = 1,ticksSize = 0.3  ) + ggtitle(paste0(i," | ", p),tmp3)  )
    dev.off()
    tmp = plotEnrichment(fgsea_sets[[p]], tmp1 ,1,0.3  ) + 
      theme_classic() + 
      theme(plot.title = element_blank(),
                axis.title = element_blank(),
                axis.text.x = element_text(size =5, family = "Arial", color = "black"),
                axis.text.y = element_text(size =5, family = "Arial", color = "black"),
                axis.line = element_line(colour = 'black', size = 0.25),
                axis.ticks = element_line(colour = 'black', size = 0.15),
                axis.ticks.length = unit(0.05,"cm"),
                legend.position = "bottom"
                )
    tmp$layers[[1]]$aes_params$colour = "#fcb900"
    a = tmp$layers[[3]]$data
    tmp$layers[[6]]$mapping$y = as.numeric(a-0.1)
    tmp$layers[[6]]$mapping$yend= as.numeric(a-0.2)
    tmp$layers[[6]]$aes_params$size=0.3
    tmp$layers[[6]]$aes_params$colour = "#FFD256"
    tmp$layers[[5]] = geom_line(color ="#fcb900",,size=1)
    tmp$layers[[2]]$aes_params$colour = "black"
    tmp$layers[[3]]$aes_params$colour = "black"
    PDF(paste0("Fig.2E.BOC.Bulk.Celltype.GSEAPlot.",i,".",p,".UL.col2"),w=1.7,h=0.9)
    print(tmp )
    dev.off()
  }
}

GSEA$TIM %>% filter(pathway %in% selected.pathway)
```

##Fig 3F Heatmap TIM
```{r}
DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.converted.rds")
df = DE2$df
selected.cluster = c("TIM")
i = "TIM.Overview2"
for(i in c("TIM.Overview2") ){
  selected.genes = unlist( GeneSet$DE[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes )  %>% filter(Cluster %in% selected.cluster)
  df1 = pCat(df1,"p_val_adj")
  df1 = GeneGroup(df1, GeneSet$DE[[i]] )
  Fsize = 5.3
  a = max(abs(df1$avg_log2FC))+0.2 
  plot = ggplot(df1, aes(y = Dataset , x = Genes  ) ) + 
    facet_grid(Cluster ~ Set, scales = "free", space="free", switch = "y") + 
    theme_classic() + 
    geom_tile(color = "white",aes(fill =avg_log2FC)) +  
    scale_fill_gradientn(colours = Col.HiLow.7Shades,
                         #values =  c( 0,0.35,0.46,0.5,0.54,0.65,1 ),
                         values =  c( 0,0.45,0.5,0.55,1 ),     
                         limits = c(-a,a) ) +
    theme(plot.title = element_blank(),
          axis.text.x = element_text(size =Fsize, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =Fsize, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', size = 0.25),
          axis.ticks = element_line(colour = 'black', size = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          axis.title = element_blank(), 
          strip.text.y = element_blank(),
          strip.text.x.top = element_text(size =Fsize, family = "Arial",colour = "black",
                                          margin = margin(t = 0.1, r = 0, b = 0.1, l = 0, unit = "cm") ),
          strip.background = element_rect(fill = "white",linewidth = 0.35),
          strip.background.y =  element_blank(),
          strip.placement = "outside",
          legend.key.size = unit(0.1, 'in'),
                        legend.title = element_text(size = Fsize),
                        legend.text = element_text(size=Fsize-1),
          
          plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
          legend.position = "bottom"
          )
  PDF(paste0("Fig.3F.BOC.TIM.DE.perSpec.Heatmap.Celltype.",i), h = 2, w = 3.3 )
  print(plot)
  dev.off()
}
```

##Fig 3G Heatmap TIM_C1QA
```{r}
DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Subtype1.230713.converted.rds")
df = DE2$df.TIM
df$Cluster %>% unique()
selected.cluster = c("TIM_C1QA")
for(i in c("TIM.Overview2") ){
  selected.genes = unlist( GeneSet$DE[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes )  %>% filter(Cluster %in% selected.cluster)
  df1 = pCat(df1,"p_val_adj")
  df1 = GeneGroup(df1, GeneSet$DE[[i]] )
  Fsize = 5.3
  a = max(abs(df1$avg_log2FC))+0.2 
  plot = ggplot(df1, aes(y = Dataset , x = Genes  ) ) + 
    facet_grid(Cluster ~ Set, scales = "free", space="free", switch = "y") + 
    theme_classic() + 
    geom_tile(color = "white",aes(fill =avg_log2FC)) +  
    scale_fill_gradientn(colours = Col.HiLow.7Shades,
                         values =  c( 0,0.45,0.5,0.55,1 ),                                 
                         limits = c(-a,a) ) +
    theme(plot.title = element_blank(),
          axis.text.x = element_text(size =Fsize, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =Fsize, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', size = 0.25),
          axis.ticks = element_line(colour = 'black', size = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          axis.title = element_blank(), 
          strip.text.y = element_blank(),
          strip.text.x.top = element_text(size =Fsize, family = "Arial",colour = "black",
                                          margin = margin(t = 0.1, r = 0, b = 0.1, l = 0, unit = "cm") ),
          strip.background = element_rect(fill = "white",linewidth = 0.35),
          strip.background.y =  element_blank(),
          strip.placement = "outside",
          legend.key.size = unit(0.1, 'in'),
                        legend.title = element_text(size = Fsize),
                        legend.text = element_text(size=Fsize-1),
          
          plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
          legend.position = "bottom"
          )  
  PDF(paste0("Fig.3F.BOC.TIM_C1QA.DE.perSpec.Heatmap.Subtype1.",i), h = 2, w = 3.3 ) 
  print(plot)
  dev.off()
}
```



#Figure4/Ext 4 (LLC)
##Fig. 4A UMAP Overview
```{r}
LLC <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/LLC/LLC.ReShape.230730.rds")

#LLCDF = list()
LLCDF$Col.Identity.Celltype2 = c("#f57f26","cyan4",
                                 "#252d6b",
                                 "#fcb900","#d51f24",
                                 "#2D3D98","#1e8b40","#a83a2b","#7D387D",
                                 "#7A5532","grey")
LLCDF$Col.Identity.Celltype3 = c("#f57f26","#d51f24","#21578D","#7B3B59","#227856",
                                 "#252d6b","#fcb900",
                                 "#d51f24",
                                 "#2D3D98","#1e8b40","#a83a2b","#7D387D",
                                 "#7A5532","grey")


print(DimPlot(LLC,label =T, 
                    cols = LLCDF$Col.Identity.Celltype2))
Idents(LLC) = LLC$Identity.Celltype2
for(i in 1){
      PDF("Fig.4A.LLC.DM", w=6,h=6)
      print(DimPlot(LLC,label =F, pt.size = 0.1,
                    cols = LLCDF$Col.Identity.Celltype2
                    ) + NoLegend())
      dev.off()
      PDF("Fig.4A.LLC.DM.L", w=9,h=6)
      print(DimPlot(LLC,label =T, 
                    cols = LLCDF$Col.Identity.Celltype2
                    ) ) 
      dev.off()
}
```

##Fig 4B (GSEA Running)
```{r}
DE = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/LLC/DE.LLC.Celltype3.pval.nperm50k.230903.rds")
selected.pathway = c("HALLMARK_OXIDATIVE_PHOSPHORYLATION","HALLMARK_MYC_TARGETS_V1")
selected.pathway = c("HALLMARK_OXIDATIVE_PHOSPHORYLATION")
selected.cluster = c("T_CD8","Mono","TAM")
GSEA = DE$GSEA_H2

col1 = c("#40A8A8","#FED460","#E57377")
names(col1) = selected.cluster
col2 = c("cyan4","#fcb900","#d51f24")
names(col2) = selected.cluster
tmp4 = list()
for(t in c("Day1.5")){
  for(c in selected.cluster ){
    tmp1 = DE[[t]][[c]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC) %>% deframe()
    tmp2 = GSEA[[t]][[c]] %>% as.data.frame()
    rownames(tmp2) = tmp2$pathway
    BOCDF$cols$Celltype
    for(p in selected.pathway){
      tmp3 = paste0("NES = ",tmp2[p,"NES"],"\n p-value = ", tmp2[p,"pval"],"\n adjusted p-value = ", tmp2[p,"padj"])
    #PDF(paste0("Fig.4B.LLC.Celltype3.GSEAPlot.",c,".",t,".",p),w=5,h=3)
    print(plotEnrichment(mfgsea_sets[[p]], tmp1 ,gseaParam = 1,ticksSize = 0.3  ) + 
            ggtitle(paste0(c," | ", t," | ", p),tmp3)  )
    #dev.off()
    tmp = plotEnrichment(mfgsea_sets[[p]], tmp1 ,1,0.3  ) + 
      theme_classic() + 
      theme(plot.title = element_blank() , 
            axis.title = element_blank(),
            axis.text.x = element_text(size =5, family = "Arial", color = "black"),
            axis.text.y = element_text(size =5, family = "Arial", color = "black"),
            axis.line = element_line(colour = 'black', size = 0.25),
            axis.ticks = element_line(colour = 'black', size = 0.15),
            plot.margin = margin(t = 0, r = 0, b = 0, l = 0  )  )
    a = tmp$layers[[3]]$data
    tmp$layers[[6]]$mapping$y = as.numeric(a-0.1)
    tmp$layers[[6]]$mapping$yend= as.numeric(a-0.2)
    tmp$layers[[6]]$aes_params$size=0.13
    tmp$layers[[6]]$aes_params$colour = col2[c]
    tmp$layers[[5]] = geom_line(color =col1[c],size=0.25)
    tmp$layers[[2]]$aes_params$colour = "black"
    tmp$layers[[3]]$aes_params$colour = "black"
    tmp$layers[[1]] = NULL
    #tmp$layers[[1]]$aes_params$colour = col1[c]
    #tmp$layers[[1]]$aes_params$size = 0.01
    #PDF(paste0("Fig.4B.LLC.Celltype3.GSEAPlot.",c,".",t,".",p,".UL"),w=1.5,h=0.7)
    print(tmp )
    #dev.off()
    
    }
  }
}
```





##Fig 4C-D Heatmap (Day1.5/OXPHOS-RPs)
```{r}
df = LLCDF$df.DE.Celltype2
tmp1 = df %>% filter( (Cluster  == "TAM") & (Dataset =="Day1.5") & (p_val >0 ) )  %>% filter(Genes %in% geneSet$Ribosome[["Large subunit"]]) %>% arrange(p_val)
tmp1 = tmp1$Genes[1:17]
tmp2 = df %>% filter( (Cluster  == "TAM") & (Dataset =="Day1.5") & (p_val >0 ) )  %>% filter(Genes %in% geneSet$Ribosome$[["Small subunit"]]) %>% arrange(p_val)
tmp2 = tmp2$Genes[1:17]
geneSet$Ribosome.selected = list("Large subunit" = tmp1, "Small subunit" = tmp2)

tmp1 = df %>% filter( (Cluster  == "TAM") & (Dataset =="Day1.5") & (p_val >0 ) )  %>% filter(Genes %in% geneSet$ETC.Ref2[["Complex I"]]) %>% arrange(p_val)
tmp1 = tmp1$Genes[1:7]
tmp2 = df %>% filter( (Cluster  == "TAM") & (Dataset =="Day1.5") & (p_val >0 ) )  %>% filter(Genes %in% geneSet$ETC.Ref2[["Complex II"]])  %>% arrange(p_val)
tmp2 = tmp2$Genes[1:5]
tmp3 = df %>% filter( (Cluster  == "TAM") & (Dataset =="Day1.5") & (p_val >0 ) )  %>% filter(Genes %in% geneSet$ETC.Ref2[["Complex III"]])  %>% arrange(p_val)
tmp3 = tmp3$Genes[1:7]
tmp4 = df %>% filter( (Cluster  == "TAM") & (Dataset =="Day1.5") & (p_val >0 ) )  %>% filter(Genes %in% geneSet$ETC.Ref2[["Complex IV"]])  %>% arrange(p_val)
tmp4 = tmp4$Genes[1:7]
tmp5 = df %>% filter( (Cluster  == "TAM") & (Dataset =="Day1.5") & (p_val >0 ) )  %>% filter(Genes %in% geneSet$ETC.Ref2[["Complex V"]])  %>% arrange(p_val)
tmp5 = tmp5$Genes[1:7]
geneSet$ETC.selected4 = list("Complex I" = tmp1,
                             "Complex II" = tmp2, 
                             "Complex III" = tmp3, 
                             "Complex IV" = tmp4,
                             "Complex V" = tmp5)


geneSet$ETC.Ribosome =  c(geneSet$ETC.selected4,geneSet$Ribosome.selected)

for(t in  c("Day1.5")){
for(i in  c("ETC.Ribosome") ){
  df1 = filter(df, Dataset == t)
  df1 = GeneGroup(df1, geneSet[[i]] )
  df1 = pCat(df1, "p_val_adj" )
  a = max(abs(df1$avg_log2FC))+0.2 
  Fsize = 5
  plot = ggplot(df1, aes(y = fct_rev(Cluster), x = Genes  ) ) + 
            facet_grid(Dataset ~ Set, scales = "free", space="free", switch = "y") +
            theme_classic() + 
            geom_point(aes(color = avg_log2FC, size = pval_cat))+scale_size_manual(values = c(0.7,1,1.4,1.8) ) + 
            scale_color_gradientn(colours = Col.HiLow.9Shades, 
                                  values = c(0,0.4,0.5,0.6,1 ),
                                  limits = c(-a ,a ))+ 
            theme(plot.title = element_blank(),
                  axis.text.x = element_text(size =Fsize, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
                  axis.text.y = element_text(size =Fsize, family = "Arial", color = "black"),
                  axis.line = element_line(colour = 'black', size = 0.25),
                  axis.ticks = element_line(colour = 'black', size = 0.15),
                  axis.ticks.length = unit(0.05,"cm"),
                  axis.title = element_blank(), 
                  strip.text.y = element_blank(),
                  strip.text.x.top = element_text(size =Fsize, family = "Arial",colour = "black",
                                                  margin = margin(t = 0.1, r = 0, b = 0.1, l = 0, unit = "cm") ),
                  strip.background = element_rect(fill = "white",linewidth = 0.35),
                  strip.background.y =  element_blank(),
                  strip.placement = "outside",
                  legend.key.size = unit(0.1, 'in'),
                  legend.title = element_text(size = Fsize),
                  legend.text = element_text(size=Fsize-1),
                  plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
                  legend.position = "bottom"
          )
                
  PDF(paste0("Fig.4C.LLC.Heatmap.Celltype2.",t,".",i), h = 1.8, w = 6 )
  print(plot)
  dev.off()
}
}

```


##Fig 4E GSEA Running IL2-stat5
```{r}
selected.cluster = c("T_CD8")
GSEA = DE$GSEA_H2
selected.pathway = "HALLMARK_IL2_STAT5_SIGNALING"
for(t in c("Day1.5","Day6")){
  for(c in selected.cluster ){
    tmp1 = DE[[t]][[c]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC) %>% deframe()
    tmp2 = GSEA[[t]][[c]] %>% as.data.frame()
    rownames(tmp2) = tmp2$pathway
    BOCDF$cols$Celltype
    for(p in selected.pathway){
      tmp3 = paste0("NES = ",tmp2[p,"NES"],"\n p-value = ", tmp2[p,"pval"],"\n adjusted p-value = ", tmp2[p,"padj"])
    PDF(paste0("Fig.4B.BOC.Bulk.Celltype.GSEAPlot.",c,".",t,".",p),w=5,h=3)
    print(plotEnrichment(mfgsea_sets[[p]], tmp1 ,gseaParam = 1,ticksSize = 0.3  ) + 
            ggtitle(paste0(c," | ", t," | ", p),tmp3)  )
    dev.off()
    tmp = plotEnrichment(mfgsea_sets[[p]], tmp1 ,1,0.3  ) + 
      theme_classic() + 
      theme(plot.title = element_blank() , 
            axis.title = element_blank(),
            axis.text.x = element_text(size =5, family = "Arial", color = "black"),
            axis.text.y = element_text(size =5, family = "Arial", color = "black"),
            axis.line = element_line(colour = 'black', size = 0.25),
            axis.ticks = element_line(colour = 'black', size = 0.15),
            plot.margin = margin(t = 0, r = 0, b = 0, l = 0  )  )
    a = tmp$layers[[3]]$data
    tmp$layers[[6]]$mapping$y = as.numeric(a-0.1)
    tmp$layers[[6]]$mapping$yend= as.numeric(a-0.2)
    tmp$layers[[6]]$aes_params$size=0.13
    tmp$layers[[6]]$aes_params$colour = col2[c]
    tmp$layers[[5]] = geom_line(color =col1[c],size=0.25)
    tmp$layers[[2]]$aes_params$colour = "black"
    tmp$layers[[3]]$aes_params$colour = "black"
    tmp$layers[[1]] = NULL
    #tmp$layers[[1]]$aes_params$colour = col1[c]
    #tmp$layers[[1]]$aes_params$size = 0.01
    PDF(paste0("Fig.4E.LLC.Celltype3.GSEAPlot.",c,".",t,".",p,".UL"),w=1.5,h=0.7)
    print(tmp )
    dev.off()
    }
  }
}
```
##Fig 4E2 Heatmap IL2R 
```{r}
df = LLCDF$df.DE.Celltype3
selected.cluster = c("T_CD4","T_CD8")
for(i in c("IL2R") ){
  selected.genes = unlist( geneSet[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes ) %>% filter(Cluster %in% selected.cluster)
  df1$Genes = factor(df1$Genes, levels = selected.genes  ) 
  Fsize = 5
  a = max(abs(df1$avg_log2FC))+0.2 
  plot = ggplot(df1, aes(y = fct_rev(Cluster), x = Genes  ) ) + 
                 facet_grid(Dataset ~ . , scales = "free", space="free", switch = "y") +
                  theme_classic() +
                  geom_tile(color = "white",aes(fill =avg_log2FC)) +  
                  scale_fill_gradientn(colours = Col.HiLow.7Shades,
                         values =  c( 0,0.45,0.5,0.55,  1 ),                                 
                         limits = c(-a,a) ) +
    theme(plot.title = element_blank(),
          axis.text.x = element_text(size =Fsize, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =Fsize, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', size = 0.25),
          axis.ticks = element_line(colour = 'black', size = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          axis.title = element_blank(), 
          strip.text.y = element_text(size =Fsize, family = "Arial",colour = "black",
                                          margin = margin(t = 0.1, r = 0, b = 0.1, l = 0, unit = "cm") ),
          strip.background = element_rect(fill = "white",linewidth = 0.35),
          strip.placement = "outside",
          legend.key.size = unit(0.1, 'in'),
                        legend.title = element_text(size = Fsize),
                        legend.text = element_text(size=Fsize-1),
          plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
          legend.position = "right"
          )
                  
                
  PDF(paste0("Fig.4E2.LLC.Heatmap.Celltype3.L.",i), h = 0.85, w = 1.6 )
  print(plot)
  dev.off()
}


```
##Fig 4B New
```{r}
DE = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/LLC/DE.LLC.Celltype2.GSEA.230906.rds")
DE$GSEA_H2$Day1.5$NK
GSEA = DE$GSEA_H2
df = data.frame()
for(t in names(GSEA)){
  for(c in names(GSEA[[t]] )){
    tmp1 = GSEA[[t]][[c]]
    tmp1$Time = t
    tmp1$Cluster = c
    df = rbind(df,tmp1)
  }
}
df$Cluster = factor(df$Cluster, levels = names(DE$Day6))

selected.pathway = c("HALLMARK_TNFA_SIGNALING_VIA_NFKB","HALLMARK_INFLAMMATORY_RESPONSE","HALLMARK_INTERFERON_GAMMA_RESPONSE","HALLMARK_OXIDATIVE_PHOSPHORYLATION","HALLMARK_MYC_TARGETS_V2","HALLMARK_MTORC1_SIGNALING","HALLMARK_GLYCOLYSIS","HALLMARK_IL2_STAT5_SIGNALING","HALLMARK_MYC_TARGETS_V1")

selected.pathway = names(fgsea_sets_H)
df$pathway =factor(df$pathway, arrange(GSEA$Day1.5$Mono,desc(NES) )$pathway )
df
for(i in 1){
  df1 = filter(df, pathway %in% selected.pathway )
  a = max(abs(df1$NES ))+0.2 
  PDF(paste0("Ext.Fig.new.6A.LLC1.GSEA.heatmap"), h = 5, w = 4 )
  print(
    ggplot(df1, aes(x = Cluster, y = fct_rev(pathway), fill = NES)) +
    facet_grid(.~ Time) + 
    geom_tile(colour = "white", aes(fill = NES)) + 
    scale_fill_gradientn(colours = Col.HiLow.7Shades,
                         values = c(0,0.2,0.3,0.5,0.7,0.8,1),
                         name = "NES",
                         breaks = c(-3,-1.5,0,1.5,3),
                         limit = c(-a,a))+
    theme_classic()+
    theme(plot.title = element_blank(),
          axis.text.x = element_text(size =Fsize, family = "Arial", color = "black",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =Fsize, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', linewidth = 0.25),
          axis.ticks = element_line(colour = 'black', linewidth = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          axis.title = element_blank(), 
          strip.text.y = element_blank(),
          strip.text.x.top = element_text(size =Fsize, family = "Arial",colour = "black",
                                          margin = margin(t = 0.02, r = 0, b = 0.02, l = 0, unit = "cm") ),
          strip.background = element_rect(fill = "white",linewidth = 0.35),
          strip.background.y =  element_blank(),
          strip.placement = "outside",
          legend.key.size = unit(0.1, 'in'),
                        legend.title = element_text(size = Fsize,family = "Arial", color = "black"),
                        legend.text = element_text(size=Fsize-1,family = "Arial", color = "black",angle = 90,hjust=0.2,vjust =0.5),
          plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
          legend.position = "bottom"
          )
  )
  dev.off()
}


```



##Supplement
###Number of up/downregulated genes
```{r}
#DE <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/LLC/DE.LLC.Celltype3.230719.rds")
df = data.frame(matrix(ncol=4,nrow = 0))
colnames(df) = c("Cluster","Dataset","Downregulated","Upregulated")
for(t in c("Day1.5")){
  for(c in names(DE[[t]]) ){
    df1 = DE[[t]][[c]] %>% filter(p_val <0.05)
    tmp = summary(df1$avg_log2FC > 0 )
    df[c,] = c(c,t,tmp["FALSE"], tmp["TRUE"])
  }
}
df$Dataset = "Day1.5"
tmp1 = df

df = data.frame(matrix(ncol=4,nrow = 0))
colnames(df) = c("Cluster","Dataset","Downregulated","Upregulated")
for(t in c("Day6")){
  for(c in names(DE[[t]]) ){
    df1 = DE[[t]][[c]]  %>% filter(p_val <0.05)
    tmp = summary(df1$avg_log2FC > 0 )
    df[c,] = c(c,t,tmp["FALSE"], tmp["TRUE"])
  }
}
df$Dataset = "Day6"
df = rbind(tmp1,df) %>% as_tibble()
df = gather(df, key = "Change",value = "Number", -Cluster, -Dataset)
df$Cluster = factor(df$Cluster, levels = names(DE$Day6))
for(i in 1){
  PDF("Fig.4B.Number_of_DE",w=8,h=5)
  print(
    ggplot(df, aes(y=fct_rev(Cluster), x = Number ) )+
      geom_bar(stat = "identity",fill = "black") + 
      #scale_fill_manual(values = c("firebrick","dodgerblue4")) +
      theme_classic() +
      xlim(0,6500)+
      facet_grid(Dataset~Change, scales = "free", space="free",switch = "y") +
      theme(axis.text = element_text(color = "black"),
        axis.text.y = element_text(size = 12,color="black"),
        axis.text.x = element_text(size = 12,color="black"),
        axis.title.y = element_blank(),
        strip.text.x = element_text(size = 12),
        strip.text.y.left = element_text(size = 12,angle=0),
        strip.placement = "outside") 
  )
  dev.off()
}

```
###GSEA Myc/IFNG
```{r}
DE = readRDS("~/RStudioProject/LLC/DE.LLC.Celltype3.230719.rds")

selected.pathway = c("HALLMARK_INTERFERON_GAMMA_RESPONSE","HALLMARK_MYC_TARGETS_V1")
selected.cluster = names(DE$Day6)

for(t in c("Day1.5","Day6")){
  for(c in selected.cluster ){
    tmp1 = DE[[t]][[c]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC)
    ranks = deframe(tmp1)
    tmp2 = GSEA[[t]][[c]] %>% as.data.frame()
    rownames(tmp2) = tmp2$pathway
    for(p in selected.pathway){
      tmp3 = paste0("NES = ",tmp2[p,"NES"],"\n p-value = ", tmp2[p,"pval"],"\n adjusted p-value = ", tmp2[p,"padj"])
      tmp = plotEnrichment(mfgsea_sets[[p]], ranks,0.5,0.3  ) + 
        ggtitle(paste0(c," | ",t," | ", p)) + 
        labs(subtitle = tmp3) +
        theme_classic() + 
        theme(title = element_text(size=5), axis.title = element_blank(),axis.text = element_text(color = "black"))
      tmp$layers[[1]]$aes_params$shape = 21
      tmp$layers[[1]]$aes_params$colour = "black"
      tmp$layers[[1]]$aes_params$fill = "firebrick"
      tmp$layers[[1]]$aes_params$size= 3 
      tmp$layers[[6]]$mapping$y = 0
      tmp$layers[[6]]$mapping$yend= 0
      tmp$layers[[5]] = NULL
      tmp$layers[[2]]$aes_params$colour = "black"
      tmp$layers[[3]]$aes_params$colour = "black"
      PNG(paste0("Spplement.1.LLC.Celltype3.GSEAPlot.",p,".",c,".",t),w=5,h=3,r=300)
      #PDF(paste0("Fig.4E.Unlabel.LLC.",c,".Celltype3.GSEAPlot.",t,".",p),w=5,h=1.8)
      print(tmp )
      dev.off()
    }
  }
}

```

###GSEA NES as position [All cluster + Time]
```{r}
DE <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/LLC/DE.LLC.Celltype3.230719.rds")
GSEA = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/LLC/GSEA.LLC.Celltype3.nperm50k.230823.rds")
selected.pathway = c("HALLMARK_TNFA_SIGNALING_VIA_NFKB","HALLMARK_INFLAMMATORY_RESPONSE" ,"HALLMARK_OXIDATIVE_PHOSPHORYLATION","KEGG_RIBOSOME","HALLMARK_MYC_TARGETS_V1","HALLMARK_GLYCOLYSIS","HALLMARK_INTERFERON_GAMMA_RESPONSE","HALLMARK_IL2_STAT5_SIGNALING","HALLMARK_MTORC1_SIGNALING"    )
selected.pathway = c("HALLMARK_OXIDATIVE_PHOSPHORYLATION","KEGG_RIBOSOME","HALLMARK_MYC_TARGETS_V1")
selected.pathway = c("HALLMARK_OXIDATIVE_PHOSPHORYLATION")

selected.cluster = c("NK","T_CD8","T_CD4","TAN","Mono","TAM","cDC1","cDC2","mregDC")
df = data.frame()
for(t in c("Day1.5","Day6")){
  for(c in selected.cluster ){
  #for(c in c("T_CD8","Mono","TAM")){
    tmp1 = GSEA[[t]][[c]] %>% as.data.frame() %>% filter(pathway %in% selected.pathway)
    tmp1$Cluster = c
    tmp1$Time = t
    df = rbind(df,tmp1)
  }
}
df$pathway = factor(df$pathway, levels = selected.pathway)
df$Cluster = factor(df$Cluster, levels = selected.cluster )
df$Change = "Upregulated"
df$Change[c(df$NES < 0 )] = "Downregulated"
df$Change = factor(df$Change, levels = c("Upregulated","Downregulated"))
a = max(abs(df$NES)) %>% ceiling()
for(i in 1){
  #PDF(paste0("Temporary.Fig.4B1.LLC.NES.All.plot.v2"),w=20,h=18)
  PDF(paste0("Temporary.Fig.4B1.LLC.NES.OXPHOS.plot.v2"),w=14,h=3)
  print(
    ggplot(df, aes(y=fct_rev(Cluster), x = NES ))+
      geom_bar(stat = "identity",aes(fill = Change)) + 
      scale_fill_manual(values = c("firebrick","dodgerblue4")) +
      theme_classic() +
      xlim(-a,a)+
      facet_grid(pathway~Time, scales = "free", space="free",switch = "y") +
      theme(axis.text = element_text(color = "black"),
        axis.text.y = element_text(size = 12,color="black"),
        axis.text.x = element_text(size = 12,color="black"),
        axis.title.y = element_blank(),
        strip.text.x = element_text(size = 12),
        strip.text.y.left = element_text(size = 12,angle=0),
        strip.placement = "outside") 
  )
  dev.off()
}
```


###Heatmap (scale.exp) IFNG
```{r}

DimPlot(TNK)
tmp1 = subset(TNK,idents = "T_CD8")
Idents(tmp1) = tmp1$Batch
tmp1A = subset(tmp1,)
tmp2 = subset(TNK, idents="NK")
Idents(tmp2) = tmp2$ID
tmp3 = subset(TNK, idents = "T_GammaDelta")
Idents(tmp3) = tmp3$ID

tmp4 = DotPlot(tmp1, features = geneSet$IFNG)$data
DotPlot(tmp1, features = geneSet$IFNG) + 
  geom_tile(aes(fill = avg.exp.scaled) )+
  scale_fill_gradientn(colours = Col.HiLow.9Shades)
tmp4
for(c in c("T_CD8","NK","T_GammaDelta")){
  tmp1 = subset(TNK,idents = c)
  tmp2 = subset(tmp1, Batch == "Day1.5")
  tmp3 = subset(tmp1, Batch == "Day6")
  Idents(tmp2) = tmp2$ID
  Idents(tmp3) = tmp2$ID
  print(
    DotPlot(tmp2, features = geneSet$IFNG) + 
      geom_tile(aes(fill = avg.exp.scaled) )+
      scale_fill_gradientn(colours = Col.HiLow.9Shades)+
      ggtitle(c, " | Day1.5")
    
  )
  print(
    DotPlot(tmp3, features = geneSet$IFNG) + 
      geom_tile(aes(fill = avg.exp.scaled) )+
      scale_fill_gradientn(colours = Col.HiLow.9Shades)+
      ggtitle(c, " | Day6")
    
  )
}
```

#Figure 5 (Xue/Schultze Human Macrophage )
```{r}
DE = readRDS("~/RStudioProject/PublicBulkRNA/PAN.Immune.PGE2/GSE47189.Schutze.Macrophage/GSE47189.DE.230717.rds")
```

##Fig 5DEF Xue: Volcano
```{r}
DE <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/GSE47189.Xue.Schultze.Macrophage/DE.Xue.230830.rds")

for(i in names(DE)[c(1,5,6)] ){
  print(i)
  for(p in c("ETC.Ref2")) {
    selected.genes = GeneSet$DE[[p]] %>% unlist() %>% unique() 
    tmp = DE[[i]]
    tmp$logP = (-1)*(log10(tmp$P.Value))
    tmp1 = tmp %>% filter(Symbol %in% selected.genes )
    tmp1$Group = p
    tmp2 = tmp %>% filter(!Symbol %in%  selected.genes )
    tmp2$Group = "other"
    tmp = rbind(tmp1,tmp2)
    #png(filename = paste0("PAN.Immune.PGE2/Fig/230716/GSE47189.",i,".",p,".230716.png"), width = 7, height = 6, units = "in",res=200)
    PNG(paste0("Fig.5.Xue.",i,".",p,".230716"), w=6,h=6.5 )
    print(
      ggplot(tmp, aes(x = logFC, y = logP)) + 
      geom_point(size = 0.05,color ="grey")+
      geom_point(size = 1, aes(color = Group),  data = subset(tmp, Group %in% c(p) ) )+
      geom_text_repel(aes(label = Symbol),
                      color ="black",
                      size =5,
                      fontface ="italic", 
                      data = subset(tmp, Group %in% c(p ) ) , 
                      max.time = 2,
                      max.overlaps = 20,box.padding = 0.5,) +
      scale_color_manual(values= c("brown"))+
      theme_linedraw() +
      theme(legend.position = "bottom",
            #axis.title = element_text(size =16),
            axis.title = element_blank(),
            axis.text = element_text(size = 16)) +
      xlim(-1,1) + ylim(0,5)
    )
    dev.off()
  }
}

for(i in names(DE)[c(1,5,6)] ){
  print(i)
  for(p in c("Ribosome")) {
    selected.genes = GeneSet$DE[[p]] %>% unlist() %>% unique() 
    tmp = DE[[i]]
    tmp$logP = (-1)*(log10(tmp$P.Value))
    tmp1 = tmp %>% filter(Symbol %in% selected.genes )
    tmp1$Group = p
    tmp2 = tmp %>% filter(!Symbol %in%  selected.genes )
    tmp2$Group = "other"
    tmp = rbind(tmp1,tmp2)
    #png(filename = paste0("PAN.Immune.PGE2/Fig/230716/GSE47189.",i,".",p,".230716.png"), width = 7, height = 6, units = "in",res=200)
    PNG(paste0("Fig.5.Xue.",i,".",p,".230716"), w=6,h=6.5 )
    print(
      ggplot(tmp, aes(x = logFC, y = logP)) + 
      geom_point(size = 0.05,color ="grey")+
      geom_point(size = 1, aes(color = Group),  data = subset(tmp, Group %in% c(p) ) )+
      geom_text_repel(aes(label = Symbol),
                      color ="black",
                      size =5,
                      fontface ="italic", 
                      data = subset(tmp, Group %in% c(p ) ) , 
                      max.time = 2,
                      max.overlaps = 22,box.padding = 0.5,) +
      scale_color_manual(values= c("#252D6B"))+
      theme_linedraw() +
      theme(legend.position = "bottom",
            #axis.title = element_text(size =16),
            axis.title = element_blank(),
            axis.text = element_text(size = 16)) +
      xlim(-1,1) + ylim(0,5)
    )
    dev.off()
  }
}


GeneSet$DE$PGE2B = GeneSet$PGE2B
for(i in names(DE)[1:4] ){
  print(i)
  for(p in c("PGE2B")) {
    selected.genes = GeneSet$DE[[p]] %>% unlist() %>% unique() 
    tmp = DE[[i]]
    tmp$logP = (-1)*(log10(tmp$P.Value))
    tmp1 = tmp %>% filter(Symbol %in% selected.genes )
    tmp1$Group = p
    tmp2 = tmp %>% filter(!Symbol %in%  selected.genes )
    tmp2$Group = "other"
    tmp = rbind(tmp1,tmp2)
    #png(filename = paste0("PAN.Immune.PGE2/Fig/230716/GSE47189.",i,".",p,".230716.png"), width = 7, height = 6, units = "in",res=200)
    PNG(paste0("Test.Xue.",i,".",p), w=6,h=6.5 )
    print(
      ggplot(tmp, aes(x = logFC, y = logP)) + 
      ggtitle(i)+
      geom_point(size = 0.05,color ="grey")+
      geom_point(size = 1, aes(color = Group),  data = subset(tmp, Group %in% c(p) ) )+
      geom_text_repel(aes(label = Symbol),
                      color ="black",
                      size =5,
                      fontface ="italic", 
                      data = subset(tmp, Group %in% c(p ) ) , 
                      max.time = 2,
                      max.overlaps = 20,box.padding = 0.5,) +
      scale_color_manual(values= c("brown"))+
      theme_linedraw() +
      theme(legend.position = "bottom",
            #axis.title = element_text(size =16),
            axis.title = element_blank(),
            axis.text = element_text(size = 16)) +
      xlim(-1,1) + ylim(0,5)
    )
    dev.off()
  }
}
```

##Fig 5DEF Xue: GSEA Running
```{r}
DE <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/GSE47189.Xue.Schultze.Macrophage/DE.Xue.230830.rds")
GSEA =DE$GSEA

selected.pathway = c("HALLMARK_MYC_TARGETS_V1","MOOTHA_PGC")
DE$GSEA
for(i in names(DE)[c(1,5,6)] ){
  tmp1 = DE[[i]] 
  tmp1$Genes = tmp1$Symbol
  tmp1 = tmp1 %>% dplyr::select(Genes, logFC) %>% arrange(logFC) 
  tmp1 = tmp1[!is.na(tmp1$Genes),]
  tmp1 = tmp1[!is.na(tmp1$logFC ),]
  tmp2 = GSEA[[i]] %>% as.data.frame()
  rownames(tmp2) = tmp2$pathway
  ranks = deframe(tmp1)
  for(p in selected.pathway){
    #tmp3 = paste0("NES = ",tmp2[p,"NES"],"\n p-value = ", tmp2[p,"pval"],"\n adjusted p-value = ", tmp2[p,"padj"])
    #PDF(paste0("Fig.5D.Xue.GSEAPlot.",i,".",p),w=4,h=2.5)
    #print(plotEnrichment(fgsea_sets[[p]], ranks,gseaParam = 1,ticksSize = 0.3  ) + ggtitle(paste0(i," | ", p),tmp3)  )
    #dev.off()
    tmp = plotEnrichment(fgsea_sets[[p]], ranks,gseaParam = 1,ticksSize = 0.3  ) + 
      theme_classic() + 
      theme(title = element_text(size=12), 
            axis.title = element_blank(),
            axis.text = element_text(color = "black"),
            axis.line = element_line(colour = 'black', size = 0.3) )
    tmp$layers[[1]]$aes_params$colour = "black"
    a = tmp$layers[[3]]$data
    tmp$layers[[6]]$mapping$y = as.numeric(a-0.1)
    tmp$layers[[6]]$mapping$yend= as.numeric(a-0.2)
    tmp$layers[[6]]$aes_params$size=0.1
    tmp$layers[[6]]$aes_params$colour = "grey50"
    tmp$layers[[5]] = geom_line(color ="black",size=0.3)
    tmp$layers[[2]]$aes_params$colour = "black"
    tmp$layers[[3]]$aes_params$colour = "black"
    PNG(paste0("Fig.5D.Xue.GSEAPlot.",i,".",p,".UL"),w=3,h=1.5)
    print(tmp )
    dev.off()
  }
}
tmp
```

#Figure 6 (Invitro/T cell)
##Fig 6B1 Heatmap(Scale) ETC/Ribosome(All) 24hr
```{r}
tmp1 = BOCDF$M2321$Scale # %>% as_tibble(rownames = "Genes")
tmp1$Time = "24hr"
df = tmp1 %>% gather(key ="Sample", value = "Expression",-Time,-Genes) %>% filter(!Expression == "NaN")
df$Sample = factor(df$Sample, levels = c("Veh1","Veh2","Veh3","PGE2_1","PGE2_2","PGE2_3"))

for(i in c("ETC","Ribosome2")  ){
  tmp = GeneGroup(df,  geneSet[[i]] )
  #PNG(paste0("Fig.6B.CD8_RNA-seq.Heatmap(Scale).",i), h = 12, w = c(2.5 + (length(unique(tmp$Genes))*0.3) ))
  PNG(paste0("Fig.6B.CD8_RNA-seq.Heatmap(Scale).24hr.",i), h = 4, w = c(2.5 + (length(unique(tmp$Genes))*0.3) ))
  print(
    ggplot(tmp, aes(x = Genes, y = fct_rev(Sample)  ) ) + 
      facet_grid(.~ Set , scales = "free", space="free", switch = "y")+
      geom_tile(color = "white",aes(fill =Expression) ) +  
      scale_fill_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(tmp$Expression),-0.5,0,0.5,max(tmp$Expression ) ) ) )+
      theme_classic() + Dot_axis90A + 
      theme(plot.title = element_blank(),
                        axis.title = element_blank(), 
                        axis.text.x = element_text(size =16, face = "italic", color = "black"),
                        axis.text.y = element_text(size =16, face = "plain", color = "black"),
                        strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.text.x.top = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "bottom"
                        )+
      ggtitle(i)
  )
  dev.off()
}

```

##Fig 6B1 Heatmap(Scale) ETC/Ribosome(selected) 24hr
```{r}
tmp1 = BOCDF$M2321$Scale # %>% as_tibble(rownames = "Genes")
tmp1$Time = "24hr"
df = tmp1 %>% gather(key ="Sample", value = "Expression",-Time,-Genes) %>% filter(!Expression == "NaN")
df$Sample = factor(df$Sample, levels = c("Veh1","Veh2","Veh3","PGE2_1","PGE2_2","PGE2_3"))

df1 = GeneGroup(df,c(geneSet$ETC.selected2,geneSet$Ribosome.selected ) )
for(i in "ETC.Ribosome"  ){
  tmp = df1
  #PNG(paste0("Fig.6B.CD8_RNA-seq.Heatmap(Scale).",i), h = 12, w = c(2.5 + (length(unique(tmp$Genes))*0.3) ))
  PDF(paste0("Fig.6B.CD8_RNA-seq.Heatmap(Scale).24hr.",i), h = 4, w = c(2.5 + (length(unique(tmp$Genes))*0.3) ))
  print(
    ggplot(tmp, aes(x = Genes, y = fct_rev(Sample)  ) ) + 
      facet_grid(.~ Set , scales = "free", space="free", switch = "y")+
      geom_tile(color = "white",aes(fill =Expression) ) +  
      scale_fill_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(tmp$Expression),-0.5,0,0.5,max(tmp$Expression ) ) ) )+
      theme_classic() + Dot_axis90A + 
      theme(plot.title = element_blank(),
                        axis.title = element_blank(), 
                        axis.text.x = element_text(size =16, face = "italic", color = "black"),
                        axis.text.y = element_text(size =16, face = "plain", color = "black"),
                        strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.text.x.top = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "bottom"
                        )+
      ggtitle(i)
  )
  dev.off()
}
filter(BOCDF$M2331$NormalizedCount, Genes %in% geneSet$Glycolysis2)

```


##Fig 6C1 Heatmap(FC) IL2
```{r}
tmp1 = BOCDF$M2321$DE %>% as_tibble(rownames = "Genes")
tmp1$Time = "24hr"
tmp2 = BOCDF$M2328$DE %>% as_tibble(rownames = "Genes")
tmp2$Time = "48hr"
tmp3 = BOCDF$M2331$DE %>% as_tibble(rownames = "Genes")
tmp3$Time = "60hr"
df = rbind(tmp1,tmp2,tmp3)

for(i in "IL2R" ){
  selected.genes = unlist( geneSet[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes ) 
  df1 = df1[complete.cases(df1),]
  df1$Genes = factor(df1$Genes, levels = selected.genes  )
  df1 = pCat(df1,"padj")
  a = max(abs(df1$log2FoldChange))+0.2 
  plot = ggplot(df1, aes(y = Time, x = Genes  ) ) + 
    theme_classic() +
    geom_tile(color = "white",aes(fill =log2FoldChange)) +  
    scale_fill_gradientn(colours = Col.HiLow.9Shades, values = c(0,0.45,0.5,0.55,1),limits = c(-a,a)  )+
     theme(plot.title = element_blank(),
          axis.text.x = element_text(size =Fsize, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =Fsize, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', size = 0.25),
          axis.ticks = element_line(colour = 'black', size = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          axis.title = element_blank(), 
          strip.text.y = element_blank(),
          strip.text.x.top = element_text(size =Fsize, family = "Arial",colour = "black",
                                          margin = margin(t = 0.1, r = 0, b = 0.1, l = 0, unit = "cm") ),
          strip.background = element_rect(fill = "white",linewidth = 0.35),
          strip.background.y =  element_blank(),
          strip.placement = "outside",
          legend.key.size = unit(0.1, 'in'),
                        legend.title = element_text(size = Fsize),
                        legend.text = element_text(size=Fsize-1),
          plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
          legend.position = "right")
                
  PDF(paste0("Fig.6B.CD8_RNA-seq.Heatmap(FC).",i), h = 0.6, w = 1.5 )
  print(plot)
  dev.off()
}
```
##Fig 6C2 Heatmap(Scale) IL2
```{r}
tmp1 = BOCDF$M2321$Scale
tmp1$Time = "24hr"
tmp2 = BOCDF$M2328$Scale 
tmp2$Time = "48hr"
tmp3 = BOCDF$M2331$Scale 
tmp3$Time = "60hr"
df = rbind(tmp1,tmp2,tmp3) %>% gather(key ="Sample", value = "Expression",-Time,-Genes) %>% filter(!Expression == "NaN")
df$Sample = factor(df$Sample, levels = c("Veh1","Veh2","Veh3","PGE2_1","PGE2_2","PGE2_3"))
for(i in "IL2R" ){
  tmp = filter(df, Genes %in% geneSet[[i]])
  PDF(paste0("Fig.6C.CD8_RNA-seq.Heatmap(Scale).",i), h =1.25,w=1.75 )
  print(
    ggplot(tmp, aes(x = Sample, y = fct_rev(Genes)  ) ) + 
      facet_grid(. ~ Time , scales = "free", space="free", switch = "y")+
      geom_tile(color = "white",aes(fill =Expression) ) +  
      scale_fill_gradientn(colours = Col.HiLow.9Shades, values =  c(0,0.45,0.5,0.55,1), limits = c(-a,a)  )+
      theme_classic() + 
      theme(plot.title = element_blank(),
          axis.text.x = element_text(size =Fsize, family = "Arial", color = "black",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =Fsize, family = "Arial", color = "black", face = "italic"),
          axis.line = element_line(colour = 'black', size = 0.25),
          axis.ticks = element_line(colour = 'black', size = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          axis.title = element_blank(), 
          strip.text.y = element_blank(),
          strip.text.x.top = element_text(size =Fsize, family = "Arial",colour = "black",
                                          margin = margin(t = 0.1, r = 0, b = 0.1, l = 0, unit = "cm") ),
          strip.background = element_rect(fill = "white",linewidth = 0.35),
          strip.background.y =  element_blank(),
          strip.placement = "outside",
          legend.key.size = unit(0.1, 'in'),
                        legend.title = element_text(size = Fsize),
                        legend.text = element_text(size=Fsize-1),
          
          plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
          legend.position = "bottom"
          )
  )
  dev.off()
}

```


##Fig 6F Heatmap(Scale) Glycolysis 24-48-60hr
```{r}
tmp1 = BOCDF$M2321$Scale # %>% as_tibble(rownames = "Genes")
tmp1$Time = "24hr"
tmp2 = BOCDF$M2328$Scale # %>% as_tibble(rownames = "Genes")
tmp2$Time = "48hr"
tmp3 = BOCDF$M2331$Scale # %>% as_tibble(rownames = "Genes")
tmp3$Time = "60hr"
df = rbind(tmp1,tmp2,tmp3) %>% gather(key ="Sample", value = "Expression",-Time,-Genes) %>% filter(!Expression == "NaN")
df$Sample = factor(df$Sample, levels = c("Veh1","Veh2","Veh3","PGE2_1","PGE2_2","PGE2_3"))

for(i in c("Glycolysis3") ){
  tmp = filter(df, Genes %in% unlist(geneSet[[i]]))
  tmp$Set = "Glycolysis"
  #PNG(paste0("Fig.6B.CD8_RNA-seq.Heatmap(Scale).",i), h = 12, w = c(2.5 + (length(unique(tmp$Genes))*0.3) ))
  PDF(paste0("Fig.6F.CD8_RNA-seq.Heatmap(Scale).V2.",i), h = 8, w = c(2.5 + (length(unique(tmp$Genes))*0.3) ))
  print(
    ggplot(tmp, aes(x = Genes, y = fct_rev(Sample)  ) ) + 
      facet_grid(Time ~ Set , scales = "free", space="free", switch = "y")+
      geom_tile(color = "white",aes(fill =Expression) ) +  
      scale_fill_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(tmp$Expression),-0.5,0,0.5,max(tmp$Expression ) ) ) )+
      theme_classic() + Dot_axis90A + 
      theme(plot.title = element_blank(),
                        axis.title = element_blank(), 
                        axis.text.x = element_text(size =16, face = "italic", color = "black"),
                        axis.text.y = element_text(size =16, face = "plain", color = "black"),
                        strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.text.x.top = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "bottom"
                        )+
      ggtitle(i)
  )
  dev.off()
}

```

##Fig 6G GSEA [Running] BOC Glycolysis
```{r}
DE <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype.Converted.GSEA_nperm50K.230821.rds")
DE <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype.Converted.GSEA_nperm50K.2300901.rds")
selected.pathway = c("MOOTHA_GLYCOLYSIS")
GSEA = DE$GSEA2

tmp4 = c("#D51F24","#fcb900")
names(tmp4) = c("T_CD8","TIM")
tmp5 = c("#EE5358","#FFD256")
names(tmp5) = c("T_CD8","TIM")

for(i in c("T_CD8","TIM")){
  tmp1 = DE[[i]][["High-Low"]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC)
  tmp2 = GSEA[[i]] %>% as.data.frame()
  rownames(tmp2) = tmp2$pathway
  ranks = deframe(tmp1)
  for(p in selected.pathway){
    tmp3 = paste0("NES = ",tmp2[p,"NES"],"\n p-value = ", tmp2[p,"pval"],"\n adjusted p-value = ", tmp2[p,"padj"])
    tmp = plotEnrichment(fgsea_sets[[p]], ranks,gseaParam = 1,ticksSize = 0.3  ) + 
      #ggtitle(paste0(i," | ", p),tmp3) + 
      theme_classic() + 
      theme(title = element_text(size=5), axis.title = element_blank(),axis.text = element_text(color = "black"))
    #tmp$layers[[1]]$aes_params$shape = 21
    #tmp$layers[[1]]$aes_params$fill = "firebrick"
    tmp$layers[[1]]$aes_params$colour = tmp4[i]
    tmp$layers[[1]]$aes_params$size= 0.2
    a = tmp$layers[[3]]$data
    tmp$layers[[6]]$mapping$y = as.numeric(a-0.1)
    tmp$layers[[6]]$mapping$yend= as.numeric(a-0.2)
    tmp$layers[[6]]$aes_params$size=0.3
    tmp$layers[[6]]$aes_params$colour = tmp5[i]
    tmp$layers[[5]]$aes_params$colour = tmp4[i]
     tmp$layers[[5]]$aes_params$size =1
    #tmp$layers[[5]] = geom_line(color ="black")
    #tmp$layers[[5]] = geom_smooth(se = F,color ="black")
    tmp$layers[[2]]$aes_params$colour = "black"
    tmp$layers[[3]]$aes_params$colour = "black"
    PDF(paste0("Fig.6G.BOC.Bulk.Celltype.GSEAPlot.V2.",i,".",p,".Unlabel"),w=4,h=2)
    print(tmp )
    dev.off()
  }
}
DE$GSEA$TIM %>% filter(pathway %in% selected.pathway)
DE2$GSEA2$T_CD8 %>% filter(pathway %in% c(selected.pathway,"MOOTHA_PGC") )
DE2$GSEA2
```

###GSEA by GGGSEA
```{r}
tmp1  = DE[["T_CD8"]][["High-Low"]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(desc(avg_log2FC))
ranks = deframe(tmp1)
tmp2 = list("Mootha_Glycolysis" =fgsea_sets$MOOTHA_GLYCOLYSIS )
df <- gseaCurve(ranks, tmp2)
ggplot2::ggplot() +   geom_gsea(df)
```
```{r}
for(i in c(0.2,0.5,1,2)){
  print(plotEnrichment(fgsea_sets[[p]], ranks,i,1  ) )
}
```

#=====================
#Ext Figure 1 Overview
##Ext Fig 1A UMAP per cancer
```{r}
Idents(BOC) = BOC$Identity.Celltype4
for(i in unique(BOC$Cancer)){
  tmp = subset(BOC, Cancer == i)
  PNG(paste0("Ext.Fig.1A.BOC.DM.pt01.",i),w=6,h=6)
      print(DimPlot(tmp,label =F,pt.size = 0.1 ,raster = F,
                    cols = BOCDF$cols$Celltype4
                    ) + NoLegend() + 
              theme(axis.title = element_blank(),
                    axis.text = element_blank(),
                    axis.line = element_line(colour = 'black', size = 1),
                    axis.ticks = element_line(colour = 'black', size = 0.7))
            )
      dev.off()
}
for(i in unique(BOC$Cancer)){
  tmp = subset(BOC, Cancer == i)
  PDF(paste0("Ext.Fig.1A.BOC.DM.pt01.",i),w=2,h=2)
      print(DimPlot(tmp,label =F,pt.size = 0.01 ,raster = F,
                    cols = BOCDF$cols$Celltype4
                    ) + NoLegend() + 
              theme(axis.title = element_text(size=5,family = "Arial"),
                    axis.text = element_text(size=4,family = "Arial"),
                    axis.line = element_line(colour = 'black', size = 0.5),
                    axis.ticks = element_line(colour = 'black', size = 0.3))
            )
      dev.off()
}
```

##Ext Fig 1B Signature Celltype4 Div
```{r}
tmp1 = c("NCAM1","KLRD1","KLRC3","CD8A","GZMH","GZMK","CD4","RORA","IL7R","FOXP3","CTLA4","IL2RA","CSF1R","CSF3R","IL1B","HLA-DRA","HLA-DQB1","CD86","MS4A1","CD79A","TCF4","JCHAIN","IGHG1","IGKC","MKI67","STMN1","HMGB1")

Idents(BOC) = BOC$Identity.Celltype2
BOC <- RenameIdents(BOC,
                    'NK' = "NK",
                    'NK_Dividing' = "NK (Dividing)",
                    'T_CD8' = "CD8 T cell",
                    'T_CD8_Dividing' = "CD8 T cell (Dividing)",
                    'T_CD4' = "CD4 T cell",
                    'T_CD4_Dividing' = "CD4 T cell (Dividing)",
                    'T_CD4_FOXP3' = "regulatory T cell",
                    'T_CD4_FOXP3_Dividing' = "regulatory T cell (Dividing)",
                    'TAN-PMN' = "TIM",
                    'TIM' = "TIM",
                    'TIM_Dividing' = "TIM (Dividing)",
                    'cDC1' = "DC",
                    'cDC2' = "DC",
                    'mregDC' = "DC",
                    'pDC' = "DC",
                    'B_cell' = "B cell",
                    'Plasma_cell' = "Plasma cell",
                    'B-Plasma_cell_Dividing' = "B cell & Plasma cell (Dividing)")
BOC$Identity.Celltype4Div = Idents(BOC)

##Signature of Celltype2
#tmp1 = c(tmp1$gene,"Mki67","STMN1","HIST1H4C","HMFB2","MKI67","TOP2A","TUBA1B") %>% unique()
Idents(BOC) = RevIden(BOC$Identity.Celltype4Div)
for(i in 1){
  PDF("Ext.Fig.1B.BOC.Signature.Celltype4Div",w=3.5,h=2.1,r=500)
  print(DotPlot(BOC, features = tmp1)  + 
          scale_viridis + 
          scale_size(range = c(0.1,1.5),name = "Percent expressed cells")+
          theme(axis.text.x = element_text(size =4.5, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
                axis.text.y = element_text(size =4.5, family = "Arial", color = "black"),
                axis.line = element_line(colour = 'black', size = 0.5),
                axis.ticks = element_line(colour = 'black', size = 0.3),
                axis.ticks.length = unit(0.05,"cm"),
                legend.position = "bottom",
                axis.title = element_blank()) )
  dev.off()
}
DotPlot(BOC, features = tmp1) + scale_viridis + Dot_axis90A + Dot_scale
```

##Ext Fig 1C Violin PG gene
```{r}
tmp = FetchData(BOC, vars = c("Identity.Celltype4",GeneSet$PGE2)) %>% as_tibble() %>% gather(key="Genes", value = "Exp", -Identity.Celltype4)
tmp1 = filter(tmp, Genes %in% c("PTGS1","PTGS2","PTGER1","PTGER2","PTGER3","PTGER4"))
tmp1$Genes = factor(tmp1$Genes, levels = c("PTGS1","PTGS2","PTGER1","PTGER2","PTGER3","PTGER4") )
for(i in 1){
  PNG(paste0("Ext.Fig.1C.BOC.PGE2.Vln"),w = 4,h=7,r=500)
  print(
    ggplot(tmp1,aes(x = Identity.Celltype4, y = Exp, fill = Identity.Celltype4)) + 
      #geom_jitter(size = 0.1,alpha =0.1) + 
      geom_violin(scale = "width") +
      scale_fill_manual( values = BOCDF$cols$Celltype4) + 
      facet_grid(Genes~. , switch = "y" , scales =  "free") +
      theme_classic()+
      theme(axis.text = element_text(color = "black"),
            axis.text.x = element_text(size =5, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
            axis.title = element_blank(),
            strip.text.y.left = element_text(face="italic", size =5,color = "white"),
            strip.background = element_rect(fill = "black"),
            strip.placement = "outside") + 
      NoLegend()
  )
  dev.off()
}

tmp1$Genes = factor(tmp1$Genes, levels = rev(c("PTGS1","PTGS2","PTGER1","PTGER2","PTGER3","PTGER4") ))
for(i in 1){
  PDF(paste0("Ext.Fig.1C.BOC.PGE2.Vln.flip_Y_text"),w = 1.7,h=3,r=500)
  print(
    ggplot(tmp1,aes(x = Identity.Celltype4, y = Exp, fill = Identity.Celltype4)) + 
      #geom_jitter(size = 0.1,alpha =0.1) + 
      geom_violin(scale = "width") +
      scale_fill_manual( values = BOCDF$cols$Celltype4) + 
      facet_grid(Genes~. , switch = "y" , scales =  "free") +
      theme_classic()+
      theme(axis.text = element_text(color = "black"),
            axis.text.x = element_text(size =4, family = "Arial", color = "black",angle = 90, hjust =1, vjust =0.3),
            axis.text.y = element_text(size =4, family = "Arial", color = "black",angle=90,hjust=0.5),
            axis.title = element_blank(),
            strip.text.y.left = element_text(face="italic", size =4,color = "white"),
            strip.background = element_rect(fill = "black"),
            strip.placement = "outside") + 
      NoLegend()
  )
  dev.off()
}

```
##Ext Fig 1D Public data
```{r}
Wu <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/SunnyWu2021.Harmony.221024.rds")
#Wu = Clustering1(Wu, dist = 1, spread = 1,group = "orig.ident" )
#saveRDS(Wu,"~/RStudioProject/scRNA/Wu.230820.rds")
Wu = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/Wu.230820.rds")
Idents(Wu) = Wu$Identity.primary
for(i in 1){
  PNG(paste0("Ext.Fig.1D.Wu.DM"),w = 6,h=6)
  print(DimPlot(Wu,label=F,pt.size=0.1, cols= c("#52a675","#4267ac","#6a4c93","#ff5c33","#ffca3a","#ff8133","#ff1f26" ),raster = F ) +
          theme(axis.title = element_blank(),
                    axis.text = element_blank(),
                    axis.line = element_line(colour = 'black', size = 1),
                    axis.ticks = element_line(colour = 'black', size = 0.7))+
          NoLegend())
  dev.off()
  PDF(paste0("Ext.Fig.1D.Wu.DM.L"),w = 8,h=5,r=500)
  print(DimPlot(Wu,label=T,pt.size=0.01, cols= c("#52a675","#4267ac","#6a4c93","#ff5c33","#ffca3a","#ff8133","#ff1f26" ) ) )
  dev.off()
}
#BOCDF$AllMarkers$Wu.Primary = FindAllMarkers(Wu, max.cells.per.ident = 100)
#BOCDF$AllMarkers$Wu.Primary  %>% group_by(cluster) %>% top_n(n=30,wt=avg_log2FC)
tmp1 = c("CD3E","CD8A","RORA","FOXP3","MS4A1","CD79A","CD37","JCHAIN","IGHG1","IGKC","CSF1R","CSF3R","IL1B","KRT8","KRT18","EPCAM","COL1A2","COL6A2","SOD3","PECAM1","VWF","PLVAP")
df = DotPlot(Wu,features = unique(tmp1) )$data
for(i in 1){
  PDF("Ext.Fig.1D.Wu.Signature", w=0.9,h=2.4,r=500)
  print(ggplot(df, aes(y = fct_rev(features.plot), x = id, fill = avg.exp.scaled)) + 
          geom_tile(color = "white")+ scale_fill_gradientn(colours = col_viridis2) + theme_classic()+
          scale_y_discrete(position = "right")+
          theme(axis.text.x = element_text(size =4, family = "Arial", color = "black",angle = 90, hjust =1, vjust =0.3),
                axis.text.y = element_text(size =4, family = "Arial", color = "black",face = "italic"),
                axis.line = element_line(colour = 'black', size = 0.5),
                axis.ticks = element_line(colour = 'black', size = 0.3),
                axis.ticks.length = unit(0.05,"cm"),
                legend.position = "bottom",
                axis.title = element_blank()) )
  dev.off()
}
for(i in c("PTGS1","PTGS2" ) ){
  PNG(paste0("Ext.Fig.1D.Wu.FP.V1.NoTitle.",i),h=6,w=6)
  print(
    FeaturePlot(Wu, i,pt.size = 0.03, cols = col_orange3,raster = F) +
      theme(plot.title = element_blank(),
            axis.title = element_blank(),
                    axis.text = element_blank(),
                    axis.line = element_line(colour = 'black', size = 1),
                    axis.ticks = element_line(colour = 'black', size = 0.7))+
      NoLegend()
        )
  dev.off()
 }
Wu = NULL
```


```{r}
tmp1 = c("CD3E","CD8A","RORA","FOXP3","MS4A1","CD79A","CD37","JCHAIN","IGHG1","IGKC","CSF1R","CSF3R","IL1B","KRT8","KRT18","EPCAM","COL1A2","COL6A2","SOD3","PECAM1","VWF","PLVAP")
#Weiguo <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA.Public/Weiguo.Harmony.221024.rds")
#Weiguo = Clustering1(Weiguo, dist =1 , spread =1, group = "Sample")
#saveRDS(Weiguo, "~/RStudioProject/scRNA/Weiguo.230820.rds")
Weiguo <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/Weiguo.230820.rds")
Weiguo$Sample %>% as.factor() %>% summary()
Weiguo = subset(Weiguo, Sample %in% c("Cancer1","Cancer2","Cancer3","Cancer4","Cancer5","Cancer6","Cancer7"))
Weiguo = Clustering1(Weiguo, dist =2, spread = 1)
#Weiguo = RunUMAP(Weiguo, reduction = "harmony", dims = 1:30, min.dist = 2, spread = 1 )


Idents(Weiguo) = Weiguo$Identity.primary
for(i in 1){
  PNG(paste0("Ext.Fig.1D.Weiguo.DM"),w = 6,h=6)
  print(DimPlot(Weiguo,label=F,pt.size=0.3,
                cols= c("#52a675","#4267ac","#6a4c93","#ff5c33","#ffca3a","#ff8133","#ff1f26" ),raster = F  ) +
          theme(axis.title = element_blank(),
                    axis.text = element_blank(),
                    axis.line = element_line(colour = 'black', size = 1),
                    axis.ticks = element_line(colour = 'black', size = 0.7))+
          NoLegend() )
  dev.off()
  PDF(paste0("Ext.Fig.1D.Weiguo.DM.L"),w = 8,h=5)
  print(DimPlot(Weiguo,label=T,pt.size=0.3, cols= c("#52a675","#4267ac","#6a4c93","#ff5c33","#ffca3a","#ff8133","#ff1f26" ) ) )
  dev.off()
}
tmp1 = c("CD3E","CD8A","RORA","FOXP3","MS4A1","CD79A","CD37","JCHAIN","IGHG1","IGKC","CSF1R","CSF3R","IL1B","KRT8","KRT18","EPCAM","COL1A2","COL6A2","SOD3","PECAM1","VWF","PLVAP")
df = DotPlot(Weiguo,features = unique(tmp1) )$data
for(i in 1){
  PDF("Ext.Fig.1D.Weiguo.Signature", w=0.9,h=2.4,r=500)
  print(ggplot(df, aes(y = fct_rev(features.plot), x = id, fill = avg.exp.scaled)) + 
          geom_tile(color = "white")+ scale_fill_gradientn(colours = col_viridis2) + theme_classic()+
          scale_y_discrete(position = "right")+
          theme(axis.text.x = element_text(size =4, family = "Arial", color = "black",angle = 90, hjust =1, vjust =0.3),
                axis.text.y = element_text(size =4, family = "Arial", color = "black",face = "italic"),
                axis.line = element_line(colour = 'black', size = 0.5),
                axis.ticks = element_line(colour = 'black', size = 0.3),
                axis.ticks.length = unit(0.05,"cm"),
                legend.position = "bottom",
                axis.title = element_blank()) )
  dev.off()
}  
  
for(i in c("PTGS1","PTGS2" ) ){
  PNG(paste0("Ext.Fig.1D.Weiguo.FP.V1.NoTitle.",i),h=6,w=6)
  print(
    FeaturePlot(Weiguo, i,pt.size = 0.3, cols = col_orange3,raster = F) +
      theme(plot.title = element_blank(),
            axis.title = element_blank(),
                    axis.text = element_blank(),
                    axis.line = element_line(colour = 'black', size = 1),
                    axis.ticks = element_line(colour = 'black', size = 0.7))+
      NoLegend()
        )
  dev.off()
}

for(i in c("PTGS2")){
  PDF(paste0("Ext.Fig.1D.Weiguo.FP.V1.L",i),h=5,w=6,r=500)
  print(  FeaturePlot(Weiguo, i,pt.size = 0.01, cols = col_orange3, raster = F)      )
  dev.off()
}  
Weiguo = NULL
```

#Ext Figure 2 BOC CD8
##Ext Fig 2A Signature of CD8
```{r}
BOCDF$AllMarkers$CD8.Subtype1 = FindAllMarkers(CD8, max.cells.per.ident = 100)
tmp1 = BOCDF$AllMarkers$CD8.Subtype1 %>% group_by(cluster) %>% top_n(n=20, wt =avg_log2FC) %>% unique()

Idents(CD8) = CD8$Identity.Subtype1 
tmp2 = DotPlot(CD8,features = unique(tmp1$gene))$data  
for(i in 1){
  PNG("BOC.CD8.Signature.Unsup",w=40,h=6,r=200)
  print( 
    ggplot(tmp2,aes(y = fct_rev(id), x = features.plot, size =pct.exp, color = avg.exp.scaled))+
      geom_point() + 
      scale_PRainbow +
      theme_classic() + 
      scale_y_discrete(position = "left")+
      theme(text = element_text(color = "black"),
            axis.text.y.right = element_text(face="italic",color = "black"),
            axis.text.x = element_text(angle = 90, hjust=1, vjust =0.3,color = "black"),
            axis.title = element_blank())
  )
  dev.off()
}

tmp1 = c("CD3D","CD8A","CD8B","TCF7","BACH2","IL7R","GZMK","BCL11B","NAA50","HAVCR2","ENTDP1","ITGAE","GNLY","PRF1","GZMH","IFIT1","ISG15","MX1","RORA","CCR6","IL12RB2","TNFRSF4","TNFRSF18","MAF","FOXP3","BATF","IL2RA","MKI67","STMN1","TOP2A")
Idents(CD8) = CD8$Identity.Subtype1 
tmp2 = DotPlot(CD8,features = tmp1)$data  
for(i in 1){
  PDF("Ext.Fig.2A.BOC.CD8.Signature.v2",w=3.8,h=2.3)
  print( 
    ggplot(tmp2,aes(y = fct_rev(id), x = features.plot, size =pct.exp, color = avg.exp.scaled))+
      geom_point() + 
      scale_PRainbow +
      scale_size(range = c(0.1,2.7),name = "Percent expressed cells",breaks = c(20,40,60,80))+
      theme_classic() + 
      theme(plot.title = element_blank(),
                axis.title = element_blank(),
                axis.text.x = element_text(size =6, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
                axis.text.y = element_text(size =6, family = "Arial", color = "black"),
                axis.line = element_line(colour = 'black', size = 0.25),
                axis.ticks = element_line(colour = 'black', size = 0.15),
                axis.ticks.length = unit(0.05,"cm"),
                legend.position = "bottom"
                )
  )
}
```

##[omitted] pct expression PG genes
```{r}
Idents(CD8) = CD8$Identity.Subtype1 
tmp = DotPlot(CD8, features = GeneSet$PGE2[6:9])$data
tmp$pct.exp.cat = (floor(tmp$pct.exp/10)*10) %>% as.factor()
for(i in 1){
  #PNG(paste0("BOC.CD45.CD8.DP.PGE2"),w = 2.2,h=3.4,r=500)
  PNG(paste0("BOC.CD45.CD8.DP.PGE2.H"),w = 3,h=3,r=500)
  print(
    ggplot(tmp, aes(x = id, y = features.plot))+
      geom_point(colour = "black",pch = 21,aes(size = pct.exp.cat, fill = pct.exp.cat) )+
      scale_fill_manual(values=  c("#01295f","#1c51be","#52b893","#f5d62e","#f86624","firebrick") ) +
      scale_size_manual(values = seq(1,6,1))+
      scale_y_discrete(position = "right")+
      theme_classic()+
      theme(axis.text = element_text(color = "black"),
            axis.title = element_blank(),
            axis.text.x = element_text(angle = 90, hjust =1,vjust =0.3), legend.position = "bottom",
            axis.text.y = element_text(face = "italic")
            )
  )
  dev.off()
}
```


##Ext Fig 2B Fraction per specimen
```{r}
tmp1 = CD8[[]] %>% dplyr::select(Batch.scRNA,Identity.Subtype1)
tmp1 = table(CD8$Identity.Subtype1, CD8$Batch.scRNA )
tmp1 = apply(tmp1,1,function(x) x/colSums(tmp1)*100) %>% t() %>% as_tibble(rownames = "Cluster") %>% gather(key = "ID", value = "Pct", -Cluster)
tmp1$Cluster =factor(tmp1$Cluster, levels = levels(CD8$Identity.Subtype1) )
tmp1$Cancer = NA
tmp1$Cancer[grep("BRCA",tmp1$ID)] = "BRCA"
tmp1$Cancer[grep("CRC",tmp1$ID)] = "CRC"
tmp1$Cancer[grep("OVCA",tmp1$ID)] = "OVCA"
tmp1 = tmp1[grep("T_CD8",tmp1$Cluster),]

tmp2 = table(CD8$Identity.Subtype1, CD8$Cancer)
tmp2 = apply(tmp2,1,function(x) x/colSums(tmp2)*100) %>% t() %>% as_tibble(rownames = "Cluster") %>% gather(key = "Cancer", value = "Pct", -Cluster)
tmp2$Cluster =factor(tmp2$Cluster, levels = levels(CD8$Identity.Subtype1) )
tmp2 = tmp2[grep("T_CD8",tmp2$Cluster),]

tmp2$ID = tmp2$Cancer
tmp2$Cancer = "All"
colnames(tmp2)
tmp = rbind(tmp1,tmp2)
for(i in 1){
      PDF("Ext.Fig.2B_right.BOC.CD8.PCT.Identity.Subtype1", w=3.2,h=1.5,r=500)
      print(
            ggplot(tmp,aes(x = ID ,y = Pct,fill = Cluster )) +
                  geom_bar(stat="identity")  +
                  scale_fill_manual(values= BOCDF$cols$CD8.Subtype1 ) + 
                  theme_classic()+ Dot_axis90B+
                  facet_grid(.~ Cancer, scales = "free", space="free", switch = "y")+
                  theme(plot.title = element_blank(),
                        axis.title = element_blank(),
                        axis.text.x = element_text(size =5, family = "Arial", color = "black",angle = 90, hjust =1, vjust =0.3),
                        axis.text.y = element_text(size =5, family = "Arial", color = "black"),
                        axis.line = element_line(colour = 'black', size = 0.25),
                        axis.ticks = element_line(colour = 'black', size = 0.15),
                        axis.ticks.length = unit(0.05,"cm"),
                        strip.background = element_rect(fill = "white"),
                        strip.text.x.top = element_text(size =5, family = "Arial",colour = "black"),
                        legend.key.size = unit(0.1, 'in'),
                        legend.title = element_text(size = 5),
                        legend.text = element_text(size=4),
                        legend.position = "right"
                )
      )
      dev.off()
}



```


##Ext Fig  2C&D
```{r}
DE2 <- readRDS("~/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.converted.rds")
DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.converted.rds")
df = DE2$df
selected.cluster = "T_CD8"
for(i in c("ETC.Ref","ETC.Ref2","Ribosome") ){
  selected.genes = unlist( GeneSet$DE[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes )  %>% filter(Cluster %in% selected.cluster)
  df1 = pCat(df1, "p_val_adj")
  df1 = GeneGroup(df1, GeneSet$DE[[i]])
  a = max(abs(df1$avg_log2FC))+0.2 
  plot = ggplot(df1, aes(y = Dataset , x = Genes  ) ) + facet_grid(Cluster ~ Set, scales = "free", space="free", switch = "y") +
    theme_classic() + 
    geom_tile(color = "white",aes(fill =avg_log2FC)) +  
    scale_fill_gradientn(values =  c(0, 0.45 , 0.5 ,  5.5 , 1 ) ,
                          colours = Col.HiLow.9Shades,
                          limits = c(-a,a))+
    theme(plot.title = element_blank(),
          axis.title = element_blank(),
          axis.text.x = element_text(size =5, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =5, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', size = 0.25),
          axis.ticks = element_line(colour = 'black', size = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          strip.background = element_rect(fill = "white",size = 0.25),
          strip.placement = "outside",
          #strip.text.y = element_text(size =5, family = "Arial",colour = "black"),
          strip.text = element_text(size =5, family = "Arial",colour = "black",
                                      margin = margin(t = 0.1, r = 0, b = 0.1, l = 0, unit = "cm") ),
          legend.key.size = unit(0.1, 'in'),
          legend.title = element_text(size = 5),
          legend.text = element_text(size=4),
          legend.position = "bottom"
          )
  PDF(paste0("Ext.Fig.2CD.BOC.CD8.DE.perSpec.Heatmap.Celltype.v2.",i), h = 2.2, w = c(1.5 + (length(unique(df1$Genes))*0.06) ))
  print(plot)
  dev.off()
}

```



#Ext Figure 3 BOC CD4
##Ext Fig 3A PTGER4 expression (EP4 Group)
```{r}
CD4 = subset(BOC, Identity.Celltype == "T_CD4")
Idents(CD4) = CD4$PTGER4.Group.Celltype
tmp2 = c("#400E32","#A61F69","#F2921D","#F2CD5C")
for(i in 1){
  PDF("Ext.Fig.3A.BOC.CD4.Vln.PTGER4.PTGER4Group.Celltype",w=2,h=5)
  print(
    VlnPlot(CD4, "PTGER4",cols = tmp2, pt.size = 0) + 
      NoLegend() +
      #ylab("Normalize expression") +
      theme(axis.title = element_blank(),
            axis.text.x = element_text(angle = 90,color="black",vjust=0.3),
            plot.title = element_blank())
  )
  dev.off
}
```

##Ext Fig 3B Heatmap
```{r}
DE2 <- readRDS("~/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.converted.rds")
DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.converted.rds")
df = DE2$df

selected.cluster = c("T_CD4")
for(i in c("CD8.Overview2") ){
  selected.genes = unlist( GeneSet$DE[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes )  %>% filter(Cluster %in% selected.cluster)
  df1 = pCat(df1,"p_val_adj")
  df1 = GeneGroup(df1, GeneSet$DE[[i]] )
  Fsize = 6
  a = max(abs(df1$avg_log2FC))+0.2 
  plot = ggplot(df1, aes(y = Dataset , x = Genes  ) ) + 
    facet_grid(Cluster ~ Set, scales = "free", space="free", switch = "y") + 
    theme_classic() + 
    geom_tile(color = "white",aes(fill =avg_log2FC)) +  
    scale_fill_gradientn(colours = Col.HiLow.7Shades,
                         name = "Average log2 fold change\n(PTGER4hi/lo)",
                         values =  c( 0,0.1,0.45,0.48,0.5,0.52,0.55,0.9,  1 ),   
                         breaks = c(-1,-0.5,0,0.5,1),
                         limits = c(-a,a) ) +
    theme(plot.title = element_blank(),
          axis.text.x = element_text(size =Fsize, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =Fsize, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', linewidth = 0.25),
          axis.ticks = element_line(colour = 'black', linewidth = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          axis.title = element_blank(), 
          strip.text.y = element_blank(),
          strip.text.x.top = element_text(size =Fsize, family = "Arial",colour = "black",
                                          margin = margin(t = 0.02, r = 0, b = 0.02, l = 0, unit = "cm") ),
          strip.background = element_rect(fill = "white",linewidth = 0.35),
          strip.background.y =  element_blank(),
          strip.placement = "outside",
          legend.key.size = unit(0.1, 'in'),
                        legend.title = element_text(size = Fsize,family = "Arial", color = "black",angle=90),
                        legend.text = element_text(size=Fsize-1,family = "Arial", color = "black"),
          plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
          legend.position = "right"
          )
                
  PDF(paste0("Ext.Fig.3B.BOC.CD4.DE.perSpec.Heatmap.Celltype.",i), h = 2.1, w = 5.6 )
  print(plot)
  dev.off()
}

```


##Ext Fig 3C GSEA Running
```{r}
#DE = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype4.230713.Converted.rds")
#DE = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype.230713.Converted.rds")
DE <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Bulk.Celltype.Converted.GSEA_nperm50K.2300901.rds")
selected.pathway = c("HALLMARK_OXIDATIVE_PHOSPHORYLATION","HALLMARK_MYC_TARGETS_V1" )
GSEA = DE$GSEA
GSEA$T_CD4 %>% filter(pathway %in% selected.pathway)

for(i in c("T_CD4")){
  tmp1 = DE[[i]][["High-Low"]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC)
  tmp2 = GSEA[[i]] %>% as.data.frame()
  rownames(tmp2) = tmp2$pathway
  ranks = deframe(tmp1)
  for(p in selected.pathway){
    tmp3 = paste0("NES = ",tmp2[p,"NES"],"\n p-value = ", tmp2[p,"pval"],"\n adjusted p-value = ", tmp2[p,"padj"])
    PDF(paste0("Ext.Fig.3C.BOC.Bulk.Celltype.GSEAPlot.",i,".",p),w=4,h=2.5)
    print(plotEnrichment(fgsea_sets[[p]], ranks,gseaParam = 1,ticksSize = 0.3  ) + ggtitle(paste0(i," | ", p),tmp3)  )
    dev.off()
    tmp = plotEnrichment(fgsea_sets[[p]], ranks,gseaParam = 1,ticksSize = 0.3  ) + 
      theme_classic() + 
      theme(title = element_text(size=5), axis.title = element_blank(),axis.text = element_text(color = "black"))
    tmp$layers[[1]]$aes_params$colour = "#252D6B"
    a = tmp$layers[[3]]$data
    tmp$layers[[6]]$mapping$y = as.numeric(a-0.1)
    tmp$layers[[6]]$mapping$yend= as.numeric(a-0.2)
    tmp$layers[[6]]$aes_params$size=0.3
    tmp$layers[[6]]$aes_params$colour = "#41487E"
    tmp$layers[[5]] = geom_line(color ="#252D6B",size=1)
    tmp$layers[[2]]$aes_params$colour = "black"
    tmp$layers[[3]]$aes_params$colour = "black"
    PDF(paste0("Ext.Fig.3C.BOC.Bulk.Celltype.GSEAPlot.",i,".",p,".UL"),w=3,h=1.3)
    print(tmp )
    dev.off()
  }
}

```

##Ext Fig3D Heatmap Full ETC RP
```{r}
DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.converted.rds")
df = DE2$df

selected.cluster = c("T_CD4")
Excluded.genes = c("RPL3L","RPS4Y1")
for(i in c("ETC.Ribosome") ){
  selected.genes = unlist( GeneSet$DE[[i]] ) %>% unique() %>% setdiff(Excluded.genes)
  df1 = filter(df, Genes %in% selected.genes )  %>% filter(Cluster %in% selected.cluster)
  df1 = GeneGroup(df1, GeneSet$DE[[i]])
  Fsize = 5
  a = max(abs(df1$avg_log2FC))+0.2 
  plot = ggplot(df1, aes(y = Dataset , x = Genes  ) ) + 
    facet_grid(Cluster ~ Set, scales = "free", space="free", switch = "y") + 
    theme_classic() + 
    geom_tile(color = "white",aes(fill =avg_log2FC)) +  
    scale_fill_gradientn(colours = Col.HiLow.7Shades,
                         name = "Average log2 fold change\n(PTGER4hi/lo)",
                         values =  c( 0,0.1,0.45,0.48,0.5,0.52,0.55,0.9,  1 ),   
                         breaks = c(-1,-0.5,0,0.5,1),
                         limits = c(-a,a) ) +
    theme(plot.title = element_blank(),
          axis.text.x = element_text(size =Fsize, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =Fsize, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', linewidth = 0.25),
          axis.ticks = element_line(colour = 'black', linewidth = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          axis.title = element_blank(), 
          strip.text.y = element_blank(),
          strip.text.x.top = element_text(size =Fsize, family = "Arial",colour = "black",
                                          margin = margin(t = 0.02, r = 0, b = 0.02, l = 0, unit = "cm") ),
          strip.background = element_rect(fill = "white",linewidth = 0.35),
          strip.background.y =  element_blank(),
          strip.placement = "outside",
          legend.key.size = unit(0.1, 'in'),
                        legend.title = element_text(size = Fsize,family = "Arial", color = "black",angle=90),
                        legend.text = element_text(size=Fsize-1,family = "Arial", color = "black"),
          plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
          legend.position = "right"
          )
                
  PDF(paste0("Ext.Fig.3D.BOC.CD4.DE.perSpec.Heatmap.Celltype.",i), h = 1.5, w = 13 )
  print(plot)
  dev.off()
}
```




#Ext Figure 4 BOC TIM
##Ext Fig 4A1 FP (COX1/2)
```{r}
BOC = readRDS("BOC.PTGER4Group.230713.rds")
Idents(BOC) = BOC$Identity.Celltype2
TIM = subset(BOC, idents = c("TAN-PMN","TIM","TIM_Dividing"))
BOC = 0
TIM = Clustering1(TIM, spread = 1, dist = 1)

for(i in c("PTGS1","PTGS2")  ){
  PDF(paste0("Ext.Fig.4A1.BOC.TIM.FP.",i),h=1.6,w=1.6)
  print(
    FeaturePlot(TIM, i,pt.size = 0.01, cols = col_orange3) +
      theme(plot.title = element_blank(),
            axis.text = element_text(size =5, family = "Arial", color = "black"),
            axis.title = element_text(size = 5, family = "Arial", color = "black"),
            axis.line = element_line(colour = 'black', size = 0.25),
            axis.ticks = element_line(colour = 'black', size = 0.15),
            axis.ticks.length = unit(0.05,"cm")  ,
            plot.margin = margin(t = 0,  # Top margin
                             r = 0,  # Right margin
                             b = 0,  # Bottom margin
                             l = 0) ) +NoLegend()
        )
  dev.off()
}

for(i in c("PTGS2")  ){
  PDF(paste0("Ext.Fig.4A1.BOC.TIM.FP.L.",i),h=2,w=2)
  print(
    FeaturePlot(TIM, i,pt.size = 0.01, cols = col_orange3) +
      theme(plot.title = element_blank(),
            axis.title = element_text(size =15))
        )
  dev.off()
}


```

##Ext Fig 4A2 Vln (COX1/2)
```{r}
tmp1 = FetchData(TIM, vars = c("Identity.Subtype1",c("PTGS1","PTGS2"))) %>% as_tibble() %>% gather(key="Genes", value = "Exp", -Identity.Subtype1)
tmp1$Genes = factor(tmp1$Genes, levels = c("PTGS1","PTGS2") )
for(i in 1){
  PDF(paste0("Ext.Fig.3A2.BOC.TIM.PGE2.Vln."),w = 2.5,h=4.5 )
  print(
    ggplot(tmp1,aes(x = Identity.Subtype1, y = Exp, fill = Identity.Subtype1)) + 
      geom_violin(scale = "width") +
      scale_fill_manual( values = BOCDF$cols$TIM.Subtype1) + 
      facet_grid(Genes~. , switch = "y" , scales =  "free") +
      theme_classic()+
      theme(axis.text = element_text(color = "black"),
            axis.text.x = element_text(angle=90, hjust = 1, vjust = 0.3,size = 14),
            axis.title = element_blank(),
            strip.text.y.left = element_text(face="bold", size =13,color = "white"),
            strip.background = element_rect(fill = "black"),
            strip.placement = "outside") + 
      NoLegend()
  )
  dev.off()
}
```

##Ext Fig 4B&C
```{r}
DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.converted.rds")
df = DE2$df
selected.cluster = c("TIM")

for(i in c("ETC.Ref","ETC.Ref2","Ribosome") ){
  selected.genes = unlist( GeneSet$DE[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes )  %>% filter(Cluster %in% selected.cluster)
  df1 = pCat(df1, "p_val_adj")
  df1 = GeneGroup(df1, GeneSet$DE[[i]])
  a = max(abs(df1$avg_log2FC))+0.2 
  plot = ggplot(df1, aes(y = Dataset , x = Genes  ) ) + facet_grid(Cluster ~ Set, scales = "free", space="free", switch = "y") +
    theme_classic() + 
    geom_tile(color = "white",aes(fill =avg_log2FC)) +  
    scale_fill_gradientn(values =  c(0, 0.45 , 0.5 ,  5.5 , 1 ) ,
                          colours = Col.HiLow.9Shades,
                          limits = c(-a,a))+
    theme(plot.title = element_blank(),
          axis.title = element_blank(),
          axis.text.x = element_text(size =5, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =5, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', size = 0.25),
          axis.ticks = element_line(colour = 'black', size = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          strip.background = element_rect(fill = "white",size = 0.25),
          strip.placement = "outside",
          #strip.text.y = element_text(size =5, family = "Arial",colour = "black"),
          strip.text = element_text(size =5, family = "Arial",colour = "black",
                                      margin = margin(t = 0.1, r = 0, b = 0.1, l = 0, unit = "cm") ),
          legend.key.size = unit(0.1, 'in'),
          legend.title = element_text(size = 5),
          legend.text = element_text(size=4),
          legend.position = "bottom"
          )
  PDF(paste0("Ext.Fig.2BC.BOC.TIM.DE.perSpec.Heatmap.Celltype.",i), h = 2.2, w = c(1.5 + (length(unique(df1$Genes))*0.06) ))
  print(plot)
  dev.off()
}

```

#Ext Figure 5 LLC1
##Ext Fig 5A LLC: UMAP TNK
```{r}
LLC <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/LLC/LLC.ReShape.230730.rds")
Idents(LLC) = LLC$Identity.Celltype2
DimPlot(LLC)
TNK = subset(LLC, idents = c("NK", "Tcell"))
TNK = Clustering1(TNK,dist = 2,spread=1)
Idents(TNK) = TNK$Identity.Celltype3
for(i in 1){
  PDF("Ext.Fig.5A.LLC.TNK.DM", w=1.6,h=1.6)
  print(
    DimPlot(TNK,label = F,pt.size = 0.1,cols = c("#f57f26", "#d51f24","#252d6b","#fcb900","#1e8b40")) + 
      theme(plot.title = element_blank(),
            axis.text = element_text(size =5, family = "Arial", color = "black"),
            axis.title = element_text(size = 5, family = "Arial", color = "black"),
            axis.line = element_line(colour = 'black', size = 0.25),
            axis.ticks = element_line(colour = 'black', size = 0.15),
            axis.ticks.length = unit(0.05,"cm")  ,
            plot.margin = margin(t = 0,  # Top margin
                             r = 0,  # Right margin
                             b = 0,  # Bottom margin
                             l = 0) ) +NoLegend()
          )
  dev.off()
  PDF("Ext.Fig.5A.LLC.TNK.DM.L", w=2, h=2)
  print(DimPlot(TNK,label = T,pt.size = 1.2, cols = c("#f57f26", "#d51f24","#252d6b","#fcb900","#1e8b40")) )
  dev.off()
}

for(i in c("Cd3d","Cd4","Cd8a","Foxp3","Nkg7","Trdc")){
  PDF(paste0("Ext.Fig.5A.LLC.TNK.FP.",i), w=1.6,h=1.6)
  print(
    FeaturePlot(TNK,i,pt.size =0.1) + 
      scale_orange + 
      theme(plot.title = element_blank(),
            axis.text = element_text(size =5, family = "Arial", color = "black"),
            axis.title = element_text(size = 5, family = "Arial", color = "black"),
            axis.line = element_line(colour = 'black', size = 0.25),
            axis.ticks = element_line(colour = 'black', size = 0.15),
            axis.ticks.length = unit(0.05,"cm")  ,
            plot.margin = margin(t = 0,  # Top margin
                             r = 0,  # Right margin
                             b = 0,  # Bottom margin
                             l = 0) ) +NoLegend()
          )
  dev.off()
}

```


##Ext Fig 5B LLC: Heatmap (Day6/OXPHOS)
```{r}
df = LLCDF$df.DE.Celltype2 
for(t in  c("Day6")){
for(i in c("ETC.Ref2","Ribosome") ){
  selected.genes = unlist( geneSet[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes ) 
  df1 = GeneGroup(df1,geneSet[[i]])
  df1 = pCat(df1 , "p_val_adj" )
  df1 = filter(df1, Dataset == t)
  a = max(abs(df1$avg_log2FC))+0.2 
  plot = ggplot(df1, aes(y = fct_rev(Cluster), x = Genes  ) ) + 
    geom_point(aes(color = avg_log2FC, size = pval_cat))+
    facet_grid(Dataset ~ Set, scales = "free", space="free", switch = "y") + 
    theme_classic() + 
    scale_size_manual(values = c(0.8,1.2,1.6,2)) + 
    scale_color_gradientn(values = rescale(   c( -a,-0.1,0,0.1,  a ) ) ,
                         colours = Col.HiLow.9Shades,
                         limits = c(-a,a) ) +
    theme(plot.title = element_blank(),
          axis.title = element_blank(),
          axis.text.x = element_text(size =5, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =5, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', size = 0.25),
          axis.ticks = element_line(colour = 'black', size = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          strip.background = element_rect(fill = "white"),
          strip.placement = "outside",
          strip.text.x.top = element_text(size =5, family = "Arial",colour = "black"),
          strip.text = element_text(size =5, family = "Arial",colour = "black",
                                    margin = margin(t = 0.1, r = 0, b = 0.1, l = 0, unit = "cm") ),
          legend.key.size = unit(0.1, 'in'),
          legend.title = element_text(size = 5),
          legend.text = element_text(size=4),
          legend.position = "bottom" )
                
  PDF(paste0("Ext.Fig.5C.LLC.Heatmap.Celltype2.padj.",t,".",i), h = 2, w = c(1 + (length(unique(df1$Genes))*0.07) ))
  print(plot)
  dev.off()
}
}


for(t in  c("Day6")){
for(i in c("ETC.Ref2","Ribosome") ){
  df1 = filter(df, Dataset == t)
  df1 = GeneGroup(df1, geneSet[[i]] )
  df1 = pCat(df1, "p_val_adj" )
  a = max(abs(df1$avg_log2FC))+0.2 
  Fsize = 5
  plot = ggplot(df1, aes(y = fct_rev(Cluster), x = Genes  ) ) + 
            facet_grid(Dataset ~ Set, scales = "free", space="free", switch = "y") +
            theme_classic() + 
            geom_point(aes(color = avg_log2FC, size = pval_cat))+scale_size_manual(values = c(0.7,1,1.4,1.8) ) + 
            scale_color_gradientn(colours = Col.HiLow.9Shades, 
                                  values = c(0,0.4,0.5,0.6,1 ),
                                  limits = c(-a ,a ))+ 
            theme(plot.title = element_blank(),
                  axis.text.x = element_text(size =Fsize, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
                  axis.text.y = element_text(size =Fsize, family = "Arial", color = "black"),
                  axis.line = element_line(colour = 'black', size = 0.25),
                  axis.ticks = element_line(colour = 'black', size = 0.15),
                  axis.ticks.length = unit(0.05,"cm"),
                  axis.title = element_blank(), 
                  strip.text.y = element_blank(),
                  strip.text.x.top = element_text(size =Fsize, family = "Arial",colour = "black",
                                                  margin = margin(t = 0.1, r = 0, b = 0.1, l = 0, unit = "cm") ),
                  strip.background = element_rect(fill = "white",linewidth = 0.35),
                  strip.background.y =  element_blank(),
                  strip.placement = "outside",
                  legend.key.size = unit(0.1, 'in'),
                  legend.title = element_text(size = Fsize),
                  legend.text = element_text(size=Fsize-1),
                  plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
                  legend.position = "bottom"
          )
                
  PDF(paste0("Ext.Fig.5C.LLC.Heatmap.Celltype2.padj.V2.",t,".",i), h = 1.8, w = (0.35+ (length(unique(df1$Genes))*0.08) ) )
  print(plot)
  dev.off()
}
}

```

#Ext Figure 6 IFNG response
##Ext Fig 6A GSEA (NES = position, pvalue = size/color)
```{r}
#GSEA = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/LLC/GSEA.LLC.Celltype3.nperm50k.230823.rds")
GSEA <- readRDS( "~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/LLC/GSEA.LLC.Celltype3.Multilevel.230903.rds")
GSEA = GSEA$H
GSEA$Day1.5$T_CD8
selected.pathway = c("HALLMARK_INTERFERON_GAMMA_RESPONSE")
selected.cluster = names(GSEA$Day6) %>% setdiff("Doublet")

df = data.frame()
for(t in c("Day1.5")){
  for(c in selected.cluster ){
  #for(c in c("T_CD8","Mono","TAM")){
    tmp1 = GSEA[[t]][[c]] %>% as.data.frame() %>% filter(pathway %in% selected.pathway)
    tmp1$Cluster = c
    tmp1$Time = t
    df = rbind(df,tmp1)
  }
}
df$pathway = factor(df$pathway, levels = selected.pathway)
df$Cluster = factor(df$Cluster, levels = selected.cluster )
df1$pval_cat %>% summary()
df1$NES %>% range()

for(p in selected.pathway){
  df1 = filter(df, pathway == p)
  df1 = pCat(df1,"padj")
  a = max(abs(df1$NES))+0.2 
  Fsize = 6
  PDF(paste0("Ext.Fig.6A.LLC1.NES.Summary.V2.",p),w=2.2,h=1.3)
  print(
    ggplot(df1,aes(x = NES, y = fct_rev(Cluster) ) )+
      geom_point(aes(size = pval_cat, fill = NES),shape = 21)+
      geom_vline(xintercept = 0, linetype = "dashed" )+
      scale_fill_gradientn(colours = Col.HiLow.7Shades,
                           name = "NES",
                            values =  c( 0,0.1,0.4,0.5,0.56,0.9,  1 ),   
                            limits = c(-a,a) ) +
      scale_size_manual(values = c(1,2,3)  )+
      theme_classic()+
      xlim(-1,a)+
      theme(plot.title = element_blank(),
          axis.text.x = element_text(size =Fsize, family = "Arial", color = "black", hjust =1, vjust =0.3),
          axis.text.y = element_text(size =Fsize, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', linewidth = 0.25),
          axis.ticks = element_line(colour = 'black', linewidth = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          axis.title = element_blank(), 
          legend.key.size = unit(0.1, 'in'),
                        legend.title = element_text(size = Fsize,family = "Arial", color = "black"),
                        legend.text = element_text(size=Fsize-1,family = "Arial", color = "black"),
          plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
          legend.position = "right"
          )
  )
  dev.off()
}

GSEA$Day6$Mono
```

##Ext Fig 6B LLC1 Mono GSEA Running
```{r}
DE <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/LLC/DE.LLC.Celltype3.pval.nperm50k.230903.rds")
GSEA <- readRDS( "~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/LLC/GSEA.LLC.Celltype3.Multilevel.230903.rds")
GSEA = GSEA$H
selected.pathway = c("HALLMARK_INTERFERON_GAMMA_RESPONSE")
selected.cluster = c("Mono")

for(t in c("Day1.5","Day6")){
  for(c in selected.cluster ){
    print(c)
    tmp1 = DE[[t]][[c]] %>% as_tibble(rownames = "Genes" ) %>% dplyr::select(Genes, avg_log2FC) %>% arrange(avg_log2FC)
    ranks = deframe(tmp1)
    tmp2 = GSEA[[t]][[c]] %>% as.data.frame()
    rownames(tmp2) = tmp2$pathway
    for(p in selected.pathway){
      tmp3 = paste0("NES = ",tmp2[p,"NES"],"\n p-value = ", tmp2[p,"pval"],"\n adjusted p-value = ", tmp2[p,"padj"])
      PDF(paste0("Ext.Fig.6B.LLC1.Celltype3.GSEA.plot.",c,".",t,".",p,".L") ,  w=4,h=3)
      print(plotEnrichment(mfgsea_sets[[p]], ranks,gseaParam = 1,ticksSize = 0.3  ) + ggtitle(paste0(c," | ", p),tmp3)  )
      dev.off()
      tmp = plotEnrichment(mfgsea_sets[[p]], ranks,1,0.3  ) + theme_classic() + 
              theme(title = element_text(size=5), axis.title = element_blank(),axis.text = element_text(color = "black"))
      tmp$layers[[1]]$aes_params$colour = "#FCB900"
      a = tmp$layers[[3]]$data
      tmp$layers[[6]]$mapping$y = as.numeric(a-0.1)
      tmp$layers[[6]]$mapping$yend= as.numeric(a-0.2)
      tmp$layers[[6]]$aes_params$size=0.3
      tmp$layers[[6]]$aes_params$colour = "#FFC933"
      tmp$layers[[5]] = geom_line(color ="#FCB900",size=1)
      tmp$layers[[2]]$aes_params$colour = "black"
      tmp$layers[[3]]$aes_params$colour = "black"
      PDF(paste0("Ext.Fig.6B.LLC1.Celltype3.GSEA.plot.",c,".",t,".",p,".UL"),w=4,h=1.8)
      print(tmp )
      dev.off()
    }
  }
}

```

##Ext Fig 6C LLC1 TNK heatmap IFNG 
```{r}
df = LLCDF$df.DE.Celltype3
selected.cluster = c("NK","T_CD8","T_CD4","T_GammaDelta","Treg")
for(i in c("IFNG") ){
  selected.genes = unlist( geneSet[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes ) %>% filter(Cluster %in% selected.cluster)
  df1$Genes = factor(df1$Genes, levels = selected.genes  ) 
  Fsize = 6
  a = max(abs(df1$avg_log2FC))+0.2 
  plot = ggplot(df1, aes(y = fct_rev(Cluster), x = Genes  ) ) + 
    facet_grid( ~ Dataset , scales = "free", space="free", switch = "y") +
    theme_classic() + 
    geom_tile(color = "white", aes(fill =avg_log2FC)) +  
    scale_fill_gradientn(colours = Col.HiLow.7Shades,
                         name = "Average log2 fold change\n(EP2iEP4i/vehicle)",
                         values =  c( 0,0.2,0.4,0.5,0.6,0.8,  1 ), 
                         limits = c(-a,a) ) +
    theme(plot.title = element_blank(),
          axis.text.x = element_text(size =Fsize, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =Fsize, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', linewidth = 0.25),
          axis.ticks = element_line(colour = 'black', linewidth = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          axis.title = element_blank(), 
          strip.text.y = element_blank(),
          strip.text.x.top = element_text(size =Fsize, family = "Arial",colour = "black",
                                          margin = margin(t = 0.02, r = 0, b = 0.02, l = 0, unit = "cm") ),
          strip.background = element_rect(fill = "white",linewidth = 0.35),
          strip.background.y =  element_blank(),
          strip.placement = "outside",
          legend.key.size = unit(0.1, 'in'),
                        legend.title = element_text(size = Fsize,family = "Arial", color = "black",angle=90),
                        legend.text = element_text(size=Fsize-1,family = "Arial", color = "black"),
          plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
          legend.position = "right"
          )
  PDF(paste0("Ext.Fig.6C.LLC1.Celltype3.Heatmap.Celltype3.L.",i), h = 0.8, w =  1.8 )
  print(plot)
  dev.off()
}
```


##Ext Fig 6D Bona: Heatmap OXPHOS
```{r}
Bona <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA.Public/Bonavita/Bonavita.QC.230714.rds")
Idents(Bona) = Bona$Identity.Celltype3

df = data.frame()
selected.genes = sort(unique(unlist(geneSet) )) %>% intersect(rownames(Bona))
selected.cluster = setdiff(levels(Idents(Bona)), "NK")

for(i in  selected.cluster ){
  print(i)
  tmp = subset(Bona, idents=i)
  Idents(tmp) = tmp$orig.ident
  df1 = FindMarkers(tmp, ident.1 = "KOaNK", ident.2 = "KO", features = selected.genes,  logfc.threshold = 0.01, min.pct = 0.01) %>% as_tibble(rownames = "Genes")
  df1$Cluster = i
  df = rbind(df,df1)
  }
df$Cluster = factor(df$Cluster,levels =  selected.cluster )
BonaDF[["DE.selected.perCluster.Celltype3"]]=df


df = BonaDF[["DE.selected.perCluster.Celltype3"]]

tmp1 = df %>% filter( (Cluster  == "Mono-TAM") & (p_val >0 ) )  %>% filter(Genes %in% geneSet$Ribosome[["Large subunit"]]) %>% arrange(p_val)
tmp1 = tmp1$Genes[1:22]
tmp2 = df %>% filter( (Cluster  == "Mono-TAM") & (p_val >0 ) )  %>% filter(Genes %in% geneSet$Ribosome[["Small subunit"]]) %>% arrange(p_val)
tmp2 = tmp2$Genes[1:22]
geneSet$Ribosome.selected2 = list("Large subunit" = tmp1, "Small subunit" = tmp2)
geneSet$ETC.Ribosome2= c(geneSet$ETC.Ref2,geneSet$Ribosome.selected2)

selected.cluster = setdiff(unique(df$Cluster), "NK")

#for(i in c("ETC.Ref2","Ribosome.selected")){
for(i in c("ETC.Ribosome2")){
  df1 = GeneGroup(df, geneSet[[i]] ) 
  df1 = df1 %>% filter(Cluster %in% selected.cluster)
  Fsize = 5
  a = max(abs(df1$avg_log2FC))+0.2 
  PDF(paste0("Ext.Fig.6D.Bona.Heatmap.",i), h = 1, w = (0.6+ (length(unique(df1$Genes))*0.075) ) )
  print(
    ggplot(df1, aes(y = fct_rev(Cluster), x = Genes  ) ) + 
                  theme_classic() + 
                  Dot_axis90A + 
                    ggtitle(i)+
                  geom_tile(color = "white",aes(fill =avg_log2FC)) +  
                  scale_fill_gradientn(colours = Col.HiLow.7Shades,
                         values =  c( 0,0.45,0.5,0.55,  1 ),   
                         breaks = c(-1.5,-0.75,0,0.75,1.5),
                         limits = c(-1.5,1.5) ) +
                  facet_grid(.~Set, scale = "free", space = "free", switch = "y")+
                     theme(plot.title = element_blank(),
          axis.text.x = element_text(size =Fsize, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =Fsize, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', linewidth = 0.25),
          axis.ticks = element_line(colour = 'black', linewidth = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          axis.title = element_blank(), 
          strip.text.y = element_blank(),
          strip.text.x.top = element_text(size =Fsize, family = "Arial",colour = "black",
                                          margin = margin(t = 0.02, r = 0, b = 0.02, l = 0, unit = "cm") ),
          strip.background = element_rect(fill = "white",linewidth = 0.35),
          strip.background.y =  element_blank(),
          strip.placement = "outside",
          legend.key.size = unit(0.1, 'in'),
                        legend.title = element_text(size = Fsize,family = "Arial", color = "black"),
                        legend.text = element_text(size=Fsize-1,family = "Arial", color = "black"),
          plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
          legend.position = "right"
          )
  )
  
  dev.off()
}
```


##Ext Fig 6D BOC NK CD8 Heatmap IFNG
```{r}
DE2 <- readRDS("~/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.converted.rds")
DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.converted.rds")
df = DE2$df

selected.cluster = c("T_CD8","NK")
for(i in c("IFNG") ){
  selected.genes = unlist( GeneSet$DE[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes )  %>% filter(Cluster %in% selected.cluster)
  df1$Genes = factor(df1$Genes, levels = selected.genes  )
  Fsize = 6
  a = max(abs(df1$avg_log2FC))+0.2 
  plot = ggplot(df1, aes(x = Dataset , y = Genes  ) ) + 
    facet_grid(. ~ Cluster , scales = "free", space="free", switch = "y") +
    theme_classic() +        
    geom_tile(color = "white",aes(fill =avg_log2FC)) +  
    scale_fill_gradientn(colours = Col.HiLow.9Shades, 
                         values = c(0,0.45,0.5,0.55,1),
                         name = "Average log2 fold change",
                         breaks = c(-1.5,-0.75,0,0.75,1.5),
                         limits = c(-1.5,1.5) )+
    theme(plot.title = element_blank(),
          axis.text.x = element_text(size =Fsize, family = "Arial", color = "black",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =Fsize, family = "Arial", color = "black", face = "italic"),
          axis.line = element_line(colour = 'black', linewidth = 0.25),
          axis.ticks = element_line(colour = 'black', linewidth = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          axis.title = element_blank(), 
          strip.text.y = element_blank(),
          strip.text.x.top = element_text(size =Fsize, family = "Arial",colour = "black",
                                          margin = margin(t = 0.02, r = 0, b = 0.02, l = 0, unit = "cm") ),
          strip.background = element_rect(fill = "white",linewidth = 0.35),
          strip.background.y =  element_blank(),
          strip.placement = "outside",
          legend.key.size = unit(0.1, 'in'),
                        legend.title = element_text(size = Fsize,family = "Arial", color = "black"),
                        legend.text = element_text(size=Fsize-1,family = "Arial", color = "black"),
          plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
          legend.position = "bottom"
          )
                        
  PDF(paste0("Ext.Fig.6E.BOC.Celltype.",i), h =1.35, w = 3.6)
  print(plot)
  dev.off()
}
```



#Ext Figure 7 [Sanin, GSE119509]
###Ext Fig 7A GSEA [NES]
```{r}
Sanin <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/GSE119509.Sanin/Sanin.230828.rds")
df = Sanin$GSEA %>% filter(pathway %in% names(fgsea_sets_H) )
df = df[c(1:5,46:50),]
df$pathway = factor(df$pathway, levels = df$pathway)
df$Change = "Down"
df$Change[c(df$NES>0)] = "Up"
df$Change = factor(df$Change,levels = c("Up","Down"))
df$p_val_cat = df$padj
df$p_val_cat[df$padj> 0.05 ] = ">0.05"
df$p_val_cat[df$padj < 0.05 ] = "<0.05"
df$p_val_cat[df$padj < 0.01 ] = "<0.01"
df$p_val_cat[df$padj < 0.001 ] = "<0.001"
df$p_val_cat = factor(df$p_val_cat, levels = c(">0.05","<0.05","<0.01","<0.001"))
for(i in 1){
  PDF("Ext.Fig.6A.Sanin.GSEA.NES.N10",w=9,h=4)
  print(
    ggplot(df, aes(y = fct_rev(pathway), x= NES))+
      geom_bar(stat = "identity", aes(fill = p_val_cat)) + 
      scale_fill_manual(values = c("#CAD2C5","#84A98C","#52796F","#354F52","#2F3E46"))+
      theme_classic() +
      theme(axis.text = element_text(color = "black"),
            axis.text.y = element_text(size = 14,color="black"),
            axis.text.x = element_text(size = 14,color="black"),
            axis.title.y = element_blank()) 
  )
  dev.off()
}

```


###Ext Fig 7B Volcano
```{r}
Sanin <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/GSE119509.Sanin/Sanin.230828.rds")
df = Sanin$DE 
df$Genes = df$mgi_symbol
BOCDF[["Sanin_M2PGE2-M2"]] = df

for(q in c("ETC","Ribosome","ETC.selected3")){
  tmp = df 
  tmp$logP = (-1)*(log10(tmp$pvalue))
  tmp1 = tmp %>% filter(Genes %in% unlist(geneSet[[q]] ) )
  tmp1$Group = q
  tmp2 = tmp %>% filter(!Genes %in% unlist(geneSet[[q]] ) )
  tmp2$Group = "other"
  tmp = rbind(tmp1,tmp2)
  tmp$logP %>% range()
  tmp = tmp[!is.na(tmp$logP),]
  for(i in 1){  
    PDF(paste0("Ext.Fig.6B.Sanin.",q),w=5,h=5.3)
    print(
      ggplot(tmp, aes(x = log2FoldChange, y = logP)) + 
      geom_point(size = 0.4,color ="grey")+
      geom_point(size = 1, color = "#354f52",  data = subset(tmp, Group %in% q  ) )+
      geom_text_repel(aes(label = Genes),color ="black",size =3.5,
                      fontface ="italic", 
                      data = subset(tmp, Group == q) , 
                      #max.overlaps = Inf,box.padding = 1,
                      #max.overlaps = 50,box.padding = 0.4,
                      max.overlaps = 30,box.padding = 0.7,
                      max.time = 2) +
      theme_linedraw() +
      xlim(-3.5,3.5) + ylim(0,30) +
      ggtitle(paste0("Sanin: PGE2 M2 vs M2 | ",q))
    )
    dev.off()
    PDF(paste0("Ext.Fig.6B.Sanin.",q,".UL"),w=5,h=5)
    print(
      ggplot(tmp, aes(x = log2FoldChange, y = logP)) + 
      geom_point(size = 0.4,color ="grey")+
      geom_point(size = 1, color = "#354f52",  data = subset(tmp, Group %in% q  ) )+
      theme_linedraw() +
      xlim(-3,3) + ylim(0,20) +
      ggtitle(paste0("Sanin: PGE2 M2 vs M2 | ",q))
    )
    dev.off()
    }
}

```
##Ext Fig 7C GSEA [Running]
```{r}
GSEA = Sanin$GSEA
DE = Sanin$DE
DE$Genes = DE$mgi_symbol
selected.pathway = c("HALLMARK_OXIDATIVE_PHOSPHORYLATION","HALLMARK_MYC_TARGETS_V1")
for(i in c("BMDM")){
  tmp1 = DE %>% dplyr::select(Genes, log2FoldChange) %>% arrange(log2FoldChange) 
  tmp1 = tmp1[!is.na(tmp1$Genes),]
  tmp1 = tmp1[!is.na(tmp1$log2FoldChange ),]
  tmp2 = GSEA %>% as.data.frame()
  rownames(tmp2) = tmp2$pathway
  ranks = deframe(tmp1)
  for(p in selected.pathway){
    tmp3 = paste0("NES = ",tmp2[p,"NES"],"\n p-value = ", tmp2[p,"pval"],"\n adjusted p-value = ", tmp2[p,"padj"])
    PDF(paste0("Ext.Fig.6C.Sanin.GSEAPlot.",i,".",p),w=4,h=3)
    print(plotEnrichment(mfgsea_sets[[p]], ranks,gseaParam = 1,ticksSize = 0.3  ) + ggtitle(paste0(i," | ", p),tmp3)  )
    dev.off()
    tmp = plotEnrichment(mfgsea_sets[[p]], ranks,gseaParam = 1,ticksSize = 0.3  ) + 
      theme_classic() + 
      theme(title = element_text(size=5), axis.title = element_blank(),axis.text = element_text(color = "black"))
    tmp$layers[[1]]$aes_params$colour = "#354f52"
    a = tmp$layers[[3]]$data
    tmp$layers[[6]]$mapping$y = as.numeric(a-0.1)
    tmp$layers[[6]]$mapping$yend= as.numeric(a-0.2)
    tmp$layers[[6]]$aes_params$size=0.3
    tmp$layers[[6]]$aes_params$colour = "#84A98C"
    #tmp$layers[[5]] = NULL
    tmp$layers[[5]] = geom_line(color ="#354f52",size=1)
    #tmp$layers[[5]] = geom_smooth(se = F,color ="black")
    tmp$layers[[2]]$aes_params$colour = "black"
    tmp$layers[[3]]$aes_params$colour = "black"
    PDF(paste0("Ext.Fig.6C.Sanin.GSEAPlot.",i,".",p,".UL"),w=5,h=2)
    print(tmp )
    dev.off()
  }
}

```



#Ext Figure 8 In vitro CD8
##Ext Fig 8D Glycolysis DotPlot FC+p-value x Celltype
```{r}
#DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype4.230713.converted.rds")
DE2 <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.converted.rds")
#DE2 <- readRDS("~/RStudioProject/scRNA/BOC.DE_Specimen.Celltype.230713.converted.rds")
df = DE2$df
selected.cluster = c("T_CD8","T_CD4","T_CD4_FOXP3","TIM")
GeneSet$DE$Glycolysis4 = fgsea_sets$REACTOME_GLYCOLYSIS %>% setdiff(c("ALDOB","ALDOC","GAPDHS","GCK","GCKR","PFKFB1","PKLR"))
for(i in c("Glycolysis4") ){
  selected.genes = unlist( GeneSet$DE[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes )  %>% filter(Cluster %in% selected.cluster)
  df1$Genes = factor(df1$Genes, levels = selected.genes  )
  df1 = pCat(df1, "p_val")
  #df1 = pCat(df1, "p_val_adj")
  Fsize = 5
  a = max(abs(df1$avg_log2FC))+0.2 
  plot = ggplot(df1, aes(y = Dataset , x = Genes  ) ) + 
    facet_grid(Cluster ~ . , scales = "free", space="free", switch = "y") +
    theme_classic() + 
    geom_point(aes(color = avg_log2FC, size = pval_cat))+
    scale_size_manual(values = c(0.6,1.2,1.3,1.4)) + 
    scale_color_gradientn(colours = Col.HiLow.9Shades,
                          values =  c( 0,0.1, 0.43,0.47 , 0.5 , 0.53,0.57 ,0.9,  1 ) ,
                          limits = c(-a,a) 
                          ) +
    theme(plot.title = element_blank(),
          axis.title = element_blank(),
          axis.text.x = element_text(size =5, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =5, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', size = 0.25),
          axis.ticks = element_line(colour = 'black', size = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          strip.background = element_rect(fill = "white"),
          strip.placement = "outside",
          #strip.text.x.top = element_text(size =5, family = "Arial",colour = "black"),
          strip.text = element_text(size =6, family = "Arial",colour = "black",
                                    margin = margin(t = 0.1, r = 0.1, b = 0.1, l = 0.1, unit = "cm") ),
          legend.key.size = unit(0.1, 'in'),
          legend.title = element_text(size = 5),
          legend.text = element_text(size=4),
		      plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
          legend.position = "bottom")
  PDF(paste0("Ext.Fig.7D.BOC.DE.perSpec.Heatmap.Celltype.pval.",i), h = 4.5, w = 4.5  )
  print(plot)
  dev.off()
}

for(i in c("Glycolysis4") ){
  selected.genes = unlist( GeneSet$DE[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes )  %>% filter(Cluster %in% selected.cluster)
  df1$Genes = factor(df1$Genes, levels = selected.genes  )
  df1 = pCat(df1, "p_val")
  Fsize = 5
  a = max(abs(df1$avg_log2FC))+0.2 
  df1$psig = "ns"
  df1$psig[df1$p_val<0.05] = "*"
  df1$psig = factor(df1$psig, levels = c("ns","*"))
  plot = ggplot(df1, aes(y = Dataset , x = Genes  ) ) + 
    facet_grid(Cluster ~ . , scales = "free", space="free", switch = "y") +
    theme_classic() + 
    geom_point(aes(color = avg_log2FC,fill = avg_log2FC, size = pval_cat, shape = psig) )+
    scale_size_manual(values = c(0.6,1.2,1.3,1.4)) + 
    scale_shape_manual( values=c(1,21))+
    scale_color_gradientn(colours = Col.HiLow.9Shades,
                          values =  c( 0,0.1, 0.43,0.47 , 0.5 , 0.53,0.57 ,0.9,  1 ) ,
                          limits = c(-a,a) 
                          ) +
    scale_fill_gradientn(colours = Col.HiLow.9Shades,
                          values =  c( 0,0.1, 0.43,0.47 , 0.5 , 0.53,0.57 ,0.9,  1 ) ,
                          limits = c(-a,a) 
                          )  +
    theme(plot.title = element_blank(),
          axis.title = element_blank(),
          axis.text.x = element_text(size =5, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =5, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', size = 0.25),
          axis.ticks = element_line(colour = 'black', size = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          strip.background = element_rect(fill = "white"),
          strip.placement = "outside",
          #strip.text.x.top = element_text(size =5, family = "Arial",colour = "black"),
          strip.text = element_text(size =6, family = "Arial",colour = "black",
                                    margin = margin(t = 0.1, r = 0.1, b = 0.1, l = 0.1, unit = "cm") ),
          legend.key.size = unit(0.1, 'in'),
          legend.title = element_text(size = 5),
          legend.text = element_text(size=4),
		      plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
          legend.position = "bottom")
  PDF(paste0("Ext.Fig.7D.BOC.DE.perSpec.Heatmap.Celltype.pval.v2.",i), h = 4.5, w = 4.5  )
  print(plot)
  dev.off()
}

```
#Ext Figure 9 CD4 T cell (Beyer)
##Ext Fig 8A GSEA (NES)
```{r}
DE =readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/DE.CD4.Schultze-Meyer.230829.rds")
df = DE$Beyer2.GSEA %>% filter(pathway %in% names(fgsea_sets_H))
df = df[c(1:6,41:50),]
df$pathway = factor(df$pathway, levels = df$pathway)
df$Change = "Down"
df$Change[c(df$NES>0)] = "Up"
df$Change = factor(df$Change,levels = c("Up","Down"))
df$p_val_cat = df$padj
df$p_val_cat[df$padj> 0.05 ] = ">0.05"
df$p_val_cat[df$padj < 0.05 ] = "<0.05"
df$p_val_cat[df$padj < 0.01 ] = "<0.01"
df$p_val_cat[df$padj < 0.001 ] = "<0.001"
df$p_val_cat = factor(df$p_val_cat, levels = c(">0.05","<0.05","<0.01","<0.001"))
for(i in 1){
  PDF("Ext.Fig.8A.Beyer.GSEA.NES",w=10,h=5)
  print(
    ggplot(df, aes(y = fct_rev(pathway), x= NES))+
      geom_bar(stat = "identity", aes(fill = p_val_cat)) + 
      scale_fill_manual(values = c("#CCDBDC","#9AD1D4","#80CED7","#007EA7","#00547A"))+
      theme_classic() +
      theme(axis.text = element_text(color = "black"),
            axis.text.y = element_text(size = 14,color="black"),
            axis.text.x = element_text(size = 14,color="black"),
            axis.title.y = element_blank()) 
  )
  dev.off()
}
```


##Ext Fig 8B GSEA (Running)
```{r}
selected.pathway = c("HALLMARK_OXIDATIVE_PHOSPHORYLATION","HALLMARK_MYC_TARGETS_V1","HALLMARK_IL2_STAT5_SIGNALING","MOOTHA_PGC")
df = DE$Beyer2
GSEA = DE$Beyer2.GSEA
GSEA %>% filter(pathway %in% selected.pathway)
for(i in c("CD4")){
  tmp1 = df %>% dplyr::select(Genes, logFC) %>% arrange(logFC) 
  tmp1 = tmp1[!is.na(tmp1$Genes),]
  tmp1 = tmp1[!is.na(tmp1$logFC ),]
  tmp2 = GSEA %>% as.data.frame()
  rownames(tmp2) = tmp2$pathway
  ranks = deframe(tmp1)
  for(p in selected.pathway){
    tmp3 = paste0("NES = ",tmp2[p,"NES"],"\n p-value = ", tmp2[p,"pval"],"\n adjusted p-value = ", tmp2[p,"padj"])
    
    PDF(paste0("Ext.Fig.8B.Beyer_CD4.GSEAPlot.",i,".",p),w=4,h=2.5)
    print(plotEnrichment(fgsea_sets[[p]], ranks,gseaParam = 1,ticksSize = 0.3  ) + ggtitle(paste0(i," | ", p),tmp3)  )
    dev.off()
    
    tmp = plotEnrichment(fgsea_sets[[p]], ranks,gseaParam = 1,ticksSize = 0.3  ) + 
      #ggtitle(paste0(i," | ", p),tmp3) + 
      theme_classic() + 
      theme(title = element_text(size=5), axis.title = element_blank(),axis.text = element_text(color = "black"))
    #tmp$layers[[1]]$aes_params$shape = 21
    tmp$layers[[1]]$aes_params$colour = "#80CED7"
    #tmp$layers[[1]]$aes_params$fill = "firebrick"
    #tmp$layers[[1]]$aes_params$size= 1.5
    a = tmp$layers[[3]]$data
    tmp$layers[[6]]$mapping$y = as.numeric(a-0.1)
    tmp$layers[[6]]$mapping$yend= as.numeric(a-0.2)
    tmp$layers[[6]]$aes_params$size=0.3
    tmp$layers[[6]]$aes_params$colour = "#007EA7"
    #tmp$layers[[5]] = NULL
    tmp$layers[[5]] = geom_line(color ="#80CED7",size=1)
    #tmp$layers[[5]] = geom_smooth(se = F,color ="black")
    tmp$layers[[2]]$aes_params$colour = "black"
    tmp$layers[[3]]$aes_params$colour = "black"
    PDF(paste0("Ext.Fig.8B.Beyer_CD4.GSEAPlot.",i,".",p,".UL"),w=4,h=2)
    print(tmp )
    dev.off()
  }
}
```

##Ext Fig 8C Heatmap
```{r}
Beyer =readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/Beyer.230829.rds")
DE <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/PublicBulkRNA/Schultze.CD4/DE.CD4.Schultze-Meyer.230829.rds")
df = Beyer$Beyer2.df

GeneSet$DE$tmp = c(GeneSet$DE$CD4.Beyer,GeneSet$DE$ETC.Ref2 ,GeneSet$DE$Ribosome )
tmp1 = filter(DE$Beyer2, Genes %in% GeneSet$DE$ETC.Ref2[["Complex I"]] ) %>% arrange(P.Value)

GeneSet$DE$ETC.Beyer = list("Complex I" = tmp1$Genes[1:15],
                            "Complex II" = intersect(GeneSet$DE$ETC[["Complex II"]]  ,fgsea_sets$WP_MITOCHONDRIAL_COMPLEX_II_ASSEMBLY),  
                            "Complex III" = intersect(GeneSet$DE$ETC[["Complex III"]] , fgsea_sets$WP_MITOCHONDRIAL_COMPLEX_III_ASSEMBLY),
                            "Complex IV" = intersect(GeneSet$DE$ETC[["Complex IV"]] , fgsea_sets$WP_MITOCHONDRIAL_COMPLEX_IV_ASSEMBLY),
                            "Complex V" = intersect(GeneSet$DE$ETC[["Complex V"]]  ,fgsea_sets_c5$GOCC_PROTON_TRANSPORTING_ATP_SYNTHASE_COMPLEX)
                            )

tmp1 = filter(DE$Beyer2, Genes %in% GeneSet$DE$Ribosome[["Large subunit"]] ) %>% arrange(P.Value)
tmp2 = filter(DE$Beyer2, Genes %in% GeneSet$DE$Ribosome[["Small subunit"]] ) %>% arrange(P.Value)
GeneSet$DE$Ribosome.Beyer = list("Large subunit" = tmp1$Genes[1:20], 
                                 "Small subunit" = tmp2$Genes[1:20])
GeneSet$DE$tmp = c(GeneSet$DE$CD4.Beyer, 
                   GeneSet$DE$ETC.Beyer,
                   GeneSet$DE$Ribosome.Beyer
                   )
for(i in c("tmp") ){
  df1 = GeneGroup(df,GeneSet$DE[[i]] )
  df1 = arrange(df1,Genes)
  df1$Genes_ProbeID = factor(df1$Genes_ProbeID, levels = unique(df1$Genes_ProbeID))
  Fsize = 6
  a = max(abs(df1$Expression))+0.2 
  PDF(paste0("Ext.Fig.8CDE.Beyer_CD4.Heatmap.",i), h = 1.6, w = 9 )
  print(
    ggplot(df1, aes(y = Sample, x = Genes ) ) + 
      facet_grid(. ~ Set , scales = "free", space="free", switch = "y")+
      geom_tile(color = "white",aes(fill =Expression) ) +  
      scale_fill_gradientn(colours = Col.HiLow.9Shades   )+
      theme_classic() +  
      theme(plot.title = element_blank(),
          axis.text.x = element_text(size =Fsize, family = "Arial", color = "black", face = "italic",angle = 90, hjust =1, vjust =0.3),
          axis.text.y = element_text(size =Fsize, family = "Arial", color = "black"),
          axis.line = element_line(colour = 'black', linewidth = 0.25),
          axis.ticks = element_line(colour = 'black', linewidth = 0.15),
          axis.ticks.length = unit(0.05,"cm"),
          axis.title = element_blank(), 
          strip.text.y = element_blank(),
          strip.text.x.top = element_text(size =Fsize, family = "Arial",colour = "black",
                                          margin = margin(t = 0.02, r = 0, b = 0.02, l = 0, unit = "cm") ),
          strip.background = element_rect(fill = "white",linewidth = 0.35),
          strip.background.y =  element_blank(),
          strip.placement = "outside",
          legend.key.size = unit(0.1, 'in'),
                        legend.title = element_text(size = Fsize,family = "Arial", color = "black"),
                        legend.text = element_text(size=Fsize-1,family = "Arial", color = "black"),
          plot.margin = margin(t = 0, r = 0, b = 0, l = 0  ),
          legend.position = "bottom"
          )
  )
  dev.off()
}
```

#============

#Supplement Data (LLC/Bonavita/Myeloid)
##Fig 5A GSEA NES+pvalue 
```{r}
GSEA = readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/LLC/GSEA.LLC.Celltype3.nperm50k.230823.rds")
selected.pathway = c("HALLMARK_INTERFERON_GAMMA_RESPONSE")
selected.cluster = names(GSEA$Day1.5) %>% setdiff("Doublet")
df = data.frame()
for(t in c("Day1.5")){
  for(c in selected.cluster ){
    tmp1 = GSEA[[t]][[c]] %>% as.data.frame() %>% filter(pathway %in% selected.pathway)
    tmp1$Cluster = c
    tmp1$Time = t
    df = rbind(df,tmp1)
  }
}
df$pathway = factor(df$pathway, levels = selected.pathway)
df$Cluster = factor(df$Cluster, levels = selected.cluster )
df$pval_cat = ">0.05"
df$pval_cat[(df$padj < 0.05)] = "0.05-0.01"
df$pval_cat[(df$padj < 0.01)] = "0.01-0.001"
df$pval_cat[(df$padj < 0.001)] = "<0.001"
df$pval_cat = factor(df$pval_cat, levels = c(">0.05","0.05-0.01","0.01-0.001","<0.001"))
tmp = max(abs(df$NES)) %>% ceiling()
range(df$NES)
for(p in selected.pathway){
  df1 = filter(df, pathway == p)
  PDF(paste0("Fig.5A.LLC1.Day1.5.NES_pvalue.",p),w=4.5,h=3)
  print(
    ggplot(df1,aes(x = NES, y = fct_rev(Cluster) ) )+
      geom_point(aes(size = pval_cat, fill = NES),shape = 21)+
      geom_vline(xintercept = 0, linetype = "dashed" )+
      scale_fill_gradientn(colours =c("#ffffff","#fce487","#f9c80e","#f86624","#ea3546") )+
      #scale_fill_manual(values = c("#01295f","orange","#f86624","firebrick") )+
      #ggtitle(p)+
      theme_classic()+
      xlim(-tmp,tmp)+
      #facet_grid(Time ~., scale = "free", space = "free",switch = "y") +
      theme(plot.title = element_text(size = 10),
            axis.text =element_text(color="black"),
            strip.placement = "outside",
            axis.title.y.left = element_blank())
  )
  dev.off()
}
```

##Fig 5B Heatmap IFNG
```{r}
df = LLCDF$df.DE.Celltype3 
for(i in c("IFNG") ){
  selected.genes = unlist( geneSet[[i]] ) %>% unique()
  df1 = filter(df, Genes %in% selected.genes ) %>% filter(Cluster %in% selected.cluster)
  df1$Genes = factor(df1$Genes, levels = selected.genes  ) 
  if( class(geneSet[[i]]) == "list"){
    tmp = data.frame(matrix(ncol = (ncol(df1)+1), nrow = 0))
    colnames(tmp) = c(colnames(df1),"Set")
    for(j in names(geneSet[[i]])){
      tmp1 = filter(df1, Genes %in% geneSet[[i]][[j]] ) %>% filter(!Genes %in% tmp[,1])
      tmp1$Set = j
      tmp = rbind(tmp,tmp1)
    }
    tmp$Set = factor(tmp$Set, levels = names(geneSet[[i]]))
    df1 = tmp
    plot = ggplot(df1, aes(y = fct_rev(Cluster), x = Genes  ) ) + facet_grid(Dataset ~ Set, scales = "free", space="free", switch = "y") 
                  
  } else {
    plot = ggplot(df1, aes(y = fct_rev(Cluster), x = Genes  ) ) + facet_grid(Dataset ~ . , scales = "free", space="free", switch = "y") 
  }
  plot = plot + theme_classic() + Dot_axis90A + ggtitle(i)+
                  geom_tile(color = "white",aes(fill =avg_log2FC)) +  
                  scale_fill_gradientn(colours = Col.HiLow.9Shades,values = scales::rescale(c(min(df1$avg_log2FC),-0.1,0,0.1,max(df1$avg_log2FC)) ) )+
                  #scale_fill_gradientn(colours = Col.HiLow.Up, values = scales::rescale( c(0,0.1,max(df1$avg_log2FC)) ) ) +
                  theme(plot.title = element_blank(),
                        axis.title = element_blank(), 
                        axis.text.x = element_text(size =16, face = "italic",color = "black"),
                        axis.text.y = element_text(size =16, color = "black"),
                        #strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.text.x.top = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "right"
                        )
                
  PDF(paste0("Fig.5B.LLC.Heatmap.TNK.",i), h = 4, w = c(3.5 + (length(unique(df1$Genes))*0.23) ))
  print(plot)
  dev.off()
}

```

##Fig 5C Bona: UMAP
```{r}
Bona <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA.Public/Bonavita/Bonavita.QC.230714.rds")
Bona <- readRDS("~/RStudioProject/scRNA.Public/Bonavita/Bonavita.QC.230714.rds")
BonaDF = list()
Bona = Clustering1(Bona, spread =1,dist =2,  group = "orig.ident")
Bona = RunUMAP(Bona, reduction = "harmony", dims = 1:30, min.dist = 2, spread = 1 )
Idents(Bona) = Bona$Identity.Celltype2
Bona = RenameIdents(Bona, "B_lymphocyte"="Bcell","Mono" = "Mono-TAM","TAM"="Mono-TAM")
Bona$Identity.Celltype3 = factor(Idents(Bona) ,levels = c("NK","Tcell","TAN","Mono-TAM","cDC1","cDC2","mregDC","pDC","Bcell","Dividing"))
Idents(Bona) = Bona$Identity.Celltype3
DimPlot(Bona)
for(i in 1){
  PDF("Fig.5C.Bona.Celltype3.UMAP",w=5,h=5)
  print(DimPlot(Bona,label = F,cols = c("#f57f26","cyan4",
                                 "#252d6b",
                                 "#d51f24", #"#fcb900",
                                 "#2D3D98","#1e8b40","#a83a2b","#7D387D","purple3",
                                 "#7A5532","grey") ) +NoLegend() )
  dev.off()
  PDF("Fig.5C.Bona.Celltype3.UMAP.L",w=7,h=5)
  print(DimPlot(Bona,label =T,cols = c("#f57f26","cyan4",
                                 "#252d6b",
                                 "#d51f24", #"#fcb900",
                                 "#2D3D98","#1e8b40","#a83a2b","#7D387D","purple3",
                                 "#7A5532","grey") )  )
  dev.off()
}
```

##Fig 5D Bona: Volcano
```{r}
Idents(Bona) = Bona$orig.ident
BonaDF[["DE.KOaNK_KO"]] = FindMarkers(Bona, ident.1 = "KOaNK", ident.2 = "KO",  logfc.threshold = 0.01, min.pct = 0.01) %>% as_tibble(rownames = "Genes") 
#saveRDS(BonaDF, "~/RStudioProject/scRNA.Public/Bonavita/BoDF.230825.rds")
df = BonaDF[["DE.KOaNK_KO"]]
selected.genes = c("Ifng")
p = "Ifng"
for(i in 1){
    tmp =df
    tmp$logP = (-1)*(log10(tmp$p_val_adj))
    tmp1 = tmp %>% filter(Genes %in% selected.genes )
    tmp1$Group = p
    tmp2 = tmp %>% filter(!Genes %in% selected.genes )
    tmp2$Group = "other"
    tmp = rbind(tmp1,tmp2)
    tmp$logP %>% range()
    tmp = tmp[!is.na(tmp$logP),]
    tmp = filter(tmp, !logP == "Inf")
    tmp = filter(tmp, !avg_log2FC == "Inf")
    a = ceiling(max(tmp$logP) ) 
    b = ceiling( max(abs(range(tmp$avg_log2FC))) )
    PNG("Fig.5D.Bona.Volcano.Ifng",w=3,h=4,r=400)
    print(
      ggplot(tmp, aes(x = avg_log2FC, y = logP)) + 
      geom_point(size = 0.4,color ="grey")+
      geom_point(size = 1, color = "red",  data = subset(tmp, Group %in% p  ) )+
      geom_text_repel(aes(label = Genes),color ="black",size =5,
                      fontface ="italic", 
                      data = subset(tmp, Group == p) , 
                      #max.overlaps = Inf,box.padding = 1,
                      max.overlaps = 50,box.padding = 1,
                      max.time = 2) +
      #theme_linedraw() +
        theme_classic()+
      #xlim(-b,b) + ylim(0,a+10) 
      xlim(-0.8,0.8) + ylim(0,50) +
        ylab("-log(adj.p-value)")+
        xlab("Log2(Fold change)")
    )
    dev.off()
}


```


##Ext Fig Bona: UMAP/ Dot plot signature
```{r}
Idents(Bona) = Bona$Identity.Celltype3
BonaDF[["AllMarker.Celltype3"]] = FindAllMarkers(Bona, max.cells.per.ident = 200)
#saveRDS(BonaDF, "~/RStudioProject/scRNA.Public/Bonavita/BoDF.230825.rds")
BonaDF[["AllMarker.Celltype3"]] %>% group_by(cluster) %>% top_n(n=20, wt=avg_log2FC)
selected.genes = c("Klrb1c","Eomes","Il2rb","Gzma","Prf1","Cd3d","Trac","Trbc2","Cd28","S1pr1","S100a8","S100a9","Ptgs2","Il1r2","Cxcr2","Apoe","Fn1","C1qa","Arg1","Lyz2","Flt3","Xcr1","Clec9a","Cd24","Irf8","Cd209a","Clec10a","H2-Aa","H2-DMb1","Ccr7","Ccl2","Il4i1","Ccl5","Siglech","Cd7","Ccr9","Cd209d","Runx2","Cd79a","Igkc","Ms4a1","Ighd","Ighm","Stmn1","Mki67","Top2a","Tubb5","Hmgb2")

Idents(Bona) = RevIden(Idents(Bona))
for(i in 1){
  PNG(paste0("Ext.Fig.5A.Bona.Signature"), h = 3.7, w = c(2 + (length(unique(df1$Genes))*0.15) ), r=400 )
  print(
    DotPlot(Bona,features = selected.genes)+Dot_axis90A + scale_viridis+theme(axis.title = element_blank())
  )
  dev.off()
}

```

#===Data to GEO========
```{r}
BOC <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents_Onedrive/RStudioProject/scRNA/BOC.PTGER4Group.230713.rds")
tmp = BOC[[]] %>% as_tibble(rownames = "CellBarcode") %>% dplyr::select(CellBarcode, CB.original,Cancer,Histo,Batch.original,Batch.scRNA, Identity.Celltype, Identity.Celltype4, Identity.Subtype1,PTGER4.Group.Celltype)
write.csv(tmp, "Metadata.scRNA.csv")
```

#============


##Heatmap of scale expression
```{r}
LC <- readRDS("~/RStudioProject/scRNA/LC.rmLQ.230405.rds")
LC = subset(LC, Identity.Celltype %in% c("T_CD8","T_CD4","Treg","TIM_C1qa","TIM_Vcan"))
selected.genes = c(find(LC,"^Nduf"),find(LC,"^Sdh"),find(LC,"^Cox"),find(LC,"^Uqc"),find(LC,"^Atp5"),"Hif1a","Myc",find(LC,"Ets"),find(LC,"Etv"), find(LC,"Ifi"),find(LC,"Isg"),find(LC,"Ifn"),"Cd3d","Cd3e","Cd3g","Cd27","Cd28",find(LC,"Il2r"),find(LC,"Ppar"),find(LC,"^Rps"),find(LC,"^Rpl"), find(LC,"^Psm"),"Sod1","Sod2")

selected.genes
df = data.frame()
for(i in unique(LC$orig.ident)){
  print(i)
  tmp1 = subset(LC, orig.ident == i)
  tmp1 = subset(tmp1, Condition %in% c("Control","EP2i","EP4i","EP2iEP4i") )
  for(j in unique(tmp1$Batch)){
    tmp2 = subset(tmp1, Batch == j)
    for(k in unique(tmp2$Identity.Celltype)){
      tmp3 = subset(tmp2, Identity.Celltype == k )
      Idents(tmp3) = "ID"
      df1 = DotPlot(tmp3, features = selected.genes)$data
      df1$Dataset = i
      df1$Batch = j
      df1$Cluster = k
      df = rbind(df,df1)
    }
  }
}
tmp1 = 0
tmp2 = 0 
tmp3 = 0
saveRDS(df, "LC.ScaleHeatmap.df.230422.rds")
df= readRDS( "LC.ScaleHeatmap.df.230422.rds")



tmp = list(
  "ETC" = geneSet$ETC2,
  "Regulator" = c("Hif1a","Myc",find(LC,"Ets"),find(LC,"Etv") ), 
  "ISG" = c(find(LC,"Ifi"),find(LC,"Isg"),find(LC,"Ifn") ),
  "Ribosome" = c(find(LC,"Rps"),find(LC,"Rpl")),
  "Proteosome" = c(find(LC,"Psm")),
  "TCR" = c("Cd3d","Cd3e","Cd3g","Cd27","Cd28",find(LC,"Il2r") ),
  "Ppar" = find(LC,"Ppar")
)
tmp = list(
  "ETC" = geneSet$ETC2,
  "Regulator" = c("Sod2","Hif1a","Myc",find(LC,"Ets"),find(LC,"Etv") ), 
  "Ppar" = find(LC,"Ppar")
)

df2 = data.frame()
for(i in names(tmp)){
  df1 = filter(df, features.plot %in% tmp[[i]] )
  df1$GeneSet = i
  df2 = rbind(df2,df1)
}
df1 = df2[!is.na(df2$avg.exp.scaled),]
plot = ggplot(df1, aes(y = id, x = features.plot  ) ) + facet_grid(Dataset+Batch+Cluster ~ GeneSet , scales = "free", space="free", switch = "y") + 
  theme_bw() + Dot_axis90A + 
  #geom_tile(color = "white",aes(fill =avg.exp.scaled)) +  scale_fill_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(df1$avg.exp.scaled),-0.1,0,0.1,max(df1$avg.exp.scaled)) ))+
  geom_point(aes(color = avg.exp.scaled, size = pct.exp)) + scale_color_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(df1$avg.exp.scaled),-0.1,0,0.1,max(df1$avg.exp.scaled)) ) ) +  scale_size(range = c(1.5,8)) + 
                  theme(plot.title = element_text(size =20, face = "bold",color = "black"),
                        axis.title = element_blank(), 
                        axis.text.x = element_text(size =16, face = "bold"),
                        axis.text.y = element_text(size =16, face = "bold", color = "black"),
                        strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.text.x.top = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "bottom"
                        )
for(i in 1){
  PNG("LC.ScaleDP.ETCReg2",w=20,h=45,r=200)
  print(plot)
  dev.off()
}
df1 %>% filter()
plot2 = ggplot(df1, aes(y = id, x = features.plot  ) ) + facet_grid(Dataset+Batch+Cluster ~ GeneSet , scales = "free", space="free", switch = "y") + 
  theme_bw() + Dot_axis90A + 
  #geom_tile(color = "white",aes(fill =avg.exp.scaled)) +  scale_fill_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(df1$avg.exp.scaled),-0.1,0,0.1,max(df1$avg.exp.scaled)) ))+
  geom_point(aes(color = avg.exp.scaled, size = pct.exp)) + scale_color_gradientn(colours = Col.HiLow.9Shades, values = scales::rescale(c(min(df1$avg.exp.scaled),-0.1,0,0.1,max(df1$avg.exp.scaled)) ) ) +  scale_size(range = c(1.5,8)) + 
                  theme(plot.title = element_text(size =20, face = "bold",color = "black"),
                        axis.title = element_blank(), 
                        axis.text.x = element_text(size =16, face = "bold"),
                        axis.text.y = element_text(size =16, face = "bold", color = "black"),
                        strip.text.y.left = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.text.x.top = element_text(size =18, face = "bold", color = "black",angle = 0),
                        strip.background = element_rect(fill = "white"),
                        strip.placement = "outside",
                        legend.position = "bottom"
                        )
```

#Save
```{r}
saveRDS(BOCDF,"BOCDF.230902.rds")
saveRDS(LLCDF,"LLCDF.230902.rds")
```



